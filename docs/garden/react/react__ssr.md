---
title: React SSR
toc: content
group:
  title: 深入探讨
---

## 什么是 SSR

`SSR`，即 `Server Side Rendering`，是指在服务器端完成页面渲染，并将完整的 `HTML` 返回给浏览器。

这种方式由来已久，浏览器接收完整的 `HTML` 后，可以直接进行 `DOM` 的解析、构建和渲染。

**优点：**

页面直出的方式使得首屏加载速度快，对搜索引擎友好，有利于SEO，爬虫能轻松抓取页面内容。

**缺点：**

1. 每次加载页面都需要向服务器请求完整内容和资源，访问量大时会加重服务器负担
2. 页面频繁刷新跳转的用户体验也不理想。

## 什么是 CSR

`CSR`，即 `Client Side Rendering`，是客户端渲染技术。

这种技术在现代 `Web` 应用中非常流行，服务器返回初始 `HTML` 内容后，由 `JS` 异步加载数据，完成页面渲染。

`SPA`（单页应用）是这种模式的典型代表。

在 `SPA` 模式下，服务器只返回页面框架和 `JS` 脚本资源，不返回具体数据。

**优点：**

单页应用中，首次进入或刷新时才会请求服务器，只需加载一次 `JS` 和 `CSS` 资源。页面路由维护在客户端，页面间跳转速度快，不会刷新整个页面，而是局部刷新，用户体验大幅提升。此外，数据渲染在客户端完成，服务器只需提供数据接口，大大减轻服务器压力。

**缺点：**

`SPA` 的客户端渲染方式虽然体验提升，但对 `SEO` 不友好，页面首次加载可能会有较长的白屏时间。

## React SSR

传统的 SSR 和主流的 CSR 方案（SPA）都不够完美，因此需要一种综合两者优点的技术 - React SSR（SPA+SSR）。

通过服务端直出首屏内容，让用户更快看到页面，然后通过 `JS` 异步请求和加载后续数据。虽然不用 React 也能实现，但使用 React 更高效，代码量更少，因为可以构造同构应用。

## 同构

同构指的是前后端公用一套代码，例如组件可以在服务端渲染，也可以在客户端渲染，且都是同一个组件。

打造同构应用的另一个优势在于，前后端使用同一种语言 - JavaScript。

另一个重要特性是浏览器接管页面后的进一步渲染过程中，会判断已有的 DOM 结构和浏览器渲染出的结构是否相同，若相同，则不重复渲染，只需绑定事件即可。

## 双端对比机制

`ReactDOMServer` 类可以在服务端渲染组件，得到组件的 HTML 字符串，然后将该字符串返回给浏览器端，完成页面内容的初始化，同时让搜索引擎抓取页面内容，优化 `SEO`。

在 `React 16` 前，生成的 `HTML` 内容的每个 `DOM` 节点都有一个 `data-react-id` 属性，根节点有一个 `data-react-checksum` 属性。

组件在服务端渲染后，浏览器端还会渲染一次，完成组件的交互逻辑。渲染时，React 在浏览器端会计算组件的 `data-react-checksum` 属性值，若与服务端计算值一致，则不会进行客户端渲染。因此 `data-react-checksum` 属性是为了完成组件的双端对比。

如果两个组件的 `props` 和 `DOM` 结构相同，计算出的该属性值也是一致的。当属性值一致时，组件只会渲染一次，客户端采用服务端渲染结果，仅作事件绑定等处理，这让应用的初次加载体验非常高效。

从 `React 16` 开始，服务端渲染 `renderToString` 方法渲染的结果不再有 `data-react-*` 属性，并提供了客户端渲染 API - `ReactDOM.hydrate()`，使用上与 `ReactDOM.render()` 无差别。

此外，`React 16` 在性能上做了改进，提供了 `renderToNodeStream` 方法，可以将组件转换为字节流。

因为组件渲染为字符串是一次性处理完后才开始向浏览器返回结果，而采用流的话，可以边读边输出，让页面更快展现，缩短首屏展现时间。

## 实现最基本的 React SSR

![20240624225145](https://raw.githubusercontent.com/chuenwei0129/my-picgo-repo/master/react/20240624225145.png)
