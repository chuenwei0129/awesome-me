---
title: DNS 篇
order: 4
toc: content
group:
  title: 基础知识
---

## 简介

在互联网上浏览或访问任何资源之前，我们需要知道目标服务器的 IP 地址，这是数据传输的基础。然而，由于 IP 地址由一串难以记忆的数字组成 (例如 `161.117.232.65`)，直接使用它们并不实际。这就是为什么我们使用易于记忆的网址 (如 `http://baidu.com`)，而 DNS (域名系统) 的角色便是将这些网址转换成对应的 IP 地址，就像一个电话簿一样。

## 域名结构树

域名系统展示了一种清晰的层次结构，以 `www.baidu.com` 为例，来深入理解其构成。在这个例子中，`www.baidu.com.` 为域名的完整形式，最后一个点指向互联网的根域名。在日常网络浏览中，这个点经常被省略，但它在技术上代表了域名系统的最顶层。

互联网拥有 13 个根域名服务器，标记为 A 根到 M 根，这些服务器分布在全球各地，确保了互联网的基础结构的稳定和可靠。值得注意的是，尽管只有 13 个独特的根服务器标识，但通过 IP 地址的任播技术，世界各地部署了数百台物理服务器来执行根域名的解析服务。这种设计增强了互联网的韧性和性能。

在域名 `www.baidu.com` 中，com 是顶级域名，它位于域名结构的最高层级。baidu 作为二级域名，标识了特定的组织或实体。www 是主机名，通常用于指向托管特定服务的服务器。尽管 www 是最常见的主机名，但网站也可以选择其他主机名，或者直接使用二级域名 (不带 www)，以满足不同的访问和服务需求。

![](https://raw.githubusercontent.com/chuenwei0129/my-picgo-repo/master/computer/http-6.jpg)

## DNS 解析流程的详细说明

![20240417184254](https://raw.githubusercontent.com/chuenwei0129/my-picgo-repo/master/me/20240417184254.png)

全球的设备数量庞大，如果每次发起请求都进行完整的 DNS 解析，DNS 系统的压力将非常巨大。为了减轻这种压力，采用了缓存机制。

当您尝试访问一个未缓存的网站 (例如 `www.baidu.com`)，而且没有通过任何代理服务时，您的浏览器和操作系统将会执行以下步骤来解析网站的 IP 地址：

1. **浏览器缓存检查**：首先，浏览器会检查其内置的 DNS 缓存。这是因为浏览器设计有自己的 DNS 缓存机制，以加快访问速度。在这个例子中，浏览器在自己的缓存中找不到 `www.baidu.com` 的记录。

2. **操作系统缓存查询**：接下来，浏览器会请求操作系统帮助解析域名。这一步是通过调用操作系统提供的 `getaddrinfo` 方法实现的。操作系统同样维护了一层 DNS 缓存，但是在这个场景中，操作系统的缓存里也没有 `www.baidu.com` 的解析结果。

3. **查询上游 DNS 服务器**：既然本地缓存中没有找到所需的信息，操作系统会根据网络设置中配置的上游 DNS 服务器地址来发起解析请求。假设在这个例子中，配置的 DNS 服务器地址是 `161.117.232.65`。操作系统将向这个地址发送解析请求 (通常是通过 UDP 协议)，以获取 `www.baidu.com` 的 IP 地址。

4. **上游 DNS 解析**：如果这个 DNS 服务器 (`161.117.232.65`) 没有直接缓存 `www.baidu.com` 的解析结果，它会继续向更高级别的 DNS 服务器查询，直到找到答案。我们这里不深入其具体的查询过程，但最终，`161.117.232.65` 会将 `www.baidu.com` 的 IP 地址回传给请求者的操作系统。

至此，浏览器已经获得了 `www.baidu.com` 的 IP 地址，可以开始建立 HTTPS 连接进行访问了。

这一过程同样适用于其他基于 TCP 的服务 (如 SMTP 邮件服务)，因为根据 TCP/IP 协议的设计，在应用程序尝试建立 TCP 连接前，必须先解析出目标服务器的 IP 地址，然后直接向该 IP 地址发起连接请求。

## 公共 DNS

我们连接到互联网，无论是通过 PPPoE 拨号还是 DHCP 连接，互联网服务提供商 (ISP) 都会为我们分配 DNS 服务器。这些 ISP DNS 服务器在 DNS 解析过程中扮演着递归 DNS 的角色，负责转发解析请求。然而，ISP 有时会出于减轻带宽负载、插入广告、法律政策遵从或其他目的而干预 DNS 解析结果，这可能导致不准确的解析结果或不良的用户体验。

同时一些个人或互联网服务提供商也会架设自己的递归 DNS 开放给所有人使用，称为公共 DNS。

对于绝大部分人来说，运营商下发的 ISP DNS 应该是最准确的和最合适的，响应时间短、CDN 解析结果也会最准确。

## DNS 负载均衡

DNS 解析可能返回多个 IP 地址，客户端可以从中随机选择一个进行请求。这种机制称为 **DNS 负载均衡**，有助于分散服务器的请求压力，提高服务的可用性和稳定性。

## CNAME 是什么？

CNAME 代表 “Canonical Name”。CNAME 记录是 DNS (域名系统) 中的一种记录类型，它允许将一个域名指向另一个域名，而不是直接指向一个 IP 地址。这意味着，当 DNS 查找遇到一个 CNAME 记录时，它会被告知去查找另一个域名的记录来获取最终的 IP 地址。

### CNAME 记录的行为

1. **递归解析**：当 DNS 解析器遇到一个 CNAME 记录时，它会停止对当前域名的任何其他记录的查找，转而去解析 CNAME 指向的域名。这个过程会持续进行，直到找到一个非 CNAME 记录 (通常是 A 记录或 AAAA 记录，指向实际的 IP 地址)。

2. **与其他记录的兼容性**：根据 RFC 1034 和 RFC 2181 的规范，一个具有 CNAME 记录的域名不应该有其他类型的 DNS 记录 (例如 A、AAAA、TXT 等)。这是为了避免解析上的歧义。例如，如果一个域名同时有 CNAME 和 A 记录，那么当请求该域名的 IP 地址时，DNS 服务器应该返回哪一个记录的结果就不明确了。

### 例外和注意事项

- **根域名和 CNAME**：根据 DNS 规范，顶级域 (例如 `example.com`) 不允许直接使用 CNAME 记录，因为这会与其他必需的记录 (如 NS 记录和 SOA 记录) 冲突。但是，子域 (例如 `www.example.com`) 可以使用 CNAME 记录。

- **CNAME 链**：理论上，CNAME 记录可以指向另一个 CNAME 记录，形成一条链。然而，这种做法可能会导致解析延迟，并可能触发一些 DNS 服务器配置的查询深度限制。

- **性能考虑**：使用 CNAME 记录可能会略微增加 DNS 解析时间，因为需要额外的查询来解析最终的 IP 地址。因此，在性能敏感的应用中，应谨慎使用 CNAME 记录。

## 拓展阅读

> [我有特别的 DNS 配置和使用技巧](https://blog.skk.moe/post/i-have-my-unique-dns-setup/)
