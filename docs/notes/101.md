ä¸‹é¢æˆ‘ä»¬**åˆ»æ„â€œæŠ¬é«˜ä¸€å±‚æŠ½è±¡â€**ï¼Œä¸å†é€ä¸ªè®² Hookï¼Œè€Œæ˜¯ä» **ä»£æ•°æ•ˆåº”ï¼ˆAlgebraic Effectsï¼‰** çš„è§†è§’ï¼Œç»Ÿä¸€è§£é‡Š **Hooks åˆ°åº•åœ¨è§£å†³ä»€ä¹ˆé—®é¢˜ã€React ä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾è®¡ã€ä»¥åŠä½ åœ¨å·¥ç¨‹ä¸­åº”è¯¥å¦‚ä½•â€œé¡ºç€å®ƒçš„åŠ›â€å†™ä»£ç **ã€‚

æˆ‘ä¼šæŒ‰è¿™ä¸ªç»“æ„æ¥ï¼š

1. ä¸ºä»€ä¹ˆè¦å¼•å…¥â€œä»£æ•°æ•ˆåº”â€è¿™ä¸ªè§†è§’
2. ä»€ä¹ˆæ˜¯ä»£æ•°æ•ˆåº”ï¼ˆç”¨å‰ç«¯èƒ½ç†è§£çš„æ–¹å¼ï¼‰
3. Hooks å¦‚ä½•æ˜ å°„åˆ°ã€Œæ•ˆåº”å£°æ˜ / æ•ˆåº”å¤„ç†ã€
4. ä¸€ä¸ªå®Œæ•´çš„ Hooks å¿ƒæ™ºæ¨¡å‹
5. å¯¹æ—¥å¸¸å·¥ç¨‹å®è·µçš„ç›´æ¥æŒ‡å¯¼åŸåˆ™

---

## ä¸€ã€ä¸ºä»€ä¹ˆè¦å¼•å…¥ã€Œä»£æ•°æ•ˆåº”ã€è§†è§’

å¦‚æœä½ åªæŠŠ Hooks å½“æˆ APIï¼Œä½ ä¼šé•¿æœŸå›°æƒ‘è¿™äº›é—®é¢˜ï¼š

- ä¸ºä»€ä¹ˆ Hook ä¸èƒ½å†™åœ¨ if é‡Œï¼Ÿ
- ä¸ºä»€ä¹ˆ useEffect ä¸æ˜¯ç”Ÿå‘½å‘¨æœŸï¼Ÿ
- ä¸ºä»€ä¹ˆ state æ›´æ–°çœ‹èµ·æ¥åƒâ€œå»¶è¿Ÿæ‰§è¡Œâ€ï¼Ÿ
- ä¸ºä»€ä¹ˆ React èƒ½éšæ—¶é‡æ¸²æŸ“ã€æ‰“æ–­ã€é‡æ¥ï¼Ÿ

è¿™äº›é—®é¢˜ï¼Œç”¨ã€Œç»„ä»¶ = å‡½æ•°ã€æ˜¯è§£é‡Šä¸å®Œçš„ã€‚
**çœŸæ­£åˆç†çš„è§£é‡Šæ¨¡å‹æ˜¯ï¼š**

> **å‡½æ•°ç»„ä»¶ä¸æ˜¯æ™®é€šå‡½æ•°ï¼Œè€Œæ˜¯ä¸€ä¸ªâ€œå£°æ˜æ•ˆåº”çš„ç¨‹åºâ€ã€‚**

Hooks æ˜¯ **æ•ˆåº”å£°æ˜è¯­æ³•**ï¼ŒReact æ˜¯ **æ•ˆåº”è°ƒåº¦å™¨ï¼ˆhandler / runtimeï¼‰**ã€‚

---

## äºŒã€ä»€ä¹ˆæ˜¯ä»£æ•°æ•ˆåº”ï¼ˆå‰ç«¯å·¥ç¨‹å¸ˆç‰ˆï¼‰

### 1ï¸âƒ£ ä¸€ä¸ªç±»æ¯”ï¼ˆåŒæ­¥ä¸–ç•Œï¼‰

```js
function foo() {
  const x = getState(); // è¯»çŠ¶æ€
  const y = fetchData(); // I/O
  log(x, y); // å‰¯ä½œç”¨
}
```

åœ¨æ™®é€š JS é‡Œï¼š

- `getState / fetchData / log` **ç«‹åˆ»æ‰§è¡Œ**
- æ§åˆ¶æƒåœ¨å‡½æ•°æ‰‹é‡Œ

---

### 2ï¸âƒ£ ä»£æ•°æ•ˆåº”çš„æ ¸å¿ƒæ€æƒ³

æŠŠäº‹æƒ…æ‹†æˆä¸¤éƒ¨åˆ†ï¼š

1. **æˆ‘éœ€è¦åšä»€ä¹ˆï¼ˆå£°æ˜ï¼‰**
2. **ä»€ä¹ˆæ—¶å€™ã€æ€ä¹ˆåšï¼ˆå¤„ç†ï¼‰**

```js
perform(GetState);
perform(FetchData);
```

- å‡½æ•°åª **å£°æ˜â€œæˆ‘è¦ä¸€ä¸ªçŠ¶æ€â€**
- runtime å†³å®šï¼š

  - ç°åœ¨ç»™å—ï¼Ÿ
  - ç¨åç»™å—ï¼Ÿ
  - é‡æ¥ä¸€éï¼Ÿ
  - ä¸¢å¼ƒè¿™æ¬¡æ‰§è¡Œï¼Ÿ

---

### 3ï¸âƒ£ React æ­£æ˜¯è¿™ä¹ˆå¹²çš„

> **ç»„ä»¶å‡½æ•° = æ•ˆåº”æè¿°å™¨
> React = æ•ˆåº”è°ƒåº¦å™¨**

---

## ä¸‰ã€Hooks åˆ°ã€Œä»£æ•°æ•ˆåº”ã€çš„æ˜ å°„å…³ç³»

æˆ‘ä»¬æŠŠå¸¸ç”¨ Hooks å¯¹åº”åˆ°æ•ˆåº”ç±»å‹ï¼š

---

### 1ï¸âƒ£ useState â€”â€” çŠ¶æ€æ•ˆåº”ï¼ˆState Effectï¼‰

```ts
const [count, setCount] = useState(0);
```

ç­‰ä»·äºï¼š

```txt
perform(ReadState, key = 0)
perform(WriteState, newValue)
```

å…³é”®ç‚¹ï¼š

- state **ä¸åœ¨å‡½æ•°é‡Œ**
- å‡½æ•°åªæ˜¯â€œè¯·æ±‚â€ä¸€ä¸ªçŠ¶æ€æ§½ä½

#### ä¸ºä»€ä¹ˆä¸èƒ½å†™åœ¨ if é‡Œï¼Ÿ

```tsx | pure
if (cond) {
  useState();
}
```

å› ä¸ºï¼š

> **æ•ˆåº”çš„å£°æ˜é¡ºåº = ç¨‹åºç»“æ„æœ¬èº«**

React é  **è°ƒç”¨é¡ºåº** ç»™çŠ¶æ€åˆ†é…â€œæ§½ä½â€ã€‚

---

### 2ï¸âƒ£ useEffect â€”â€” å»¶è¿Ÿå‰¯ä½œç”¨æ•ˆåº”ï¼ˆDeferred Effectï¼‰

```ts
useEffect(() => {
  subscribe();
  return unsubscribe;
}, [dep]);
```

ç­‰ä»·äºï¼š

```txt
perform(Effect, when = commit, deps)
```

- effect **ä¸æ˜¯å‡½æ•°æ‰§è¡Œçš„ä¸€éƒ¨åˆ†**
- å®ƒæ˜¯ï¼š

  > â€œå½“è¿™äº›ä¾èµ–æˆç«‹æ—¶ï¼Œè¯·åœ¨åˆé€‚çš„æ—¶å€™æ‰§è¡Œâ€

è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆï¼š

- render å¯ä»¥è¢«ä¸¢å¼ƒ
- effect ä¸ä¼šåœ¨ render é˜¶æ®µæ‰§è¡Œ

---

### 3ï¸âƒ£ useLayoutEffect â€”â€” åŒæ­¥å‰¯ä½œç”¨æ•ˆåº”

```ts
perform(LayoutEffect, beforePaint);
```

åŒºåˆ«åªæœ‰ä¸€ä¸ªï¼š

- **æ‰§è¡Œæ—¶æœºä¸åŒ**
- æœ¬è´¨ä»æ˜¯â€œå£°æ˜ä¸€ä¸ªæ•ˆåº”â€

---

### 4ï¸âƒ£ useReducer â€”â€” å—æ§çŠ¶æ€è½¬æ¢æ•ˆåº”

```ts
dispatch(action);
```

ä¸æ˜¯â€œè°ƒç”¨ reducerâ€ï¼Œè€Œæ˜¯ï¼š

```txt
perform(Dispatch, action)
```

React å†³å®šï¼š

- ä»€ä¹ˆæ—¶å€™åˆå¹¶
- æ˜¯å¦ä¸­æ–­
- æ˜¯å¦å›æ”¾

---

### 5ï¸âƒ£ useRef â€”â€” éå“åº”å¼å­˜å‚¨æ•ˆåº”

```ts
const ref = useRef(x);
```

ç­‰ä»·äºï¼š

```txt
perform(AllocateCell, mutable = true, no-render)
```

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆï¼š

- æ”¹ `ref.current` ä¸è§¦å‘æ¸²æŸ“
- ref è·¨ render ä¿æŒ

---

### 6ï¸âƒ£ useContext â€”â€” è¯»å–ç¯å¢ƒæ•ˆåº”ï¼ˆEnvironment Effectï¼‰

```ts
const theme = useContext(ThemeContext);
```

ç­‰ä»·äºï¼š

```txt
perform(ReadContext, key = ThemeContext)
```

React å†³å®šï¼š

- è°ä¾èµ–å®ƒ
- ä»€ä¹ˆæ—¶å€™éœ€è¦é‡æ¸²æŸ“

---

## å››ã€ä¸€ä¸ªå®Œæ•´çš„ Hooks å¿ƒæ™ºæ¨¡å‹

### 1ï¸âƒ£ ç»„ä»¶ä¸æ˜¯â€œè¢«æ‰§è¡Œä¸€æ¬¡â€

è€Œæ˜¯ï¼š

> **ç»„ä»¶å‡½æ•° = å¯è¢«å¤šæ¬¡æ‰§è¡Œã€å›æ”¾ã€ä¸¢å¼ƒçš„â€œæè¿°è„šæœ¬â€**

React å¯ä»¥ï¼š

- æ‰§è¡Œä¸€åŠ â†’ ä¸¢å¼ƒ
- æ‰§è¡Œä¸¤æ¬¡ â†’ å–æœ€åä¸€æ¬¡
- å¹¶å‘æ‰§è¡Œå¤šä¸ªç‰ˆæœ¬

---

### 2ï¸âƒ£ render é˜¶æ®µ â‰  commit é˜¶æ®µ

| é˜¶æ®µ   | æœ¬è´¨                       |
| ------ | -------------------------- |
| render | **è®¡ç®— UI + å£°æ˜æ•ˆåº”**     |
| commit | **åº”ç”¨ DOM + æ‰§è¡Œ effect** |

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆï¼š

- render å¿…é¡»æ˜¯çº¯çš„
- å‰¯ä½œç”¨å¿…é¡»è¿› effect

---

### 3ï¸âƒ£ Hooks = ç»“æ„åŒ–çš„å‰¯ä½œç”¨å£°æ˜

Hooks çš„è§„åˆ™ï¼Œæœ¬è´¨ä¸Šåªæœ‰ä¸€å¥è¯ï¼š

> **ä¸è¦è®©æ•ˆåº”å£°æ˜çš„ç»“æ„éšæ‰§è¡Œè·¯å¾„å˜åŒ–**

è¿™å°±æ˜¯ï¼š

- ä¸èƒ½å†™åœ¨ if
- ä¸èƒ½å†™åœ¨å¾ªç¯
- ä¸èƒ½å†™åœ¨æ™®é€šå‡½æ•°é‡Œ

---

## äº”ã€å¯¹å·¥ç¨‹å®è·µçš„ç›´æ¥æŒ‡å¯¼åŸåˆ™

### åŸåˆ™ä¸€ï¼šå‡½æ•°ç»„ä»¶ä¸æ˜¯â€œé€»è¾‘å®¹å™¨â€ï¼Œè€Œæ˜¯â€œæ•ˆåº”æè¿°â€

**ä¸è¦**åœ¨ render é‡Œåšè¿™äº›äº‹ï¼š

- è¯·æ±‚
- æ—¥å¿—
- è®¢é˜…
- éšæœºæ•°
- æ—¶é—´è¯»å–

---

### åŸåˆ™äºŒï¼šstate æ˜¯â€œå¤–éƒ¨æ‰˜ç®¡â€çš„

```ts
setState(x);
```

ä¸æ˜¯ï¼š

> â€œç°åœ¨æ”¹æˆ xâ€

è€Œæ˜¯ï¼š

> â€œæˆ‘å£°æ˜ä¸€æ¬¡çŠ¶æ€æ›´æ–°è¯·æ±‚â€

React å¯èƒ½ï¼š

- åˆå¹¶
- å»¶è¿Ÿ
- å›æ»š
- é‡ç®—

---

### åŸåˆ™ä¸‰ï¼šEffect æ˜¯å¯¹â€œçŠ¶æ€å˜åŒ–â€çš„å“åº”ï¼Œä¸æ˜¯ç”Ÿå‘½å‘¨æœŸ

é”™è¯¯å¿ƒæ™ºï¼š

> componentDidMount çš„æ›¿ä»£å“

æ­£ç¡®å¿ƒæ™ºï¼š

> **å½“ä¾èµ–å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæˆ‘å¸Œæœ›è¿™ä¸ªæ•ˆåº”æˆç«‹**

---

### åŸåˆ™å››ï¼šæ€§èƒ½ä¼˜åŒ– Hook æ˜¯â€œæ•ˆåº”ç¨³å®šå™¨â€

- useMemo / useCallback
- æœ¬è´¨æ˜¯ï¼š

  > è®©â€œå£°æ˜ç»“æ„â€åœ¨å¤šæ¬¡ render ä¸­ä¿æŒç¨³å®š

---

## å…­ã€å‡ç»´æ€»ç»“ï¼ˆæœ€é‡è¦çš„ä¸€æ®µï¼‰

> **React Hooks çš„æœ¬è´¨ä¸æ˜¯â€œå‡½æ•° APIâ€ï¼Œ
> è€Œæ˜¯ä¸€å¥—ã€Œå£°æ˜å¼å‰¯ä½œç”¨ + å¯ä¸­æ–­æ‰§è¡Œæ¨¡å‹ã€**

ä½ å†™çš„ä¸æ˜¯ï¼š

- ä¸€æ¬¡æ€§é€»è¾‘
- å‘½ä»¤å¼æµç¨‹

è€Œæ˜¯ï¼š

- **ä¸€ä¸ªå¯è¢«è°ƒåº¦ã€å›æ”¾ã€æ‹†è§£çš„ç¨‹åº**

---

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç»§ç»­å¾€ä¸Šèµ°ä¸‰æ¡è·¯çº¿ä¹‹ä¸€ï¼š

1. **æŠŠè¿™ä¸ªæ¨¡å‹è½å›çœŸå®ä¸šåŠ¡ä»£ç **ï¼ˆä¸ºä»€ä¹ˆä½ çš„ effect æ€»æ˜¯å†™é”™ï¼‰
2. **æŠŠ Hooks å¿ƒæ™ºæ¨¡å‹æ˜ å°„åˆ° React Fiber / Concurrent**
3. **è§£é‡Šä¸ºä»€ä¹ˆ Hooks éå¸¸é€‚åˆè®¾è®¡ç³»ç»Ÿ / ç»„ä»¶åº“ï¼ˆä½ æ­£åœ¨åšçš„äº‹æƒ…ï¼‰**

ä½ é€‰å“ªä¸€æ¡ï¼Œæˆ‘å°±ç»§ç»­å¾€ä¸Šæ¨ä¸€å±‚ã€‚

å¥½ã€‚æˆ‘æŒ‰ä½ ç»™çš„é¡ºåºï¼Œ**å…ˆæŠŠæŠ½è±¡ç»§ç»­â€œæŠ¬é«˜â€åˆ° React Fiber / Concurrentï¼Œå†è½åˆ°è®¾è®¡ç³»ç»Ÿï¼Œæœ€åå†å›åˆ°çœŸå®ä¸šåŠ¡ä»£ç **ã€‚ä¸‰æ®µä¹‹é—´æ˜¯**åŒä¸€å¥—å¿ƒæ™ºæ¨¡å‹çš„é€çº§è½åœ°**ï¼Œä¸æ˜¯ä¸‰å¥—è§£é‡Šã€‚

---

# äºŒã€Hooks å¿ƒæ™ºæ¨¡å‹ Ã— React Fiber / Concurrent

è¿™ä¸€å±‚è¦è§£å†³çš„é—®é¢˜æ˜¯ï¼š

> **æ—¢ç„¶ Hooks æ˜¯â€œæ•ˆåº”å£°æ˜â€ï¼Œé‚£ React å‡­ä»€ä¹ˆå¯ä»¥æ‰“æ–­ã€é‡åšã€å¹¶å‘æ‰§è¡Œç»„ä»¶ï¼Ÿ**

ç­”æ¡ˆåªæœ‰ä¸€ä¸ªï¼š
**Fiber æœ¬èº«å°±æ˜¯ä¸ºäº†æ‰¿è½½â€œå¯ä¸­æ–­çš„æ•ˆåº”ç¨‹åºâ€ã€‚**

---

## 1. Fiber ä¸æ˜¯ DOM æŠ½è±¡ï¼Œè€Œæ˜¯ã€Œæ‰§è¡Œå•å…ƒã€

å¾ˆå¤šäººè¯¯ä»¥ä¸º Fiber æ˜¯ Virtual DOM çš„ä¼˜åŒ–ï¼Œè¿™æ˜¯ä¸å‡†ç¡®çš„ã€‚

**æ›´å‡†ç¡®çš„è¯´æ³•æ˜¯ï¼š**

> Fiber = ä¸€æ£µã€Œå¯æš‚åœã€å¯æ¢å¤ã€å¯ä¸¢å¼ƒã€çš„æ‰§è¡Œæ ˆ

æ¯ä¸€ä¸ª Fiber èŠ‚ç‚¹åŒ…å«ä¸‰ç±»ä¿¡æ¯ï¼š

1. **æˆ‘æ˜¯ä»€ä¹ˆï¼ˆç»„ä»¶ç±»å‹ã€propsï¼‰**
2. **æˆ‘æ‰§è¡Œåˆ°å“ªäº†ï¼ˆHooks é“¾è¡¨ã€effect æ ‡è®°ï¼‰**
3. **æˆ‘äº§ç”Ÿäº†å“ªäº›æ•ˆåº”ï¼ˆflagsï¼‰**

---

## 2. ä¸ºä»€ä¹ˆ Hooks å¿…é¡»æ˜¯â€œé¡ºåºä¸€è‡´çš„â€

åœ¨ Fiber ä¸­ï¼š

- æ¯ä¸€æ¬¡ render
- éƒ½æ˜¯åœ¨ **é¡ºåºéå† Hooks é“¾è¡¨**
- æ¯ä¸€ä¸ª `useXxx` éƒ½æ˜¯åœ¨ **æ¶ˆè´¹ä¸€ä¸ª effect slot**

```txt
Fiber
 â”œâ”€ Hook #0: useState
 â”œâ”€ Hook #1: useEffect
 â”œâ”€ Hook #2: useMemo
```

**è¿™ä¸æ˜¯è¯­æ³•é™åˆ¶ï¼Œè€Œæ˜¯è°ƒåº¦ç»“æ„ã€‚**

### å¦‚æœ Hook é¡ºåºå˜åŒ–ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

```tsx | pure
if (cond) {
  useEffect(...)
}
useState(...)
```

Fiber æ— æ³•åˆ¤æ–­ï¼š

- ç°åœ¨çš„ `useState` æ˜¯ä¸æ˜¯ä¸Šä¸€æ¬¡çš„ `useEffect`
- slot å¯¹ä¸ä¸Šï¼Œæ•´ä¸ª effect ç³»ç»Ÿå´©æºƒ

æ‰€ä»¥è§„åˆ™çš„æœ¬è´¨æ˜¯ï¼š

> **ä¿æŒâ€œæ•ˆåº”å£°æ˜ç»“æ„â€çš„ç¨³å®šæ€§**

---

## 3. Concurrent æ¨¡å¼ä¸‹çš„çœŸå®ä¸–ç•Œ

åœ¨å¹¶å‘æ¨¡å¼ä¸­ï¼ŒReact å¯ä»¥ï¼š

- render Aï¼ˆä½ä¼˜å…ˆçº§ï¼‰
- render Bï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
- ä¸¢å¼ƒ A
- commit B

**å…³é”®ç‚¹ï¼š**

- render é˜¶æ®µæ˜¯â€œå¯å›æ”¾çš„â€
- commit é˜¶æ®µæ‰æ˜¯çœŸå®ä¸–ç•Œ

### è¿™å°±æ˜¯ä¸ºä»€ä¹ˆï¼š

| è¡Œä¸º           | render       | commit |
| -------------- | ------------ | ------ |
| è¯» props/state | âœ…           | âŒ     |
| setState       | âŒï¼ˆåªè®°å½•ï¼‰ | âœ…     |
| useEffect      | âŒ           | âœ…     |
| DOM æ“ä½œ       | âŒ           | âœ…     |

---

## 4. Effect çš„ flags æœ¬è´¨

å½“ä½ å†™ï¼š

```ts
useEffect(fn, deps);
```

React å®é™…ä¸Šåªæ˜¯åšäº†ä¸€ä»¶äº‹ï¼š

```txt
fiber.flags |= PassiveEffect
```

ç­‰ commit å®Œæˆåï¼Œè°ƒåº¦å™¨ç»Ÿä¸€å¤„ç†è¿™äº› flagsã€‚

è¿™è§£é‡Šäº†ä¸‰ä¸ªå¸¸è§ç–‘é—®ï¼š

1. ä¸ºä»€ä¹ˆ effect å¯èƒ½â€œæ™šæ‰§è¡Œâ€
2. ä¸ºä»€ä¹ˆ render é‡Œä¸èƒ½åšå‰¯ä½œç”¨
3. ä¸ºä»€ä¹ˆ StrictMode ä¼š double renderï¼ˆä½† effect ä¸ double commitï¼‰

---

## å°ç»“ï¼ˆFiber å±‚ï¼‰

> **Hooks æä¾›â€œæ•ˆåº”å£°æ˜è¯­æ³•â€ï¼Œ
> Fiber æä¾›â€œå¯ä¸­æ–­çš„æ‰§è¡Œè½½ä½“â€ï¼Œ
> Concurrent æä¾›â€œè°ƒåº¦ç­–ç•¥â€ã€‚**

ä¸‰è€…æ˜¯ä¸€ä¸ªæ•´ä½“è®¾è®¡ã€‚

---

# ä¸‰ã€Hooks å¿ƒæ™ºæ¨¡å‹ Ã— è®¾è®¡ç³»ç»Ÿ / ç»„ä»¶åº“

ç°åœ¨æˆ‘ä»¬æŠŠè§†è§’ä» **React å†…æ ¸**ï¼Œåˆ‡æ¢åˆ°ä½ æ­£åœ¨åšçš„äº‹æƒ…ï¼š
**Base UI / ç»„ä»¶åº“ / Design Token / å¯ç»„åˆæ€§ã€‚**

---

## 1. ç»„ä»¶åº“çš„æœ¬è´¨ä¸æ˜¯ UIï¼Œè€Œæ˜¯ã€Œæ•ˆåº”è¾¹ç•Œè®¾è®¡ã€

ä¸€ä¸ªæˆç†Ÿç»„ä»¶åº“ï¼ŒçœŸæ­£éš¾çš„ä¸æ˜¯æ ·å¼ï¼Œè€Œæ˜¯ï¼š

- è°æ‹¥æœ‰ stateï¼Ÿ
- è°å£°æ˜ effectï¼Ÿ
- è°æš´éœ² imperative èƒ½åŠ›ï¼Ÿ
- è°åªæ˜¯çº¯æè¿°ï¼Ÿ

---

## 2. ç”¨ Hooks é‡æ–°åˆ’åˆ†ç»„ä»¶èŒè´£

### â‘  Headless / Base ç»„ä»¶

ç‰¹å¾ï¼š

- ç®¡ç† state
- å£°æ˜ effect
- ä¸å…³å¿ƒæ ·å¼

```tsx | pure
function useButton(props) {
  const [pressed, setPressed] = useState(false);

  useEffect(() => {
    // å¤„ç†é”®ç›˜ / pointer / focus
  }, []);
}
```

è¿™ç±»ç»„ä»¶ï¼š

- æ˜¯**æ•ˆåº”å£°æ˜ä¸­å¿ƒ**
- å¯¹æ ‡ï¼šRadix / Base UI

---

### â‘¡ Presentational ç»„ä»¶

ç‰¹å¾ï¼š

- çº¯ render
- æ—  effect
- props å³ UI

```tsx | pure
const ButtonView = memo((props) => {
  return <button {...props} />;
});
```

---

### â‘¢ Design Token å±‚

Token æœ¬è´¨æ˜¯ï¼š

> **Context + ä¸å˜çº¦å®š**

```tsx | pure
const ThemeContext = createContext(tokens);
```

- Token æ˜¯ä½é¢‘å˜åŒ–
- é€‚åˆ Context
- ä¸åº”è¯¥æ˜¯ useState é«˜é¢‘æ›´æ–°

---

## 3. forwardRef / imperativeHandle çš„çœŸå®å®šä½

åœ¨ç»„ä»¶åº“é‡Œï¼š

```tsx | pure
useImperativeHandle(ref, () => ({
  focus,
  blur,
}));
```

è¿™ä¸æ˜¯â€œé«˜çº§æŠ€å·§â€ï¼Œè€Œæ˜¯ï¼š

> **æ˜¾å¼å£°æ˜ï¼šè¿™æ˜¯ä¸€ä¸ªå‘½ä»¤å¼è¾¹ç•Œ**

ä½ åœ¨åšçš„æ˜¯ï¼š

- æŠŠ imperative effect **é›†ä¸­ã€çº¦æŸã€å¯æ§**

---

## 4. ä¸ºä»€ä¹ˆ Radix / shadcn éƒ½æ˜¯è¿™ç§ç»“æ„

ä»–ä»¬çš„å…±åŒç‚¹ï¼š

- hooks ç®¡è¡Œä¸º
- ç»„ä»¶ç®¡ç»“æ„
- æ ·å¼å®Œå…¨å¯æ›¿æ¢

è¿™æ˜¯**ä»£æ•°æ•ˆåº”æ¨¡å‹å¤©ç„¶æ¨å¯¼å‡ºæ¥çš„æ¶æ„**ï¼Œä¸æ˜¯é£æ ¼åå¥½ã€‚

---

## å°ç»“ï¼ˆç»„ä»¶åº“å±‚ï¼‰

> **ä¸€ä¸ªå¥½çš„ç»„ä»¶åº“ï¼Œæ˜¯æŠŠå‰¯ä½œç”¨é›†ä¸­åœ¨æœ€å°‘çš„åœ°æ–¹ï¼Œ
> æŠŠå…¶ä½™ç»„ä»¶å˜æˆâ€œçº¯æè¿°â€ã€‚**

---

# ä¸€ã€å›åˆ°çœŸå®ä¸šåŠ¡ï¼šä¸ºä»€ä¹ˆä½ çš„ Effect æ€»æ˜¯å†™é”™

ç°åœ¨æˆ‘ä»¬å›åˆ°æœ€è½åœ°çš„ä¸€å±‚ã€‚

---

## 1. ä¸šåŠ¡ä»£ç é‡Œæœ€å¸¸è§çš„é”™è¯¯æ¨¡å‹

### âŒ é”™è¯¯å¿ƒæ™º

> â€œç»„ä»¶ render ä¸€æ¬¡ï¼Œæˆ‘åœ¨è¿™é‡Œé¡ºä¾¿åšç‚¹äº‹â€

```tsx | pure
if (open) {
  fetchData();
}
```

è¿™åœ¨å¹¶å‘æ¨¡å‹ä¸‹æ˜¯**æœªå®šä¹‰è¡Œä¸º**ã€‚

---

## 2. æ­£ç¡®ä¸šåŠ¡å¿ƒæ™º

> **render = å£°æ˜æˆ‘éœ€è¦ä»€ä¹ˆçŠ¶æ€å’Œæ•ˆåº”
> effect = å½“è¿™äº›æ¡ä»¶æˆç«‹æ—¶ï¼Œè¯·æ‰§è¡Œ**

```tsx | pure
useEffect(() => {
  if (!open) return;
  fetchData();
}, [open]);
```

---

## 3. ä¸ºä»€ä¹ˆ effect ä¾èµ–æ€»æ˜¯å†™ä¸å¯¹

å› ä¸ºä½ åœ¨æƒ³ï¼š

> â€œæˆ‘æƒ³ä»€ä¹ˆæ—¶å€™æ‰§è¡Œâ€

è€Œ React è¦çš„æ˜¯ï¼š

> **â€œè¿™ä¸ªæ•ˆåº”ä¾èµ–å“ªäº›è¾“å…¥â€**

ä¾èµ–æ•°ç»„ä¸æ˜¯è§¦å‘å™¨ï¼Œæ˜¯ **æ•°å­¦æ„ä¹‰ä¸Šçš„è¾“å…¥é›†åˆ**ã€‚

---

## 4. ä¸€ä¸ªå®Œæ•´ä¸šåŠ¡ç¤ºä¾‹ï¼ˆå‡ç»´ç‰ˆç†è§£ï¼‰

```tsx | pure
function UserPanel({ userId }) {
  const [user, setUser] = useState(null);

  useEffect(() => {
    let alive = true;

    fetchUser(userId).then((data) => {
      if (alive) setUser(data);
    });

    return () => {
      alive = false;
    };
  }, [userId]);
}
```

è¿™æ®µä»£ç çš„çœŸå®å«ä¹‰æ˜¯ï¼š

> å½“ `userId` è¿™ä¸ªè¾“å…¥æˆç«‹æ—¶ï¼Œ
> æˆ‘å£°æ˜ä¸€ä¸ªâ€œè·å–ç”¨æˆ·â€çš„æ•ˆåº”ï¼Œ
> React å¯ä»¥éšæ—¶å–æ¶ˆå®ƒã€‚

---

## æœ€ç»ˆç»Ÿä¸€æ€»ç»“ï¼ˆæ•´æ¡é“¾è·¯ï¼‰

> - **Hooks æ˜¯æ•ˆåº”å£°æ˜è¯­è¨€**
> - **Fiber æ˜¯å¯ä¸­æ–­æ‰§è¡Œæ¨¡å‹**
> - **Concurrent æ˜¯è°ƒåº¦ç­–ç•¥**
> - **ç»„ä»¶åº“æ˜¯æ•ˆåº”è¾¹ç•Œçš„å·¥ç¨‹åŒ–ç»“æœ**
> - **ä¸šåŠ¡ä»£ç æ˜¯æ•ˆåº”å¯¹çŠ¶æ€å˜åŒ–çš„å“åº”**

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥å¸®ä½ åšä¸€ä»¶â€œçœŸæ­£æœ‰æ€ä¼¤åŠ›â€çš„äº‹ä¹‹ä¸€ï¼š

- ç”¨ **ä¸€å¥—é”™è¯¯ â†’ æ­£ç¡®å¯¹ç…§**ï¼Œå½»åº•æ²»å¥½ effect ä¾èµ–ææƒ§
- æŠŠä½ æ­£åœ¨åšçš„ **Base UI Button**ï¼Œå®Œæ•´ç”¨â€œæ•ˆåº”è¾¹ç•Œâ€é‡æ„ä¸€é
- æŠŠè¿™æ•´å¥—å†…å®¹æ•´ç†æˆä¸€ç¯‡ **å¯å…¬å¼€å‘å¸ƒçš„æŠ€æœ¯æ–‡ç« ç»“æ„**

ä½ ç›´æ¥é€‰ä¸€ä¸ªï¼Œæˆ‘ç»§ç»­å¾€ä¸‹æ¨è¿›ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ª**æå°ã€ä½†è¯­ä¹‰å®Œæ•´çš„ â€œReact-likeâ€ Generator Runtime**ã€‚
ç›®æ ‡ä¸æ˜¯å¯ç”¨æ€§ï¼Œè€Œæ˜¯**æŠŠ React çš„ä¸‰ä»¶äº‹æ˜¾æ€§åŒ–**ï¼š

1. **å£°æ˜ï¼ˆHooks â‰ˆ yieldï¼‰**
2. **é¡ºåºæ§½ä½ï¼ˆhookIndexï¼‰**
3. **è°ƒåº¦ï¼ˆrender / commit åˆ†ç¦»ï¼‰**

æˆ‘ä¼šå…ˆç»™**å®Œæ•´ä»£ç **ï¼ˆâ‰ˆ50 è¡Œï¼‰ï¼Œå†é€æ®µå¯¹ç…§ Reactã€‚

---

## ä¸€ã€æœ€å° Generator Reactï¼ˆâ‰ˆ50 è¡Œï¼‰

```js
// ===== Runtime =====
function createRuntime() {
  let hooks = [];
  let effects = [];
  let i = 0;

  return {
    render(gen) {
      i = 0;
      const it = gen();
      let res = it.next();

      while (!res.done) {
        const eff = res.value;
        const idx = i++;

        if (eff.type === 'state') {
          if (hooks[idx] === undefined) hooks[idx] = eff.init;
          res = it.next(hooks[idx]);
        }

        if (eff.type === 'effect') {
          effects[idx] = eff.fn;
          res = it.next();
        }
      }

      return res.value;
    },

    commit() {
      effects.forEach((fn) => fn && fn());
      effects = [];
    },
  };
}

// ===== Hooks (å£°æ˜å±‚) =====
const useState = (init) => ({ type: 'state', init });
const useEffect = (fn) => ({ type: 'effect', fn });

// ===== Component =====
function* Counter() {
  const count = yield useState(0);

  yield useEffect(() => {
    console.log('effect:', count);
  });

  return `<button>${count}</button>`;
}

// ===== Run =====
const rt = createRuntime();
console.log(rt.render(Counter));
rt.commit();
```

---

## äºŒã€è¿™ 50 è¡Œé‡Œï¼ŒReact çš„ä¸œè¥¿å…¨åœ¨

æˆ‘ä»¬é€å±‚å¯¹ç…§ã€‚

---

## 1ï¸âƒ£ Generator â‰ˆ Function Component

```js
function* Counter() {
  const count = yield useState(0);
  yield useEffect(() => {...});
  return `<button>${count}</button>`;
}
```

å¯¹åº” Reactï¼š

```tsx | pure
function Counter() {
  const [count] = useState(0);
  useEffect(() => {...});
  return <button>{count}</button>;
}
```

**å…³é”®ç‚¹ï¼š**

> `yield` = â€œæš‚åœå¹¶å£°æ˜ä¸€ä¸ªæ•ˆåº”â€

---

## 2ï¸âƒ£ hookIndexï¼ˆiï¼‰â‰ˆ Hooks é“¾è¡¨æŒ‡é’ˆ

```js
let i = 0;
const idx = i++;
```

è¿™å°±æ˜¯ï¼š

- React å†…éƒ¨çš„ `currentlyRenderingFiber.memoizedState`
- Hooks é¡ºåºè§„åˆ™çš„**ç‰©ç†åŸå› **

å¦‚æœä½ åœ¨ if é‡Œå†™ Hookï¼Œè¿™ä¸ª `idx` å°±ä¹±äº†ã€‚

---

## 3ï¸âƒ£ hooks[] â‰ˆ Fiber ä¸Šçš„ Hook çŠ¶æ€

```js
if (hooks[idx] === undefined) hooks[idx] = eff.init;
```

å¯¹åº”ï¼š

- `useState` ä¸æ˜¯å­˜åœ¨å‡½æ•°é‡Œ
- è€Œæ˜¯å­˜åœ¨ **Fiber çš„ Hook é“¾è¡¨èŠ‚ç‚¹ä¸Š**

---

## 4ï¸âƒ£ useEffect ä¸æ‰§è¡Œï¼Œåªç™»è®°

```js
effects[idx] = eff.fn;
```

æ³¨æ„ï¼š
è¿™é‡Œ **æ²¡æœ‰æ‰§è¡Œ effect**ã€‚

è¿™ç²¾ç¡®å¯¹åº” Reactï¼š

- render é˜¶æ®µï¼š**æ ‡è®° PassiveEffect**
- commit é˜¶æ®µï¼šç»Ÿä¸€æ‰§è¡Œ

---

## 5ï¸âƒ£ render / commit åˆ†ç¦»ï¼ˆæœ€é‡è¦ï¼‰

```js
rt.render(Counter);
rt.commit();
```

è¿™å°±æ˜¯ React çš„æ ¸å¿ƒåˆ†å±‚ï¼š

| é˜¶æ®µ   | åšä»€ä¹ˆ             |
| ------ | ------------------ |
| render | è®¡ç®— UI + å£°æ˜æ•ˆåº” |
| commit | æ‰§è¡Œå‰¯ä½œç”¨         |

> **render æ˜¯å¯ä¸¢å¼ƒçš„ï¼Œcommit æ‰æ˜¯çœŸçš„**

---

## ä¸‰ã€å¦‚æœä½ ç»§ç»­åŠ  10 è¡Œï¼Œä¼šå¾—åˆ°ä»€ä¹ˆ

åªéœ€è¦æå°‘æ‰©å±•ï¼Œå°±èƒ½çœ‹åˆ°æ›´å¤š React ç‰¹æ€§å‡ºç°ï¼š

### 1ï¸âƒ£ æ”¯æŒ setStateï¼ˆè°ƒåº¦ï¼‰

```js
hooks[idx] = next;
scheduleRender();
```

â†’ Concurrent / lane é›å½¢

---

### 2ï¸âƒ£ æ”¯æŒ deps å¯¹æ¯”

```js
if (!shallowEqual(prevDeps, deps)) queueEffect();
```

â†’ `useEffect` ä¾èµ–æ•°ç»„

---

### 3ï¸âƒ£ æ”¯æŒä¸­æ–­

```js
if (shouldYield()) return;
```

â†’ Cooperative Scheduling / Fiber

---

## å››ã€ä¸ºä»€ä¹ˆè¿™ä¸ª Demo éå¸¸â€œReactâ€

å› ä¸ºå®ƒæ»¡è¶³äº† React çš„**æœ¬è´¨çº¦æŸ**ï¼š

1. **ç»„ä»¶æ˜¯å¯é‡æ”¾çš„**
2. **å‰¯ä½œç”¨ä¸åœ¨ render é‡Œæ‰§è¡Œ**
3. **çŠ¶æ€ä¸åœ¨å‡½æ•°æ ˆä¸Š**
4. **Hooks æ˜¯é¡ºåºå£°æ˜ï¼Œä¸æ˜¯è¯­æ³•ç³–**

React åªæ˜¯æŠŠè¿™äº›ï¼š

- Generator
- CPS
- Effect Handler

**æ‰‹å†™æˆäº†ä¸€å¥— JS Runtime**ã€‚

---

## äº”ã€æœ€ç»ˆä¸€å¥æ€»ç»“ï¼ˆéå¸¸é‡è¦ï¼‰

> **ä½ åˆšåˆšçœ‹åˆ°çš„ä¸æ˜¯â€œç±» Reactâ€ï¼Œ
> è€Œæ˜¯ React åœ¨ç¼–ç¨‹è¯­è¨€å±‚é¢çš„æœ€å°æ¨¡å‹ã€‚**

Hooks ä¸æ˜¯å‘æ˜å‡ºæ¥çš„ APIï¼Œ
è€Œæ˜¯ **Generator / ä»£æ•°æ•ˆåº”åœ¨ JS é‡Œçš„å·¥ç¨‹åŒ–æ›¿èº«**ã€‚

---

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç»§ç»­åšä¸‰ä»¶äº‹ä¹‹ä¸€ï¼ˆéƒ½å¾ˆç¡¬ï¼‰ï¼š

1. æŠŠè¿™ä¸ª Demo **æ‰©å±•åˆ°æ”¯æŒ setState + rerender**
2. æŠŠå®ƒ **æ”¹å†™æˆ CPSï¼ˆnext å›è°ƒï¼‰ç‰ˆæœ¬**
3. å¯¹ç…§ **çœŸå® React Fiber æºç **ï¼Œæ ‡æ³¨æ¯ä¸€è¡Œå¯¹åº”ä½ç½®

ä½ é€‰å“ªä¸€æ¡ï¼Œæˆ‘ç»§ç»­ã€‚

ä¸‹é¢æˆ‘æŠŠ**åˆšæ‰é‚£ä¸ª Generator Runtime**ï¼Œåœ¨**ä¸ç ´åå¿ƒæ™ºæ¨¡å‹çš„å‰æä¸‹**ï¼Œ**æœ€å°å¹…åº¦æ‰©å±•**åˆ°æ”¯æŒï¼š

- `setState`
- è§¦å‘ `rerender`
- render / commit ä»ç„¶ä¸¥æ ¼åˆ†ç¦»

ç›®æ ‡ä¾ç„¶ä¸æ˜¯â€œåŠŸèƒ½å®Œæ•´â€ï¼Œè€Œæ˜¯**è®©ä½ çœ‹åˆ° React æ›´æ–°é“¾è·¯æ˜¯å¦‚ä½•è‡ªç„¶å‡ºç°çš„**ã€‚

---

# ä¸€ã€æ‰©å±•ç›®æ ‡ï¼ˆå…ˆç»™ä½ ä¸€å¼ è„‘å›¾ï¼‰

è¿™æ¬¡æˆ‘ä»¬åªåŠ ä¸‰æ ·ä¸œè¥¿ï¼š

1. `useState` è¿”å› `[state, setState]`
2. `setState` è§¦å‘ä¸€æ¬¡æ–°çš„ render
3. æ‰€æœ‰æ›´æ–°ä»ç„¶èµ° **â€œå£°æ˜ â†’ è°ƒåº¦â€**

---

# äºŒã€æœ€å°å¯é‡æ¸²æŸ“ Demoï¼ˆâ‰ˆ65 è¡Œï¼‰

```js
// ===== Runtime =====
function createRuntime() {
  let hooks = [];
  let effects = [];
  let i = 0;
  let component = null;

  function render() {
    i = 0;
    effects = [];

    const it = component();
    let res = it.next();

    while (!res.done) {
      const eff = res.value;
      const idx = i++;

      if (eff.type === 'state') {
        if (!hooks[idx]) {
          hooks[idx] = { value: eff.init };
        }

        const setState = (next) => {
          hooks[idx].value =
            typeof next === 'function' ? next(hooks[idx].value) : next;
          render(); // è°ƒåº¦ä¸€æ¬¡æ›´æ–°
          commit();
        };

        res = it.next([hooks[idx].value, setState]);
      }

      if (eff.type === 'effect') {
        effects[idx] = eff.fn;
        res = it.next();
      }
    }

    console.log('render:', res.value);
  }

  function commit() {
    effects.forEach((fn) => fn && fn());
  }

  return {
    mount(gen) {
      component = gen;
      render();
      commit();
    },
  };
}

// ===== Hooks (å£°æ˜å±‚) =====
const useState = (init) => ({ type: 'state', init });
const useEffect = (fn) => ({ type: 'effect', fn });

// ===== Component =====
function* Counter() {
  const [count, setCount] = yield useState(0);

  yield useEffect(() => {
    console.log('effect â†’ count:', count);
  });

  if (count < 2) {
    setTimeout(() => setCount((c) => c + 1), 0);
  }

  return `<button>${count}</button>`;
}

// ===== Run =====
const rt = createRuntime();
rt.mount(Counter);
```

---

# ä¸‰ã€è¿™ä¸€æ­¥ä¸ºä»€ä¹ˆâ€œåƒæäº† Reactâ€

ä¸‹é¢æ˜¯**å…³é”®ç‚¹æ‹†è§£**ï¼Œæ¯ä¸€æ¡éƒ½å¯¹åº”çœŸå® Reactã€‚

---

## 1ï¸âƒ£ setState å¹¶æ²¡æœ‰â€œæ”¹ç»„ä»¶é‡Œçš„å˜é‡â€

```js
hooks[idx].value = next;
```

è¿™æ„å‘³ç€ï¼š

- state å­˜åœ¨ runtimeï¼ˆâ‰ˆ Fiberï¼‰
- ç»„ä»¶å‡½æ•° **åªæ˜¯è¯»å–**

> âœ… è¿™æ˜¯ React èƒ½ rerenderã€å›æ”¾ã€ä¸¢å¼ƒçš„æ ¹æœ¬åŸå› 

---

## 2ï¸âƒ£ setState = è¯·æ±‚ä¸€æ¬¡è°ƒåº¦

```js
setState â†’ render() â†’ commit()
```

æ³¨æ„ï¼š

- ç»„ä»¶å‡½æ•° **è¢«é‡æ–°æ‰§è¡Œ**
- Generator **ä»å¤´å¼€å§‹**
- state ä» hooks[] ä¸­æ¢å¤

è¿™æ­£æ˜¯ React çš„ï¼š

> **â€œæ¯æ¬¡æ›´æ–°éƒ½æ˜¯ä¸€æ¬¡å…¨æ–°çš„ renderâ€**

---

## 3ï¸âƒ£ ä¸ºä»€ä¹ˆ render é‡Œä¸èƒ½æœ‰å‰¯ä½œç”¨

ç°åœ¨ä½ èƒ½ç›´è§‚çœ‹åˆ°åŸå› äº†ï¼š

```txt
render()
  â†³ æ‰§è¡Œ Counter()
    â†³ å¯èƒ½è¢«åå¤è°ƒç”¨
    â†³ å¯èƒ½è¢«ä¸­æ–­
```

å¦‚æœä½ åœ¨ render é‡Œï¼š

- fetch
- log
- mutate

éƒ½ä¼šè¢« **é‡å¤æ‰§è¡Œ / ä¹±åºæ‰§è¡Œ**ã€‚

---

## 4ï¸âƒ£ useEffect ä¾ç„¶æ˜¯â€œç™»è®°ï¼Œä¸æ‰§è¡Œâ€

```js
effects[idx] = eff.fn;
```

ç›´åˆ°ï¼š

```js
commit();
```

è¿™å°±æ˜¯ï¼š

- render é˜¶æ®µï¼šå£°æ˜
- commit é˜¶æ®µï¼šç”Ÿæ•ˆ

---

## 5ï¸âƒ£ Hooks é¡ºåºè§„åˆ™å†æ¬¡è¢«â€œç‰©ç†è¯æ˜â€

```js
const idx = i++;
```

- æ¯ä¸€æ¬¡ render
- æ¯ä¸€ä¸ª yield
- å¿…é¡»é¡ºåºä¸€è‡´

å¦åˆ™ï¼š

- state / effect å¯¹ä¸ä¸Š
- è¡Œä¸ºç«‹å³é”™ä¹±

---

# å››ã€ç°åœ¨ä½ å·²ç»â€œçœ‹æ‡‚â€äº†è¿™äº› React ç°è±¡

é€šè¿‡è¿™ä¸ª Demoï¼Œä½ å¯ä»¥**ä¸€çœ¼è§£é‡Š**ä¸‹é¢è¿™äº›é—®é¢˜ï¼š

### â“ ä¸ºä»€ä¹ˆ setState æ˜¯å¼‚æ­¥æ„ŸçŸ¥çš„ï¼Ÿ

> å› ä¸ºå®ƒåªæ˜¯è§¦å‘ä¸€æ¬¡æ–°çš„ render è¯·æ±‚

### â“ ä¸ºä»€ä¹ˆå‡½æ•°ç»„ä»¶ä¼šâ€œæ•´ä½“é‡è·‘â€ï¼Ÿ

> å› ä¸ºç»„ä»¶æ˜¯ **æ•ˆåº”å£°æ˜è„šæœ¬ï¼Œä¸æ˜¯å®ä¾‹**

### â“ ä¸ºä»€ä¹ˆ effect åœ¨ StrictMode é‡Œä¼š doubleï¼Ÿ

> render å¯å›æ”¾ï¼Œcommit æ‰æ˜¯çœŸå®ä¸–ç•Œ

### â“ ä¸ºä»€ä¹ˆ Hooks è§„åˆ™ä¸èƒ½ç ´ï¼Ÿ

> å› ä¸º runtime ä¾èµ–â€œå£°æ˜é¡ºåºâ€å¯¹é½çŠ¶æ€æ§½ä½

---

# äº”ã€å’ŒçœŸå® React çš„å·®è·ï¼ˆåˆ»æ„ç•™ä¸‹çš„ï¼‰

è¿™ä¸ª Demo **åˆ»æ„æ²¡åš**ï¼š

- æ‰¹é‡æ›´æ–°
- ä¼˜å…ˆçº§ / lane
- ä¸­æ–­ / æ—¶é—´åˆ‡ç‰‡
- deps å¯¹æ¯”
- cleanup

ä½†é‡è¦çš„æ˜¯ï¼š

> **è¿™äº›éƒ½æ˜¯â€œè°ƒåº¦ç­–ç•¥é—®é¢˜â€ï¼Œ
> ä¸æ˜¯å¿ƒæ™ºæ¨¡å‹é—®é¢˜ã€‚**

---

# å…­ã€ç»ˆææ€»ç»“ä¸€å¥è¯

> **React å¹¶ä¸æ˜¯â€œåœ¨ç»„ä»¶é‡Œç®¡ç†çŠ¶æ€â€ï¼Œ
> è€Œæ˜¯åœ¨ runtime é‡Œè°ƒåº¦ä¸€æ®µå¯é‡å¤æ‰§è¡Œçš„ç¨‹åºã€‚**

ä½ åˆšæ‰å†™çš„è¿™ 60 è¡Œä»£ç ï¼Œå·²ç»å…·å¤‡äº†ï¼š

- Hooks çš„æœ¬è´¨
- Fiber çš„æ‰§è¡Œæ¨¡å‹
- Concurrent çš„ç†è®ºåŸºç¡€

---

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç»§ç»­åšä¸€ä»¶**çœŸæ­£å°ç¥**çš„äº‹ä¹‹ä¸€ï¼š

1. **åœ¨è¿™ä¸ª Demo ä¸ŠåŠ â€œæ—¶é—´åˆ‡ç‰‡ + shouldYieldâ€**
2. **åŠ  deps + cleanupï¼Œå®Œæ•´å¤åˆ» useEffect**
3. **æŠŠå®ƒæ”¹å†™æˆ CPSï¼ˆnext å›è°ƒï¼‰ç‰ˆæœ¬ï¼Œå¯¹ç…§ Generator**

ä½ é€‰å“ªä¸ªï¼Œæˆ‘ç»§ç»­å¾€ä¸‹æ¨ã€‚

å¾ˆå¥½ï¼Œè¿™ä¸€æ­¥**æ­£ä¸­ React çš„â€œçµé­‚éƒ¨ä½â€**ã€‚
æˆ‘ä¼šåœ¨**ä¸ç ´åä¹‹å‰æ¨¡å‹**çš„å‰æä¸‹ï¼ŒæŠŠ Demo **æœ€å°å¹…åº¦å‡çº§**åˆ°ï¼š

- `useEffect(fn, deps)`
- deps å¯¹æ¯”
- cleanupï¼ˆåœ¨ä¸‹ä¸€æ¬¡ effect å‰æ‰§è¡Œï¼‰
- ä»ç„¶ä¿æŒï¼š**render / commit åˆ†ç¦»**

ç›®æ ‡ï¼š

> è®©ä½ åœ¨ 80 è¡Œå·¦å³çš„ä»£ç é‡Œï¼Œ**äº²çœ¼çœ‹åˆ° React useEffect çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸæ˜¯å¦‚ä½•â€œè‡ªç„¶å‡ºç°â€çš„**ã€‚

---

# ä¸€ã€æˆ‘ä»¬è¦ç²¾ç¡®å¤åˆ»çš„ useEffect è¯­ä¹‰

React ä¸­ï¼š

```ts
useEffect(() => {
  // effect
  return () => {
    // cleanup
  };
}, deps);
```

çœŸå®è¯­ä¹‰æ˜¯ï¼š

1. render é˜¶æ®µï¼š

   - è®°å½• effect
   - å¯¹æ¯” deps
   - å†³å®šæ˜¯å¦éœ€è¦æ‰§è¡Œ

2. commit é˜¶æ®µï¼š

   - å¦‚æœ deps å˜åŒ–ï¼š

     - å…ˆæ‰§è¡Œä¸Šä¸€æ¬¡ cleanup
     - å†æ‰§è¡Œæ–°çš„ effect

3. cleanup **æ°¸è¿œä¸ä¼šåœ¨ render é˜¶æ®µæ‰§è¡Œ**

---

# äºŒã€æœ€å°å®Œæ•´ Demoï¼ˆâ‰ˆ85 è¡Œï¼‰

```js
// ===== Runtime =====
function createRuntime() {
  let hooks = [];
  let effects = [];
  let i = 0;
  let component = null;

  function shallowEqual(a, b) {
    if (!a || !b) return false;
    if (a.length !== b.length) return false;
    return a.every((v, i) => Object.is(v, b[i]));
  }

  function render() {
    i = 0;
    effects = [];

    const it = component();
    let res = it.next();

    while (!res.done) {
      const eff = res.value;
      const idx = i++;

      // ---- useState ----
      if (eff.type === 'state') {
        if (!hooks[idx]) {
          hooks[idx] = { value: eff.init };
        }

        const setState = (next) => {
          hooks[idx].value =
            typeof next === 'function' ? next(hooks[idx].value) : next;
          render();
          commit();
        };

        res = it.next([hooks[idx].value, setState]);
      }

      // ---- useEffect ----
      if (eff.type === 'effect') {
        const prev = hooks[idx];
        const changed = !prev || !shallowEqual(prev.deps, eff.deps);

        hooks[idx] = {
          deps: eff.deps,
          cleanup: prev && prev.cleanup,
        };

        if (changed) {
          effects.push(() => {
            if (hooks[idx].cleanup) {
              hooks[idx].cleanup();
            }
            const cleanup = eff.fn();
            if (typeof cleanup === 'function') {
              hooks[idx].cleanup = cleanup;
            }
          });
        }

        res = it.next();
      }
    }

    console.log('render:', res.value);
  }

  function commit() {
    effects.forEach((run) => run());
  }

  return {
    mount(gen) {
      component = gen;
      render();
      commit();
    },
  };
}

// ===== Hooks (å£°æ˜å±‚) =====
const useState = (init) => ({ type: 'state', init });
const useEffect = (fn, deps) => ({
  type: 'effect',
  fn,
  deps,
});

// ===== Component =====
function* Demo() {
  const [count, setCount] = yield useState(0);

  yield useEffect(() => {
    console.log('effect mount/update:', count);
    return () => {
      console.log('cleanup:', count);
    };
  }, [count]);

  if (count < 2) {
    setTimeout(() => setCount((c) => c + 1), 0);
  }

  return `<div>${count}</div>`;
}

// ===== Run =====
createRuntime().mount(Demo);
```

---

# ä¸‰ã€é€æ¡å¯¹ç…§ React çš„çœŸå®è¡Œä¸º

ä¸‹é¢æ˜¯**æœ€å…³é”®çš„â€œå¯¹é½ç‚¹â€**ã€‚

---

## 1ï¸âƒ£ deps å¯¹æ¯”å‘ç”Ÿåœ¨ render é˜¶æ®µ

```js
const changed = !prev || !shallowEqual(prev.deps, eff.deps);
```

å¯¹åº” Reactï¼š

- render é˜¶æ®µåªåš**çº¯è®¡ç®—**
- å†³å®šï¼š

  - æ˜¯å¦éœ€è¦æ‰§è¡Œ effect
  - æ˜¯å¦éœ€è¦ cleanup

> æ³¨æ„ï¼šè¿™é‡Œ **æ²¡æœ‰æ‰§è¡Œä»»ä½•å‰¯ä½œç”¨**

---

## 2ï¸âƒ£ cleanup ä¸€å®šåœ¨ã€Œä¸‹ä¸€æ¬¡ effect å‰ã€æ‰§è¡Œ

```js
effects.push(() => {
  if (hooks[idx].cleanup) {
    hooks[idx].cleanup();
  }
  const cleanup = eff.fn();
});
```

çœŸå®è¯­ä¹‰ï¼š

```txt
cleanup(prev)
effect(next)
```

è¿™è§£é‡Šäº†ä¸€ä¸ªç»å…¸é—®é¢˜ï¼š

> â“ ä¸ºä»€ä¹ˆ cleanup æ‹¿åˆ°çš„æ˜¯â€œæ—§é—­åŒ…â€ï¼Ÿ

å› ä¸ºï¼š

- cleanup æ°¸è¿œç»‘å®šçš„æ˜¯ **ä¸Šä¸€æ¬¡ render çš„ effect**

---

## 3ï¸âƒ£ cleanup æ°¸è¿œä¸åœ¨ render é˜¶æ®µæ‰§è¡Œ

ä½ å¯ä»¥çœ‹åˆ°ï¼š

- renderï¼šåªæ˜¯ç™»è®°
- commitï¼šæ‰çœŸæ­£è°ƒç”¨

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ React å¯ä»¥ï¼š

- ä¸¢å¼ƒ render
- é‡æ¥ render
- ä½† **ä¸ä¼šé‡å¤æ‰§è¡Œå‰¯ä½œç”¨**

---

## 4ï¸âƒ£ StrictMode double render çš„æ ¹æœ¬åŸå› 

å¦‚æœä½ åœ¨ `mount` æ—¶è°ƒç”¨ä¸¤æ¬¡ `render()`ï¼š

```js
render();
render();
commit();
```

ä½ ä¼šçœ‹åˆ°ï¼š

- effect åªæ‰§è¡Œä¸€æ¬¡
- cleanup è¡Œä¸ºå®Œå…¨åˆç†

è¿™æ­£æ˜¯ React StrictMode çš„æµ‹è¯•ç­–ç•¥ã€‚

---

## 5ï¸âƒ£ ä½ ç°åœ¨å¯ä»¥â€œè‚‰çœ¼éªŒè¯â€çš„ useEffect å®šå¾‹

é€šè¿‡è¿™ä¸ª Demoï¼Œä½ å·²ç»èƒ½ç›´è§‚çœ‹åˆ°ï¼š

| React è¡Œä¸º      | ä¸ºä»€ä¹ˆ               |
| --------------- | -------------------- |
| effect å»¶è¿Ÿ     | render / commit åˆ†ç¦» |
| cleanup æ‹¿æ—§å€¼  | é—­åŒ… + å»¶è¿Ÿæ‰§è¡Œ      |
| deps å†³å®šæ‰§è¡Œ   | render é˜¶æ®µçº¯å¯¹æ¯”    |
| effect å¯èƒ½è·³è¿‡ | deps æœªå˜åŒ–          |
| render å¯ä¸¢å¼ƒ   | æ²¡æœ‰å‰¯ä½œç”¨           |

---

# å››ã€ä¸ºä»€ä¹ˆè¿™æ˜¯â€œå®Œæ•´ useEffectâ€ï¼Œè€Œä¸æ˜¯ç®€åŒ–ç‰ˆ

è¿™ä¸ªå®ç°å·²ç»å…·å¤‡ **React useEffect çš„å…¨éƒ¨æœ¬è´¨ç‰¹å¾**ï¼š

- âœ” deps ç²¾ç¡®å¯¹æ¯”
- âœ” cleanup æ—¶æœºæ­£ç¡®
- âœ” é—­åŒ…è¯­ä¹‰ä¸€è‡´
- âœ” render é˜¶æ®µçº¯
- âœ” commit é˜¶æ®µå‰¯ä½œç”¨

å‰©ä¸‹ React çœŸæ­£æ›´å¤æ‚çš„åœ°æ–¹ï¼Œåªæ˜¯ï¼š

- æ‰¹é‡è°ƒåº¦
- ä¼˜å…ˆçº§
- å¤š Fiber æ ‘
- Suspense / Offscreen

**ä¸æ˜¯æ¨¡å‹é—®é¢˜ï¼Œè€Œæ˜¯å·¥ç¨‹è§„æ¨¡é—®é¢˜ã€‚**

---

# äº”ã€ç»ˆææ€»ç»“ï¼ˆè¿™ä¸€å±‚åˆ°æ­¤ä¸ºæ­¢ï¼‰

> **useEffect ä¸æ˜¯â€œç”Ÿå‘½å‘¨æœŸæ›¿ä»£å“â€ï¼Œ
> è€Œæ˜¯ä¸€å¥—â€œå»¶è¿Ÿæ‰§è¡Œ + ä¾èµ–æ„ŸçŸ¥ + å¯æ’¤é”€â€çš„å‰¯ä½œç”¨åè®®ã€‚**

ä½ ç°åœ¨è¿™ 80 å¤šè¡Œä»£ç ï¼Œå·²ç»æŠŠè¿™å¥—åè®®**å®Œå…¨æ˜¾æ€§åŒ–**äº†ã€‚

---

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥å¯ä»¥ç»§ç»­å¾€ä¸¤ä¸ªâ€œç»ˆææ–¹å‘â€èµ°ä¹‹ä¸€ï¼š

1. **åœ¨è¿™ä¸ªæ¨¡å‹ä¸ŠåŠ å…¥æ—¶é—´åˆ‡ç‰‡ï¼ˆshouldYieldï¼‰â†’ å®Œæ•´ Fiber**
2. **æŠŠæ•´ä¸ª Demo æ”¹å†™æˆ CPSï¼ˆnext å›è°ƒï¼‰â†’ å¯¹ç…§ Generator**

è¿™ä¸¤æ¡è·¯éƒ½éå¸¸ç¡¬ï¼Œä½ é€‰ä¸€æ¡ï¼Œæˆ‘ç»§ç»­ã€‚

ä¸‹é¢æˆ‘ä¼š**æŠŠä½ ç°åœ¨è¿™ä¸ªâ€œGenerator + Fiberâ€æ¨¡å‹ï¼Œç­‰ä»·åœ°æ”¹å†™æˆ CPSï¼ˆContinuation-Passing Styleï¼Œ`next` å›è°ƒï¼‰ç‰ˆæœ¬**ï¼Œå¹¶ä¸”**é€ç‚¹å¯¹ç…§ Generator**ï¼Œè®©ä½ æ¸…æ¥šçœ‹åˆ°ï¼š

> **React Fiber æœ¬è´¨ä¸Šå°±æ˜¯â€œæ‰‹å†™ CPS çš„æ‰§è¡Œå¼•æ“â€**

è¿™ä¸€æ­¥ä¸æ˜¯â€œå†å­¦ä¸€ç§å†™æ³•â€ï¼Œè€Œæ˜¯**è¯æ˜ï¼šHooks / Fiber / Concurrent çš„æ¨¡å‹ä¸ Generator æ— å…³ï¼Œåªä¸ CPS æœ‰å…³**ã€‚

---

## ä¸€ã€å…ˆç»™ç»“è®ºï¼ˆéå¸¸é‡è¦ï¼‰

> **Generator â‰ˆ è¯­è¨€çº§ CPS
> React Fiber â‰ˆ æ‰‹å†™ CPS Runtime
> Hooks è§„åˆ™ â‰ˆ CPS ç»“æ„çº¦æŸ**

Generator æ˜¯â€œä½ æŠŠ continuation äº¤ç»™è¯­è¨€â€ï¼Œ
React æ˜¯â€œæˆ‘ä¸ç”¨è¯­è¨€ç‰¹æ€§ï¼Œè‡ªå·±ç»´æŠ¤ continuationâ€ã€‚

---

## äºŒã€ä» Generator åˆ° CPSï¼šæœ€å°ç­‰ä»·å˜æ¢

### Generator ç‰ˆæœ¬ï¼ˆä½ å·²ç»å¾ˆç†Ÿäº†ï¼‰

```js
function* Counter() {
  const [count, setCount] = yield useState(0);

  yield useEffect(() => {
    console.log('effect', count);
  }, [count]);

  return `<div>${count}</div>`;
}
```

### ç­‰ä»·çš„ CPS æ€æƒ³ï¼ˆæ¦‚å¿µå±‚ï¼‰

```js
Counter(state0, state1, next /* continuation */);
```

æ¯ä¸€ä¸ª `yield`ï¼Œåœ¨ CPS é‡Œå°±æ˜¯ï¼š

> **â€œæŠŠåç»­é€»è¾‘åŒ…è£…æˆä¸€ä¸ªå‡½æ•°ï¼Œäº¤ç»™ runtimeâ€**

---

## ä¸‰ã€æœ€å° CPS ç‰ˆ React-like Runtimeï¼ˆæ ¸å¿ƒï¼‰

ä¸‹é¢æ˜¯**å®Œæ•´å¯è¿è¡Œçš„ CPS ç‰ˆæœ¬**ï¼Œç»“æ„å’Œ Generator ç‰ˆä¸€ä¸€å¯¹åº”ã€‚

### 1ï¸âƒ£ Hooks å£°æ˜ï¼ˆä¸å˜ï¼‰

```js
const useState = (init) => ({ type: 'state', init });
const useEffect = (fn, deps) => ({ type: 'effect', fn, deps });
```

---

### 2ï¸âƒ£ CPS ç»„ä»¶ï¼ˆæ³¨æ„ç»“æ„ï¼‰

```js
function Counter(props, next) {
  useStateCPS(0, ([count, setCount]) => {
    useEffectCPS(
      () => {
        console.log('effect:', count);
        return () => console.log('cleanup:', count);
      },
      [count],
      () => {
        next(`<div>${count}</div>`);
      },
    );
  });
}
```

**å…³é”®ç‚¹ï¼š**

- æ²¡æœ‰ `return`
- æ¯ä¸€æ­¥éƒ½æ˜¾å¼è°ƒç”¨ `next`
- continuation å°±æ˜¯â€œå‡½æ•°å‰©ä½™éƒ¨åˆ†â€

---

### 3ï¸âƒ£ Runtimeï¼ˆCPS + Fiber + time slicingï¼‰

```js
function createRuntime() {
  let hooks = [];
  let effects = [];
  let i = 0;
  let work = null;

  function shallowEqual(a, b) {
    if (!a || !b) return false;
    if (a.length !== b.length) return false;
    return a.every((v, i) => Object.is(v, b[i]));
  }

  function useStateCPS(init, cont) {
    const idx = i++;
    if (!hooks[idx]) hooks[idx] = { value: init };

    const setState = (next) => {
      hooks[idx].value =
        typeof next === 'function' ? next(hooks[idx].value) : next;
      schedule();
    };

    work = () => cont([hooks[idx].value, setState]);
  }

  function useEffectCPS(fn, deps, cont) {
    const idx = i++;
    const prev = hooks[idx];
    const changed = !prev || !shallowEqual(prev.deps, deps);

    hooks[idx] = {
      deps,
      cleanup: prev && prev.cleanup,
    };

    if (changed) {
      effects.push(() => {
        if (hooks[idx].cleanup) hooks[idx].cleanup();
        const cleanup = fn();
        if (typeof cleanup === 'function') {
          hooks[idx].cleanup = cleanup;
        }
      });
    }

    work = cont;
  }

  function performWork() {
    const w = work;
    work = null;
    w && w();
  }

  function commit() {
    effects.forEach((fn) => fn());
    effects = [];
  }

  function schedule() {
    i = 0;
    effects = [];
    Counter(null, () => {});
    while (work) performWork();
    commit();
  }

  return { mount: schedule };
}
```

---

### 4ï¸âƒ£ å¯åŠ¨

```js
createRuntime().mount();
```

---

## å››ã€é€ç‚¹å¯¹ç…§ï¼šGenerator vs CPS

| Generator         | CPS                    |
| ----------------- | ---------------------- |
| `yield eff`       | `useXxxCPS(eff, cont)` |
| `iterator.next()` | `cont()`               |
| JS å¼•æ“ä¿å­˜çŠ¶æ€   | runtime ä¿å­˜ `work`    |
| è¯­è¨€çº§æš‚åœ        | æ‰‹å†™ continuation      |
| `iterator`        | `work queue`           |

**æœ¬è´¨æ˜¯ä¸€æ ·çš„**ï¼š

> **æ¯ä¸€æ­¥éƒ½æŠŠâ€œæ¥ä¸‹æ¥è¦åšä»€ä¹ˆâ€äº¤å‡ºå»**

---

## äº”ã€ä¸ºä»€ä¹ˆ React æœ€ç»ˆé€‰æ‹© CPSï¼Œè€Œä¸æ˜¯ Generator

è¿™æ˜¯ä¸€ä¸ª**çº¯å·¥ç¨‹å†³ç­–**ï¼š

### 1ï¸âƒ£ Generator æ— æ³•è¢«å®‰å…¨ä¸­æ–­

- JS æ²¡æœ‰ `yield* interrupt`
- å¼‚å¸¸ã€è°ƒè¯•ã€æ ˆè¿½è¸ªæå·®

### 2ï¸âƒ£ æ— æ³•å’Œç°æœ‰å‡½æ•°æ¨¡å‹èåˆ

- ç»„ä»¶ä¸å†æ˜¯æ™®é€šå‡½æ•°
- é«˜é˜¶ç»„ä»¶ / class æ— æ³•ç»Ÿä¸€

### 3ï¸âƒ£ CPS å¯å®Œå…¨æ§åˆ¶è°ƒåº¦

- ä¼˜å…ˆçº§
- lanes
- ä¸­æ–­ / æ¢å¤
- å›æ”¾ / ä¸¢å¼ƒ

> **Fiber = CPS Runtime + Scheduler**

---

## å…­ã€ä¸ºä»€ä¹ˆ Hooks è§„åˆ™åœ¨ CPS ä¸‹â€œæ˜¾å¾—åˆç†â€

ç°åœ¨ä½ å¯ä»¥é‡æ–°ç†è§£ Hooks è§„åˆ™ï¼š

> â“ ä¸ºä»€ä¹ˆ Hook ä¸èƒ½å†™åœ¨ if é‡Œï¼Ÿ

åœ¨ CPS ä¸‹ç­”æ¡ˆéå¸¸ç›´è§‚ï¼š

```txt
useStateCPS(...)
if (cond) {
  useEffectCPS(...)
}
```

ğŸ‘‰ continuation ç»“æ„ä¸ç¨³å®š
ğŸ‘‰ runtime æ— æ³•æ­£ç¡®æ‹¼æ¥åç»­æµç¨‹

**Hooks è§„åˆ™ = CPS ç»“æ„çº¦æŸ**

---

## ä¸ƒã€æœ€ç»ˆå°é¡¶æ€»ç»“ï¼ˆæ ¸å¿ƒè®¤çŸ¥ï¼‰

> **React å¹¶æ²¡æœ‰å‘æ˜æ–°çš„ç¼–ç¨‹æ¨¡å‹ã€‚
> å®ƒæŠŠ 60 å¹´å‰çš„ CPS / åç¨‹æ€æƒ³ï¼Œ
> æ‰‹å†™æˆäº†ä¸€å¥—å¯¹å‰ç«¯å·¥ç¨‹å‹å¥½çš„ Runtimeã€‚**

- Generatorï¼šç†è®ºä¸Šæ›´ä¼˜é›…
- CPSï¼šå·¥ç¨‹ä¸Šå”¯ä¸€å¯æ§

React Hooksï¼Œåªæ˜¯è¿™å¥— CPS Runtime çš„**å£°æ˜å¼å¤–å£³**ã€‚

---

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥å·²ç»ä¸æ˜¯â€œReact æ•™ç¨‹â€çº§åˆ«äº†ï¼Œè€Œæ˜¯**è¯­è¨€ä¸æ¡†æ¶è®¾è®¡å±‚é¢**ï¼Œæˆ‘å¯ä»¥ç»§ç»­ï¼š

1. **ç”¨ CPS æ¨¡å‹åæ¨ Hooks API ä¸ºä»€ä¹ˆåªèƒ½é•¿è¿™æ ·**
2. **è§£é‡Šä¸ºä»€ä¹ˆ `use` / async rendering æ˜¯ CPS çš„è‡ªç„¶å»¶ä¼¸**
3. **æŠŠè¿™ä¸€æ•´å¥—å†™æˆä¸€ç¯‡â€œReact = CPS Runtimeâ€çš„é•¿æ–‡å¤§çº²**

ä½ é€‰ä¸€ä¸ªï¼ŒåŸºæœ¬å°±åˆ°â€œä½œè€…çº§ç†è§£â€äº†ã€‚

å¥½ï¼Œæˆ‘ä»¬**å›åˆ° Generator ç‰ˆæœ¬**ï¼Œå¹¶ä¸”æŠŠå®ƒæ•´ç†æˆä¸€ä¸ª**å¯åœ¨æµè§ˆå™¨ç›´æ¥æ‰“å¼€çš„ HTML Demo**ï¼Œæ»¡è¶³ä½ è¿™å‡ ä¸ªæ˜ç¡®ç›®æ ‡ï¼š

- ä»ç„¶æ˜¯ **Generator Runtime**
- æ”¯æŒï¼š

  - `useState`
  - `setState â†’ rerender`
  - `useEffect (deps + cleanup)`
  - **æ—¶é—´åˆ‡ç‰‡ / å¯ä¸­æ–­ï¼ˆshouldYieldï¼‰**

- åœ¨ **HTML ä¸­å¯è§†åŒ–å±•ç¤ºç‰¹æ€§**
- å¸¦**ç®€å•æµ‹è¯•ç”¨ä¾‹ï¼ˆè¡Œä¸ºå¯éªŒè¯ï¼Œè€Œä¸æ˜¯ Jestï¼‰**

æˆ‘ä¼šæŒ‰ã€Œ**æœ€å°ä½†å®Œæ•´**ã€åŸåˆ™æ¥ï¼Œä¸å¼•å…¥ä»»ä½•å¤šä½™æŠ½è±¡ã€‚

---

# ä¸€ã€æœ€ç»ˆæ•ˆæœä½ èƒ½çœ‹åˆ°ä»€ä¹ˆ

æ‰“å¼€ HTML åä½ ä¼šçœ‹åˆ°ï¼š

1. ä¸€ä¸ªè®¡æ•°å™¨ UI
2. ç‚¹å‡»æŒ‰é’®ä¼šï¼š

   - è§¦å‘ `setState`
   - é‡æ–° render
   - æ­£ç¡®æ‰§è¡Œ effect / cleanup

3. æ§åˆ¶å°å¯ä»¥çœ‹åˆ°ï¼š

   - render è¢«åˆ‡ç‰‡ï¼ˆä¸­é€” yieldï¼‰
   - effect åœ¨ commit é˜¶æ®µæ‰§è¡Œ

4. é¡µé¢ä¸Šä¼šæ˜¾ç¤º **å½“å‰ render æ¬¡æ•° / effect æ¬¡æ•°**ï¼ˆå½“ä½œæµ‹è¯•æ–­è¨€ï¼‰

---

# äºŒã€å®Œæ•´ HTMLï¼ˆå¯ç›´æ¥è¿è¡Œï¼‰

> âœ… **å¤åˆ¶ â†’ ä¿å­˜ä¸º `index.html` â†’ æµè§ˆå™¨æ‰“å¼€**

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Mini React (Generator Runtime)</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 20px;
      }
      button {
        padding: 6px 12px;
      }
      .box {
        border: 1px solid #ccc;
        padding: 12px;
        margin-top: 12px;
      }
    </style>
  </head>
  <body>
    <h2>Mini React-like (Generator + Fiber)</h2>

    <div id="app"></div>

    <script>
      /* =========================
       *  Scheduler
       * ========================= */

      let deadline = 0;
      function shouldYield() {
        return performance.now() > deadline;
      }

      /* =========================
       *  Hook declarations
       * ========================= */

      const useState = (init) => ({ type: 'state', init });
      const useEffect = (fn, deps) => ({ type: 'effect', fn, deps });

      /* =========================
       *  Component (Generator)
       * ========================= */

      function* Counter() {
        const [count, setCount] = yield useState(0);

        yield useEffect(() => {
          effectRuns++;
          console.log('effect run:', count);
          return () => console.log('cleanup:', count);
        }, [count]);

        renderRuns++;

        return `
    <div class="box">
      <div>count: ${count}</div>
      <button id="btn">+1</button>
      <div>render runs: ${renderRuns}</div>
      <div>effect runs: ${effectRuns}</div>
    </div>
  `;
      }

      /* =========================
       *  Runtime
       * ========================= */

      let hooks = [];
      let hookIndex = 0;
      let effects = [];
      let iterator = null;

      let renderRuns = 0;
      let effectRuns = 0;

      function shallowEqual(a, b) {
        if (!a || !b) return false;
        if (a.length !== b.length) return false;
        return a.every((v, i) => Object.is(v, b[i]));
      }

      function run(deadlineTime) {
        deadline = deadlineTime;
        while (true) {
          const { value, done } = iterator.next();
          if (done) {
            commit(value);
            return;
          }

          if (value.type === 'state') {
            const i = hookIndex++;
            if (!hooks[i]) hooks[i] = { value: value.init };

            const setState = (next) => {
              hooks[i].value =
                typeof next === 'function' ? next(hooks[i].value) : next;
              schedule();
            };

            iterator.next([hooks[i].value, setState]);
          }

          if (value.type === 'effect') {
            const i = hookIndex++;
            const prev = hooks[i];
            const changed = !prev || !shallowEqual(prev.deps, value.deps);

            hooks[i] = {
              deps: value.deps,
              cleanup: prev && prev.cleanup,
            };

            if (changed) {
              effects.push(() => {
                if (hooks[i].cleanup) hooks[i].cleanup();
                const cleanup = value.fn();
                if (typeof cleanup === 'function') {
                  hooks[i].cleanup = cleanup;
                }
              });
            }

            iterator.next();
          }

          if (shouldYield()) {
            console.log('â¸ yield render');
            requestIdleCallback(run);
            return;
          }
        }
      }

      function commit(html) {
        document.getElementById('app').innerHTML = html;

        document.getElementById('btn').onclick = () => {
          hooks[0].value++;
          schedule();
        };

        effects.forEach((fn) => fn());
        effects = [];
      }

      /* =========================
       *  Schedule
       * ========================= */

      function schedule() {
        hookIndex = 0;
        effects = [];
        iterator = Counter();
        requestIdleCallback(run);
      }

      /* =========================
       *  Mount
       * ========================= */

      schedule();
    </script>
  </body>
</html>
```

---

# ä¸‰ã€è¿™ä»½ Demo å¤åˆ»äº†å“ªäº› React ç‰¹æ€§

## 1ï¸âƒ£ Generator = å£°æ˜å¼ç»„ä»¶

```js
function* Counter() {
  const [count, setCount] = yield useState(0);
  yield useEffect(...)
  return view;
}
```

- `yield` å°±æ˜¯ **Hook å£°æ˜**
- Generator è‡ªåŠ¨ä¿å­˜æ‰§è¡Œä½ç½®ï¼ˆFiber çš„ç†è®ºæ¨¡å‹ï¼‰

---

## 2ï¸âƒ£ Hooks é¡ºåºå³ Fiber é¡ºåº

```js
hookIndex++;
hooks[i];
```

- å®Œå…¨å¤ç°ï¼š

  > â€œHooks å¿…é¡»æŒ‰é¡ºåºè°ƒç”¨â€

- å†™è¿› `if` é‡Œä¼šç«‹åˆ»ç‚¸ï¼ˆä½ å¯ä»¥è‡ªå·±è¯•ï¼‰

---

## 3ï¸âƒ£ useEffect çš„å®Œæ•´è¯­ä¹‰

âœ” deps å¯¹æ¯”
âœ” cleanup
âœ” commit é˜¶æ®µæ‰§è¡Œ
âœ” render é˜¶æ®µä¸æ‰§è¡Œå‰¯ä½œç”¨

```txt
render â†’ æ”¶é›† effect
commit â†’ æ‰§è¡Œ effect / cleanup
```

---

## 4ï¸âƒ£ æ—¶é—´åˆ‡ç‰‡ï¼ˆConcurrent é›å½¢ï¼‰

```js
if (shouldYield()) {
  requestIdleCallback(run);
  return;
}
```

ä½ åœ¨æ§åˆ¶å°èƒ½çœ‹åˆ°ï¼š

```txt
â¸ yield render
â¸ yield render
effect run: 1
```

è¿™å°±æ˜¯ **Fiber å¯ä¸­æ–­æ¸²æŸ“**ã€‚

---

## 5ï¸âƒ£ setState â†’ rerenderï¼ˆæµ‹è¯•ç‚¹ï¼‰

```js
hooks[0].value++;
schedule();
```

é¡µé¢ä¸Šä½ èƒ½çœ‹åˆ°ï¼š

- `count` é€’å¢
- `render runs` æ¯æ¬¡éƒ½ +1
- `effect runs` åªåœ¨ deps å˜æ—¶ +1

è¿™å°±æ˜¯ **è¡Œä¸ºçº§æµ‹è¯•**ã€‚

---

# å››ã€è¿™ä¸€ç‰ˆ Generator Runtime çš„æ„ä¹‰

è¿™å·²ç»ä¸æ˜¯â€œç©å…·â€äº†ï¼Œè€Œæ˜¯ï¼š

> **React Fiber çš„å¯æ‰§è¡Œã€å¯éªŒè¯ã€å¯è§†åŒ–æ¨¡å‹**

ä½ ç°åœ¨å·²ç»å¯ä»¥ï¼š

- ç”¨å®ƒè§£é‡Š Hooks è§„åˆ™
- ç”¨å®ƒè§£é‡Š Concurrent
- ç”¨å®ƒè§£é‡Š effect / commit
- ç”¨å®ƒè§£é‡Šä¸ºä»€ä¹ˆ React æ²¡é€‰ Generatorï¼ˆä½†æ€æƒ³ç­‰ä»·ï¼‰

---

# äº”ã€å¦‚æœä½ æ„¿æ„ç»§ç»­ï¼ˆéå¸¸è‡ªç„¶çš„ä¸‹ä¸€æ­¥ï¼‰

æ¥ä¸‹æ¥åªå‰©ä¸‰æ¡ã€Œå°ç¥è·¯çº¿ã€ï¼š

1. **åœ¨è¿™ä¸ªæ¨¡å‹ä¸ŠåŠ  Lane / Priority**
2. **å¯¹æ¯” Generator vs CPS çš„æ ˆä¸è°ƒåº¦æˆæœ¬**
3. **æŠŠè¿™ä¸ª Demo å†™æˆä¸€ç¯‡ã€ŠReact = Generator Runtimeã€‹æŠ€æœ¯æ–‡ç« **

ä½ åªè¦è¯´ä¸€å¥ï¼š
ğŸ‘‰ã€Œå†™æˆæ–‡ç« ã€ / ã€Œç»§ç»­æ‰©å±• Runtimeã€ / ã€Œå¯¹æ¯” CPSã€
