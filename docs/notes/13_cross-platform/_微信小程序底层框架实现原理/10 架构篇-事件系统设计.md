## å‰è¨€

æœ¬ç« å†…å®¹åˆ†è§£ï¼š
- webæ™®é€šäº‹ä»¶åŸç†
- å°ç¨‹åºäº‹ä»¶ç³»ç»Ÿæºç è§£è¯»
- å°ç¨‹åºçº¿ç¨‹é€šè®¯åè®®

## äº‹ä»¶ç³»ç»Ÿ

å›é¡¾ä¸€ä¸‹å¾®ä¿¡å°ç¨‹åºçš„åŒçº¿ç¨‹æ¶æ„è®¾è®¡ï¼Œæˆ‘ä»¬åœ¨WXMLä¸­è¿›è¡Œäº‹ä»¶ç»‘å®šï¼Œå‡è®¾æˆ‘ä»¬ç»‘å®šä¸€ä¸ªTapäº‹ä»¶å’Œmottoå‚æ•°åœ¨WXMLä¸­å¦‚ä¸‹ï¼š

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/668eccefa1214a6e807999f6b71558ea~tplv-k3u1fbpfcp-watermark.image)

ç„¶åæˆ‘ä»¬åœ¨.jsæ–‡ä»¶ä¸­è¿›è¡Œå£°æ˜å¤„ç†å‡½æ•°å’Œdata:

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/49640da7eaa142a5b0f16aeb64ba183e~tplv-k3u1fbpfcp-watermark.image)

è¿™æ ·çš„è¯å°ç¨‹åºå½“å‰é¡µé¢ä¸Šä¼šæœ‰ä¸€ä¸ª`Hello Wrold`æ–‡æœ¬å±•ç¤ºï¼Œå¹¶ä¸”ç‚¹å‡»æ­¤æ–‡æœ¬åï¼Œæ–‡æœ¬å†…å®¹å°†ä¼šæ›´æ”¹ä¸º`Clicked!!`ã€‚å¹¶ä¸”ç»‘å®šå‡½æ•°æœ‰ä¸€ä¸ªå‚æ•°eventï¼Œæ‰“å°å¦‚ä¸‹ï¼š

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4741ae30d42f483185a366fa4786385d~tplv-k3u1fbpfcp-watermark.image)

è¿™é‡Œä¼šæœ‰ä¸€ä¸ªç–‘é—®ğŸ¤”ï¸ï¼Œåœ¨å°ç¨‹åºæ¶æ„ä¸­WXMLåœ¨è§†å›¾çº¿ç¨‹è¿›è¡Œæ¸²æŸ“ï¼Œ.jsæ–‡ä»¶åœ¨é€»è¾‘çº¿ç¨‹è¿›è¡Œè§£æè¿è¡Œã€‚å¹¶ä¸åœ¨ä¸€ä¸ªçº¿ç¨‹ã€‚ä»–ä»¬ä¹‹é—´æ˜¯å¦‚ä½•è¿›è¡Œç»‘å®šçš„å‘¢ï¼Ÿæ¯”è¾ƒæµ…æ˜¾çš„ç†è§£å°±æ˜¯ç±»å‹vueä¸€æ ·çš„åŒå‘ç»‘å®šã€‚é‚£ä¹ˆæˆ‘ä»¬å°±å¸¦ç€è¿™ä¸ªç–‘é—®è¿›è¡Œé€æ­¥è§£æã€‚

## äº‹ä»¶ç³»ç»Ÿ

ä»€ä¹ˆæ˜¯äº‹ä»¶ï¼Ÿ

- äº‹ä»¶æ˜¯è§†å›¾å±‚åˆ°é€»è¾‘å±‚çš„é€šè®¯æ–¹å¼ã€‚
- äº‹ä»¶å¯ä»¥å°†ç”¨æˆ·çš„è¡Œä¸ºåé¦ˆåˆ°é€»è¾‘å±‚è¿›è¡Œå¤„ç†ã€‚
- äº‹ä»¶å¯ä»¥ç»‘å®šåœ¨ç»„ä»¶ä¸Šï¼Œå½“è¾¾åˆ°è§¦å‘äº‹ä»¶ï¼Œå°±ä¼šæ‰§è¡Œé€»è¾‘å±‚ä¸­å¯¹åº”çš„äº‹ä»¶å¤„ç†å‡½æ•°ã€‚
- äº‹ä»¶å¯¹è±¡å¯ä»¥æºå¸¦é¢å¤–ä¿¡æ¯ï¼Œå¦‚ `id`, `dataset`, `touches`ã€‚

äº‹ä»¶å¯ä»¥ç»‘å®šåœ¨ç»„ä»¶ä¸Šï¼Œåœ¨`Exparser`ç»„ä»¶ç³»ç»Ÿç« èŠ‚çš„æ—¶å€™æˆ‘ä»¬è®²è§£åˆ°äº†`Shadow DOM`çš„äº‹ä»¶ç³»ç»Ÿã€‚

è¿™é‡Œæˆ‘ä»¬ç¼•æ¸…ä¸€ä¸‹æ€è·¯ï¼Œä¸Šé¢çš„`WXML`ä¾‹å­ä¸­ï¼Œä»åº•å±‚é€»è¾‘ä¸Šæ¥è®²ï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰è¿›è¡Œäº‹ä»¶ç»‘å®šï¼Œæˆ‘ä»¬åªä¸è¿‡åœ¨å°ç¨‹åºçš„`WXML`ç»“æ„ä¸­å£°æ˜äº†ä¸€ä¸ª`é”®å€¼å¯¹`è€Œå·²ã€‚å› ä¸ºWXMLéœ€è¦ç»è¿‡å‡ é“å·¥åºçš„å¤„ç†ï¼Œå¤„ç†æˆ`HTML`ç»“æ„æ‰å¯ä»¥å®Œæˆäº‹ä»¶ç»‘å®šã€‚æ‰€ä»¥è¿™é‡Œè¦è®°å¥½è¿™ä¸ªæ¦‚å¿µã€‚

éšåæˆ‘ä»¬å°†WXMLè¿›è¡Œ`virtualDOMç¼–è¯‘`ï¼Œè¿™é‡Œçš„ç¼–è¯‘å°±æ˜¯virtualDOMç« èŠ‚ä¸­æˆ‘ä»¬ä½¿ç”¨è¿‡çš„$gwxå‡½æ•°ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æˆ‘ä»¬å£°æ˜çš„tapé”®å€¼å¯¹ç¼–è¯‘åœ¨äº†å“ªé‡Œã€‚

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/74124d05335641c3bf7b4841868dfe35~tplv-k3u1fbpfcp-watermark.image)

å¯ä»¥çœ‹åˆ°æ‰¾åˆ°æˆ‘ä»¬å£°æ˜äº‹ä»¶æ ‡è®°çš„å±‚çº§ä¸­ï¼Œattrå±æ€§å†…éƒ¨æœ‰bindtap: bindTextTapé”®å€¼å¯¹ã€‚é‚£ä¹ˆè¿™ä¸ªDOMç»“æ„æ˜¯æ€ä¹ˆè¿›è¡Œäº‹ä»¶è§£æçš„å‘¢ï¼Ÿ

è§£æçš„ç®—æ³•åœ¨åº•å±‚åŸºç¡€åº“WAWebview.jsæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬ç°åœ¨æ­¤æå‰è§£æä¸€ä¸‹äº‹ä»¶æ¨¡å—å®Œæ•´çš„æµç¨‹ï¼Œä¸ºäº†é˜²æ­¢åˆ°åé¢åº•å±‚åŸºç¡€åº“ç« èŠ‚å†è®²çš„è¯ï¼ŒçŸ¥è¯†å½¢æˆä¸äº†é—­ç¯ã€‚

æˆ‘è¿™é‡Œè§£æçš„åŸºç¡€åº“ç‰ˆæœ¬ä¸º`2.11.0`ã€‚

åº•å±‚åŸºç¡€åº“ä¸­è§£æ`virtualDOM`å‡½æ•°`applyProperties`æºç å¦‚ä¸‹ï¼Œ`attr`å±æ€§è§£æï¼ŒåŒ…å«äº‹ä»¶è§£æã€‚

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a0f8d150d00245da841df3288ffd51f8~tplv-k3u1fbpfcp-watermark.image)

è¿”å›çš„lå‡½æ•°æºç ï¼š

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9dcf41cfaf084799a3f450609f252f5b~tplv-k3u1fbpfcp-watermark.image)

å¯ä»¥çœ‹åˆ°`applyProperties`ä¸­æœ‰ä¸€ä¸ª`forIn`å¾ªç¯å»éå†`virtualDOM`ä¸­çš„`attr`å±æ€§ã€‚ç„¶åæ‰§è¡Œ`e`å‡½æ•°ã€‚è¿™é‡Œå¯çŸ¥`e`å‡½æ•°çš„å‚æ•°åŠä¸º`attr`å¯¹è±¡ä¸­çš„å±æ€§åç§°`key`ã€‚

eå‡½æ•°ä¸­æœ‰å¾ˆå¤šçš„ifï¼Œæ˜¯ç”¨æ¥åˆ¤æ–­ç‰¹æ®Šçš„å±æ€§åç§°çš„ï¼Œæˆ‘ä»¬ç»‘å®šçš„tapäº‹ä»¶é”®å€¼å¯¹æ˜¯`bindtap: bindTextTap`ï¼Œkeyä¹Ÿå°±æ˜¯bindtapï¼Œäº‹ä»¶ç»‘å®šçš„å‰ç¼€æœ‰å¾ˆå¤šæ¯”å¦‚bindã€catchï¼Œçœ‹åˆ°ç¬¬10è¡Œå·¦å³çš„ifä¸­ç”¨æ­£åˆ™`if (n = e.match(/^(capture-)?(mut-)?(bind|catch):?(.+)$/))`åˆ¤æ–­atträ¸­çš„å±æ€§åæ˜¯å¦ä¸ºäº‹ä»¶å±æ€§ã€‚å¦‚æœæ˜¯äº‹ä»¶å±æ€§çš„è¯æ‰§è¡ŒEå‡½æ•°ï¼Œå¹¶ä¸”è½¬æ¢ä¸ºexparserç»„ä»¶ç³»ç»Ÿä¸­çš„attrå±æ€§åç§°`exparser:info-attr-`ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è§£æåˆ°äº‹ä»¶attrå±æ€§ååï¼ŒEå‡½æ•°åšäº†ä»€ä¹ˆï¼ŒEå‡½æ•°æºç å¦‚ä¸‹ï¼š

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cb72bd4927f6408390a3e35af26ca277~tplv-k3u1fbpfcp-watermark.image)

å¯ä»¥çœ‹åˆ°Eå‡½æ•°ä¸­é¦–å…ˆé€šè¿‡`addListener`æ–¹æ³•è¿›è¡Œäº†äº‹ä»¶ç»‘å®šï¼Œè¿™ä¸ªæ–¹æ³•ä¹Ÿæ˜¯å°è£…è‡ªæˆ‘ä»¬ç†ŸçŸ¥çš„` window.addEventListener`ï¼Œåªä¸è¿‡tapä¸åŸç”Ÿclickæ–¹æ³•ä¹‹é—´æœ‰ä¸€å±‚æ˜ å°„å…³ç³»ã€‚`addListener`çš„äº‹ä»¶è§¦å‘çš„å›è°ƒå‡½æ•°ä¸­ç»„è£…äº†å‡½æ•°çš„eventä¿¡æ¯å€¼ï¼Œå¹¶ä¸”è§¦å‘äº†sendDataæ–¹æ³•ï¼Œæ–¹æ³•æ ‡è®°ä¸ºSYNC_EVENT_NAME.WX_EVENTï¼Œåœ¨æºç ä¸­å€¼ä¸º11ã€‚

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d48a93518a9b4901bf84f36b398a440d~tplv-k3u1fbpfcp-watermark.image)

è¿™æ ·çš„è¯åªè¦tapäº‹ä»¶è§¦å‘çš„è¯ï¼Œå°±ä¼šè°ƒç”¨è¿™ä¸ªå›è°ƒæ–¹æ³•ã€‚

è¿™é‡Œæˆ‘è¿˜æŠŠä¸Šé¢æˆ‘ä»¬æ‰“å°çš„eventä¿¡æ¯å€¼ä¸è¿™é‡Œçš„cå¯¹è±¡è¿›è¡Œæ¯”å¯¹ï¼Œå¦‚ä¸‹ï¼š

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b208d37f7b6441fa9e2f03fef37aadd9~tplv-k3u1fbpfcp-watermark.image)

å¯ä»¥çœ‹åˆ°æ•°æ®ç»“æ„æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯æ³¨æ„ï¼Œç›®å‰åœ¨è§¦å‘sanDataæ–¹æ³•ä¹‹å‰è¿™äº›é€»è¾‘çš„è§£æåŒ…æ‹¬eventå‚æ•°çš„ç»„è£…éƒ½æ˜¯åœ¨æ¸²æŸ“å±‚çš„åº•å±‚åŸºç¡€åº“WAWebview.jsä¸­å®Œæˆçš„ï¼Œä¹Ÿå°±æ˜¯è¯´è¿˜åœ¨æ¸²æŸ“çº¿ç¨‹ä¸­ã€‚

é‚£ä¹ˆæ²¡æœ‰é”™ï¼ŒsendDataæ–¹æ³•å°±æ˜¯å‘é€»è¾‘çº¿ç¨‹å‘é€eventæ•°æ®çš„æ–¹æ³•ã€‚

ä¸¤çº¿ç¨‹ä¹‹é—´çš„é€šè®¯é€»è¾‘è®²è§£æ”¾åœ¨äº†ä¸‹ä¸€ç« èŠ‚ã€‚è¿™é‡Œå¹¶ä¸å½±å“äº‹ä»¶ç³»ç»Ÿçš„é€»è¾‘é—­ç¯ï¼Œæˆ‘ä»¬æ•´ç†ä¸€ä¸‹æµç¨‹å¹¶ç»§ç»­åˆ†æã€‚

![äº‹ä»¶ç³»ç»Ÿ-æ¸²æŸ“å±‚æµç¨‹å›¾.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ea3bd75174b042baac4641bf44841d4c~tplv-k3u1fbpfcp-watermark.image)

äº‹ä»¶ç»‘å®šå®Œäº†ï¼Œé‚£ä¹ˆç”¨æˆ·è§¦å‘çš„æµç¨‹æ˜¯æ€æ ·çš„ï¼Œæˆ‘ä»¬ç»§ç»­æ¢ç´¢ã€‚

å‰é¢æˆ‘ä»¬æåˆ°å°ç¨‹åºçš„äº‹ä»¶éƒ½æ˜¯å’ŒjsåŸç”Ÿäº‹ä»¶ç›¸äº’è½¬æ¢çš„ï¼Œå°ç¨‹åºçš„tapäº‹ä»¶åº•å±‚æ˜¯ç”±webçš„mouseupäº‹ä»¶è½¬æ¢æ¥çš„ï¼Œå°ç¨‹åºtapäº‹ä»¶çš„è§¦å‘åˆ†ä¸ºå‡ ä¸ªè¿‡ç¨‹ï¼Œé¦–å…ˆåº•å±‚å®ç°æ˜¯ç”¨webçš„mouseupäº‹ä»¶è§¦å‘äº†tapäº‹ä»¶ï¼Œåº•å±‚ä¸ºwindowç»‘å®šæ•è·é˜¶æ®µçš„mouseupäº‹ä»¶ã€‚

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9f0cc174deca43fea5c49bcc76e2e5b7~tplv-k3u1fbpfcp-watermark.image)

åœ¨æºç 26012è¡Œä¸­å¯ä»¥æ‰¾åˆ°mouseupäº‹ä»¶çš„åŸç”Ÿç›‘å¬æ–¹æ³•ï¼Œå¦‚æœç”¨æˆ·è§¦å‘çš„è¯å°†æ‰§è¡Œå‡½æ•°Eï¼Œå‡½æ•°Sï¼Œå‡½æ•°Lã€‚è¿™é‡Œçš„å‡½æ•°Eå¹¶ä¸æ˜¯å‰é¢ç»‘å®šå‡½æ•°çš„å‡½æ•°Eï¼Œå› ä¸ºæ˜¯å‹ç¼©ä»£ç ï¼Œè¿™é‡Œä¸è¦ç†è§£é”™äº†ã€‚

çœ‹ä¸€ä¸‹å‡½æ•°Eæºç ï¼Œå†…éƒ¨è¿”å›ä¸€äº›åæ ‡ä¿¡æ¯ã€ç›®æ ‡å…ƒç´ ä¿¡æ¯ç­‰ã€‚

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/97a334d5b2404e389cf46bc53cd061c4~tplv-k3u1fbpfcp-watermark.image)

ä¸»è¦çœ‹å‡½æ•°Sæºç ï¼š

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b1ab0803e4e2431788b3a28a0e447314~tplv-k3u1fbpfcp-watermark.image)

å‡½æ•°Sç»„è£…äº†äº‹ä»¶eventå‚æ•°ä¸­çš„å‡ ä¸ªå‚æ•°ï¼Œå›é¡¾ä¸€ä¸‹æ˜¯è¿™å‡ ä¸ªå‚æ•°ï¼š

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b31b41c7b4d44b34a74c0b686d3bdf9d~tplv-k3u1fbpfcp-watermark.image)

ç„¶åå‡½æ•°Sè¿”å›äº†å‡½æ•°Cï¼š

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8ceab18e61bb429196bb5b30f62213ba~tplv-k3u1fbpfcp-watermark.image)

è¿™é‡Œé‡ç‚¹æ¥äº†ï¼Œå‡½æ•°Cä¸­åˆ›å»ºä¸€ä¸ªexparseräº‹ä»¶ï¼Œå…¶ä¸­iä¸ºäº‹ä»¶åï¼Œtapäº‹ä»¶å€¼å°±æ˜¯tapï¼Œaä¸ºmouseäº‹ä»¶å¯¹è±¡çš„pageXå’ŒpageYç»„æˆçš„å¯¹è±¡

å‡½æ•°Cçš„è¿”å›å€¼è§¦å‘ç›®æ ‡å…ƒç´ çš„exparseräº‹ä»¶ï¼Œé€šè¿‡`exparser.Event.dispatchEvent`æ–¹æ³•ï¼Œæ‰§è¡Œè¿™ä¸ªæ–¹æ³•å°±ä¼šèµ°exparseräº‹ä»¶ç³»ç»Ÿçš„æµç¨‹ã€‚çœ‹åˆ°è¿™é‡Œå¿˜äº†çš„å¯ä»¥å›é¡¾ä¸€ä¸‹exparserç»„ä»¶ç³»ç»Ÿç« èŠ‚ã€‚

è¿™æ ·çš„è¯å°±è¿›è¡Œäº†å®Œæ•´çš„è§¦å‘äº‹ä»¶ç¯èŠ‚ï¼Œè¡¥å……ä¸€ä¸‹æµç¨‹å›¾

![äº‹ä»¶ç³»ç»Ÿ-æ¸²æŸ“å±‚æµç¨‹å›¾çš„å‰¯æœ¬.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b58e0e358c4340688f3f16fbef30158c~tplv-k3u1fbpfcp-watermark.image)

sanDataè§¦å‘å°ç¨‹åºçº¿ç¨‹ä¸çº¿ç¨‹ä¹‹é—´çš„é€šè®¯åŠŸèƒ½ï¼Œæå‰äº†è§£é€šè®¯åè®®å¦‚ä¸‹ï¼š

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/abc6d700b69f47769b488feed341fbad~tplv-k3u1fbpfcp-watermark.image)

é€šè¿‡é€šè®¯åè®®å‘é€ç»™é€»è¾‘å±‚ã€‚

é‚£ä¹ˆæ—¢ç„¶æœ‰é€šè®¯åè®®äº†ï¼Œåé¢å°±éœ€è¦äº†è§£ä¸€ä¸‹å°ç¨‹åºçš„sendDataèƒŒåçš„é€šè®¯ç³»ç»Ÿæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œäº†è§£è¿‡åç»§ç»­å®Œæˆæ•°æ®å¤„ç†å¹¶ä¸”è¿”å›æ–°çš„dataè§¦å‘é¡µé¢çš„é‡æ–°æ¸²æŸ“ã€‚è®©æˆ‘ä»¬æ¥ç»§ç»­ä¸‹ä¸€ç« èŠ‚ã€‚


