## 前言

顺着上节的双线程思路，我们正式进入渲染层章节。下面我都将用用原生小程序语法来将一些设计形式，由设计形式深入线程源码章节。

本章节内容分解：

- WXML语法解读
- WXML语法设计思路
- WXSS语法概念

## WXML语法结构

首先我们需要下载[微信开发者工具](https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html)。

打开开发者工具后，首先```新建一个项目```，选择左侧菜单中```小程序按钮```，点击右侧```加号```进行```创建```。

![](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e5f807cd48504fada829bb1f8f7fae72~tplv-k3u1fbpfcp-watermark.image)

创建的时候需要填写一些信息，比如```路径```、```APPID```等。待创建完成后，你会看到和下方一样的官方界面。我们通过官方给的这个基础项目来慢慢的深入了解。
 
![](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f8fe0259c1de4d32aaa0e07b8ed80cf7~tplv-k3u1fbpfcp-watermark.image)

我们可以直接在微信开发者工具中查看到渲染出来的```页面```、```项目目录结构```、```控制台```等。此处的控制台操作与平常开发中使用的浏览器的控制台十分相似。

在项目目录结构中可以看到```/pages```中分为两个页面结构。```index```、```logs```。```index```则为上面看到的入口页面，点击头像会跳转至```logs操作日志页面```。

这里顺便提一下其中的```app.js```文件，打开根目录的小程序实例注册文件```app.js```。文件中App实例方法有绑定`生命周期回调函数`、`错误监听`和`页面不存在监听函数`、`全局参数`等等。结构如下：

![](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d5902a96378c4bebb2012e4ffea1773d~tplv-k3u1fbpfcp-watermark.image)

可以看到除了生命周期之类的回调函数，调用了很多```wx.xx```的方法，开发过公众号h5点同学应该很熟悉，微信```SDK API```。微信集成了很多方法以```SDK```的方式开放给开发者来使用，正是以```wx.``` 的方式调用。小程序中也是一样的，但是api多了很多，放这里一个[传送门](https://developers.weixin.qq.com/miniprogram/dev/api/) 。

在大概了解了基础目录结构之后，我们具体看一下```WXML```文件。

网页编程一般采用的是```HTML + CSS + JS```的组合，其中 ```HTML``` 是用来描述当前这个页面的结构，```CSS``` 用来描述页面的样子，```JS``` 通常是用来处理这个页面和用户的交互。

同样道理，在小程序中也有同样的角色，其中 ```WXML``` 充当的就是类似 ```HTML``` 的角色。打开``` pages/index/index.wxml```目录后，你会看到如下的内容:

![](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2b95a804efe546e8831b6d0e9105cee1~tplv-k3u1fbpfcp-watermark.image)

一眼看上去之后，是不是有种感觉，文件结构与HTML类似，与```VUE```更像，一些语法类似```wx:if ```这样的写法也有很多，都是这样写在模版文件中的。

但是还有很多不一样的地方，可以很明显的看到的是```<View />```标签。我们没有在别的文件中见过这样的标签，再看看其他微信小程序自带的一些组件写法```<block />```、```<text />```等等。那么这些是什么呢。

这是小程序框架设计的一套标签语言，结合小程序的基础组件、事件系统，可以构建出页面的结构。
```WXML``` 文件后缀名是 ```.wxml``` ，简单的 WXML语句在语法上同 HTML 非常相似。WXML 要求标签必须是严格闭合的，没有闭合将会导致编译错误。属性也是大小写敏感的，也就是说``` class ```和 ```Class ```在 WXML 中是不同的属性。

WXML肯定是有自己独特的```“个性”```的，先看一下wxml具体的使用方式，通过具体的使用方式来对比一下和Web中html的区别。

#### 行内属性

所有的标签都有一些相同的行内属性
- ```id```
- ```style```
- ```class```
- ```data-*```
- ```hidden```
- ```bind*/catch*```

#### 数据绑定

在 Web 开发中，开发者使用 ```JavaScript``` 通过 ```Dom 接口```来完成界面的实时更新。
在小程序中，使用 WXML 语言所提供的数据绑定功能，来完成此项功能。WXML 通过 ```{{变量名}}``` 来绑定 WXML 文件和对应的javaScript文件中的```data对象属性```。
 
#### 逻辑语法

通过```{{ 变量名 }} ```语法可以使得 WXML 拥有动态渲染的能力，除此外还可以在 ```{{ }}``` 内进行简单的```逻辑运算```。

- ```三元运算```
- ```算数运算```
- ```字符串的拼接```
- ```放置常量```（数字、字符串或者是数组）

#### 条件逻辑

WXML 中，使用```if-else```来判断是否需要渲染该代码块：

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3af960e357b447d89750f54066c11666~tplv-k3u1fbpfcp-watermark.image)

#### 列表渲染

在组件上使用``` wx:for``` 控制属性绑定一个数组，即可使用数组中各项的数据重复渲染该组件。默认数组的当前项的下标变量名默认为index，数组当前项的变量名默认为 item。
 
#### 模板

WXML提供模板```（template）```，可以在模板中定义代码片段，然后在不同的地方调用。使用 ```name``` 属性，作为模板的名字。然后在```<template />```内定义代码片段。

#### 引用

WXML 提供两种文件引用方式```import```和```include。```

```import```可以在该文件中使用目标文件定义的 ```<template />```，需要注意的是``` import``` 有作用域的概念，即只会 ```import``` 目标文件中定义的```template```，而不会 ```import``` 目标文件中 ```import``` 的 ```template```，简言之就是 ```import``` 不具有```递归```的特性。
```include``` 可以将目标文件中除了```<template />```、```<wxs />```外的整个代码引入，相当于是拷贝到```include```位置

看到这里是不是有点疑惑，有点```三不像```的感觉。像html又不像html，像vue又不像vue。哈哈，不过别急。看一下这个wxml模板语法。

![](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/53f097976ab64d8e940fd61144ebdafd~tplv-k3u1fbpfcp-watermark.image)

我们知道如何实现自定义标签，通过```WebComponents```。但这个也不是```WebComponents```啊，是的，[WebComponents](https://www.webcomponents.org/introduction)的规范中，自定义元素的名称中必须包含```连接词```。况且里面有数据绑定逻辑。这里就是我们后面章节要讲到的```Exparser框架```。

Exparser框架会将上述结构转换为下面这个样子。

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5d16937a3e0045efbfabcfd4894fd3dc~tplv-k3u1fbpfcp-watermark.image)

这样看的话是不是和`WebComponents`一样了。但是小程序并没有直接使用`WebComponents`，而是自行搭建了组件框架`Exparser`。

```Exparser```是微信小程序的组件组织框架，内置在小程序基础库中，为小程序的各种组件提供基础的支持。小程序内的所有组件，包括```内置组件```和```自定义组件```，都由```Exparser```组织管理。

```Exparser```的组件模型与```WebComponents```标准中的```Shadow DOM```高度相似。```Exparser```会维护整个页面的节点树相关信息，包括节点的属性、事件绑定等，相当于一个简化版的```Shadow DOM```实现。组件框架后面会有单独章节讲解，这里就不过多赘述。

到这里我们知道了WXML模版语法经过转换之后，会已自定义元素的形式来渲染。这里会有个疑问🤔️，为什么不用```HTML语法```和```WebComponents```来实现渲染，而是选择```自定义```？
 
- ```管控与安全```：web技术可以通过脚本获取修改页面敏感内容或者随意跳转其它页面
- ```能力有限```：会限制小程序的表现形式
- ```标签众多```：增加理解成本

其实从第一条的角度出发，理由就足够充分，现在信息安全就是每家互联网公司不得触碰的红线。前端安全问题需要特别重视，何况用户群体巨大的小程序呢。

所以，小程序不能直接使用html标签渲染页面，其提供了10多个内置组件来收敛web标签，并且提供一个```JavaScript沙箱```环境来避免js访问任何```浏览器api```。沙箱模块后面也有章节独立讲解。

我们回到WXML模板语法，从上方的WXML具体使用规则上来看，在模版语法设计中有没有什么讲究呢？

从模版语法上来看的话，只是很像vue而已，相似的地方为一些模版语法上的行内语法逻辑。但是小程序如果自己嵌入vue的话肯定是不靠谱的，因为小程序本身追求轻量，渲染性能高。在这种前提下，自我封装一套模板语法才是非常正确的选择，像一些行内逻辑类似 if. For 等模版逻辑之类的，现在前端开发看的多了，也就见怪不怪了。

![](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fb6e1f84067a47e5ba68e2622c10ce18~tplv-k3u1fbpfcp-watermark.image)


就我个人来看，还记得刚接触vue的时候，vue那种的```模板语法```真的是既熟悉又陌生，让我想起了php。那个时候```jquery还很锋利```（这个梗能懂的都是老前端了）的年代，前端大多数还是切图仔，```php```语法在前端页面还原之后的HTML模板中进行语法嵌套。if、for 之类的写法简直像的不能再像了。当然当然，我现在及之前所说的所有```“像”```并不是一种贬义词，恰恰相反。比如iphone手机侧面静音按钮一万年没变过一样。就是为了```保持用户操作的习惯性```，上手难度大大降低、给予用户一种```亲切感```，我在这里就可以像高中时期做语文卷子时候一样，做一些作者的阅读理解：也许可能vue作者和小程序团队借鉴了前端开发的“老习惯”。写着写着手感就来了，止都止不住。

配合wxml模板结构的还有```wxss文件```，就像```html + css```，顺便看一下wxss文件结构。

```WXSS``` (WeiXin Style Sheets)是一套样式语言，用于描述 WXML 的组件样式。 先看一下代码中的wxss文件结构及语法。

![](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/48b3600cb71b40389de20c0b90eb0527~tplv-k3u1fbpfcp-watermark.image)

可以看到里面的一些语法，WXSS 虽然具有 ```CSS``` 大部分的特性，但是小程序在 WXSS 也做了一些扩充和修改，比如很明显看到的```rpx```。在写 CSS 样式时，开发者需要考虑到手机设备的屏幕会有不同的宽度和设备像素比，采用一些技巧来换算一些```像素单位```。

```WXSS ```在底层支持新的尺寸单位 ```rpx ```(responsive pixel)，让我们可以免去换算的烦恼，只要交给小程序底层来换算即可，由于换算采用的```浮点数运算```，所以运算结果会和预期结果有一点点偏差。

WXSS复刻了大部分的特性说的谦虚了，其实这个大部分已经非常的大了，比想象中的要大的多，calc也完美复刻过来，并且支持rpx，比如:```Calc(100vh - 100rpx)```这样的语法也是没有问题的，平常的业务中已完全够用。

WXSS是为了配套渲染WXML的，平台也抛去了移动端浏览器的兼容问题，因为都是在小程序上跑的，也就剩屏幕大小和像素比的问题，小程序和贴心的在底层帮你解决了这个问题，在WXSS编译原理章节会带大家看一下这个```rpx转换算法```。

WXSS支持部分```css选择器```，更详细的文档可以参考[WXSS](https://developers.weixin.qq.com/miniprogram/dev/framework/view/wxss.html)
 

## 欢迎加入作者互动群

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/014053fac5ce4212984d4f386e377f56~tplv-k3u1fbpfcp-watermark.image?)

 


