---
title: 进程、线程、协程
toc: content
order: 1
group:
  title: 操作系统
  order: 3
---

## 进程

当你的代码变成一个可执行文件并启动时，它在内存中活动起来，由 CPU 逐条执行指令。这个活动中的实体，我们称之为 **进程**。

## 进程管理

考虑有一个会读取硬盘文件数据的程序被执行。当运行到读取文件的指令时，它会去从硬盘读取数据。由于硬盘的读写速度非常慢，若 CPU 一直等待硬盘返回数据，则利用率会很低。

![硬盘读取](https://raw.githubusercontent.com/chuenwei0129/my-picgo-repo/master/me/20240409215917.png)

因此，当进程要从硬盘读取数据时，CPU 不需要阻塞等待，而是去执行其他进程。当硬盘数据返回时，CPU 会收到中断，然后继续运行这个进程。

这种多个程序交替执行的思想，就是 CPU 管理多个进程的初步想法。

对于一个支持多进程的系统，CPU 会快速切换至不同进程。每个进程可能运行数十或数百毫秒。

虽然单核 CPU 在某一个瞬间只能运行一个进程，但在 1 秒钟内，它可能会运行多个进程，这样就产生了并行的错觉，实际上这就是**并发**。

## 并发和并行有什么区别？

![并发与并行](https://raw.githubusercontent.com/chuenwei0129/my-picgo-repo/master/me/20240409215732.png)

## [进程的状态](https://xiaolincoding.com/os/4_process/process_base.html#%E8%BF%9B%E7%A8%8B%E7%9A%84%E7%8A%B6%E6%80%81)

![进程状态](https://raw.githubusercontent.com/chuenwei0129/my-picgo-repo/master/me/20240409220208.png)

## CPU 的上下文切换

大多数操作系统都是多任务，通常支持大于 CPU 数量的任务同时运行。任务是交给 CPU 运行的，因此在每个任务前，CPU 需要知道该任务的起始位置。

操作系统需要提前设置好**CPU 寄存器**和**程序计数器**。CPU 上下文切换的过程包括：

1. 保存前一个任务的 CPU 上下文（寄存器和程序计数器）。
2. 加载新任务的上下文到寄存器和程序计数器。
3. 跳转到程序计数器所指的新位置，运行新任务。

内核保存上下文信息，当任务再次被分配给 CPU 执行时，加载这些上下文，保证任务状态不受影响，让任务看似连续运行。

### 任务的上下文切换

任务包括进程、线程和中断。可以根据任务的不同，将 CPU 上下文切换分为：进程上下文切换、线程上下文切换和中断上下文切换。

## 进程的上下文切换

进程由内核管理和调度，因此进程的上下文切换只能发生在内核态。其切换不仅涉及虚拟内存、栈、全局变量等用户空间资源，还包括内核堆栈和寄存器等内核空间资源。

![进程上下文切换](https://raw.githubusercontent.com/chuenwei0129/my-picgo-repo/master/me/20240409220807.png)

## 线程

**线程**是进程内的一条执行流程。多个线程可以共享同一进程的代码段、数据段、打开的文件等资源，但各自拥有独立的寄存器和栈，确保控制流的相对独立性。

![线程](https://raw.githubusercontent.com/chuenwei0129/my-picgo-repo/master/me/20240409221104.png)

### 线程的优点

- 一个进程中可以同时存在多个线程。
- 各个线程之间可以并发执行。
- 线程之间可以共享地址空间和文件等资源。

### 线程的缺点

当进程中的一个线程崩溃时，会导致该进程的所有线程崩溃（在 C/C++ 语言中，Java 语言中的线程崩溃不会导致进程崩溃）。

## 线程与进程的比较

| 特性         | 进程                                 | 线程                               |
| ------------ | ------------------------------------ | ---------------------------------- |
| 资源分配单位 | 资源（包括内存、打开的文件等）       | CPU 调度的单位                     |
| 资源平台     | 拥有完整的资源平台                   | 仅独享必不可少的资源，如寄存器和栈 |
| 状态         | 拥有三种基本状态（就绪、阻塞、执行） | 同样具有三种基本状态               |
| 性能开销     | 开销大                               | 开销小，效率高                     |

### 线程的优势

- **线程创建时间比进程快**：进程创建涉及资源管理，线程则共享资源。
- **线程终止时间比进程快**：线程释放资源较少。
- **同一进程内的线程切换比进程切换快**：线程具有相同的地址空间，切换时不需要切换页表。
- **线程间共享内存和文件资源**：数据传递高效，无需经过内核。

因此，无论是时间效率还是空间效率，线程均优于进程。

## 线程的上下文切换

> 当进程只有一个线程时，可以认为进程等于线程。

线程之间的切换有两种情况：

- 当两个线程不属于同一进程时，切换过程与进程上下文切换相同。
- 当两个线程属于同一进程时，因为虚拟内存是共享的，所以仅需切换线程的私有数据。

## [有了线程，为什么还要有协程？](https://www.zhihu.com/question/504791946)

![协程](https://raw.githubusercontent.com/chuenwei0129/my-picgo-repo/master/others/20230304022053.png)

## [协程的好处有哪些？](https://www.zhihu.com/question/20511233)

![协程好处](https://raw.githubusercontent.com/chuenwei0129/my-picgo-repo/master/computer/SCR-20220418-fwh.png)
