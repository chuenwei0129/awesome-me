---
group:
  title: 2024 ğŸ²
  order: -2024
title: äº‹ä»¶å¾ªç¯
toc: content
---

## å•çº¿ç¨‹æ¨¡å‹

ç½‘ä¸Šç»å¸¸ä¼šæœ‰è¿™æ ·çš„é—®é¢˜å‡ºç°ï¼ŒNode.js ç©¶ç«Ÿæ˜¯å•çº¿ç¨‹è¿˜æ˜¯å¤šçº¿ç¨‹çš„ï¼Ÿå…¶å®ä¸æ­¢æ˜¯ Node.jsï¼Œå¯¹äºæµè§ˆå™¨ä¸Šçš„ JavaScriptï¼Œå¤§å®¶éƒ½ä¼šæœ‰è¿™æ ·çš„ç–‘é—®ã€‚

åŸºç¡€å›ç­”ï¼šNode.js æ˜¯å•çº¿ç¨‹çš„ã€‚

å†ä¸¥è°¨ä¸€äº›ï¼šNode.js åœ¨ worker_threads æ¨¡å—ï¼ˆåŒæµè§ˆå™¨ä¸­çš„ [Web Workers API](https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API/Using_web_workers)ï¼‰å‡ºæ¥ä¹‹å‰ï¼Œåœ¨ç”¨æˆ·å±‚é¢æ˜¯å•çº¿ç¨‹çš„ã€‚

å±•å¼€è¯´è¯´ï¼šå•çº¿ç¨‹æ˜¯å¯¹ä½ è€Œè¨€ã€‚å¯¹åº•å±‚å¯ä¸æ˜¯ï¼Œåªä¸è¿‡å…¶ä»–çº¿ç¨‹å¯¹ä½ ä¸å¼€æ”¾çš„ã€‚

æ€ä¹ˆç†è§£ï¼Ÿ

è¿™ä¸ªé—®é¢˜æ¶‰åŠåˆ°ç¼–ç¨‹æ¨¡å‹ä¸å®ç°ç»†èŠ‚ä¹‹é—´çš„åŒºåˆ«ã€‚è®©æˆ‘ä»¬æ¥åˆ†è§£ä¸€ä¸‹è¿™ä¸ªç­”æ¡ˆï¼š

> JavaScript æ˜¯å•çº¿ç¨‹çš„ï¼Œä½†æ˜¯ JavaScript çš„æ‰§è¡Œç¯å¢ƒä¸æ˜¯å•çº¿ç¨‹çš„ï¼Œå¦‚æµè§ˆå™¨ã€‚ä¸»æµçš„ JS å¼•æ“è‡³å°‘éƒ½è¦æœ‰ä¸€ä¸ªç”¨æˆ·(JS)çº¿ç¨‹å¤–åŠ ä¸€ä¸ª IO çº¿ç¨‹ã€‚æ¯”å¦‚ä¸€ä¸ªçº¿ç¨‹ç»™ JS å’Œæ¸²æŸ“ï¼Œä¸€ä¸ªç»™ Ajaxã€‚ä½†ä¸¥è°¨çš„è¯´ Ajax æ˜¯ä½¿ç”¨å¼•æ“åŒ…è£…åçš„ï¼Œä¸ç®—å¼•æ“è‡ªèº«çš„ã€‚

1. **å•çº¿ç¨‹å¯¹å¼€å‘è€…è€Œè¨€**: å½“äººä»¬è¯´ Node.js æˆ–æµè§ˆå™¨ä¸­çš„ JavaScript æ˜¯å•çº¿ç¨‹çš„ï¼Œä»–ä»¬æŒ‡çš„æ˜¯ JavaScript ä»£ç çš„æ‰§è¡Œæ¨¡å‹ã€‚åœ¨è¿™ä¸ªæ¨¡å‹ä¸­ï¼Œ**ä½ çš„ JavaScript ä»£ç åœ¨ä»»ä½•æ—¶å€™éƒ½åªåœ¨ä¸€ä¸ªä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œ**ï¼Œè¿™æ„å‘³ç€ä½ å†™çš„**ä»»ä½• JavaScript ä»£ç éƒ½ä¸ä¼šå¹¶è¡Œæ‰§è¡Œ**ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ JavaScript ä¸­çš„å¹¶å‘æ¨¡å‹åŸºäºäº‹ä»¶å’Œå›è°ƒï¼Œè€Œä¸æ˜¯ä¼ ç»Ÿçš„å¤šçº¿ç¨‹å¹¶å‘æ¨¡å‹ã€‚

2. **åº•å±‚çš„å¤šçº¿ç¨‹**: å°½ç®¡ JavaScript ä»£ç æ˜¯åœ¨å•çº¿ç¨‹ä¸­è¿è¡Œçš„ï¼Œä½†è¿™å¹¶ä¸æ„å‘³ç€ JavaScript å¼•æ“åªæœ‰ä¸€ä¸ªçº¿ç¨‹ã€‚å®é™…ä¸Šï¼Œç°ä»£çš„ JavaScript å¼•æ“å’Œ Node.js è¿è¡Œæ—¶éƒ½ä½¿ç”¨å¤šçº¿ç¨‹æ¥å¤„ç† I/O æ“ä½œã€åƒåœ¾æ”¶é›†ã€æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ç­‰ã€‚è¿™äº›æ“ä½œé€šå¸¸ç”±å¼•æ“æˆ–è¿è¡Œæ—¶çš„å†…éƒ¨çº¿ç¨‹æ± å¤„ç†ï¼Œå¯¹äºå¼€å‘è€…æ¥è¯´æ˜¯å®Œå…¨é€æ˜çš„ã€‚

## ä¸¾ä¾‹è¯´æ˜

æœ‰äººä¼šè¯´æµè§ˆå™¨ä¸­ ajax è¯·æ±‚ä¹Ÿæ˜¯ç³»ç»Ÿå•ç‹¬å¼€äº†ä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œçš„ç½‘ç»œè¯·æ±‚ï¼Œé‚£ä¹ˆæµè§ˆå™¨åœ¨æ²¡æœ‰å¼•å…¥ Web Worker API ä¹‹å‰æ˜¯ä¸æ˜¯ä¹Ÿå¯ä»¥è¯´ JavaScript ä¹Ÿæœ‰å¤šä¸ªçº¿ç¨‹å‘¢ï¼Ÿ

é”™ï¼åœ¨æ²¡æœ‰å¼•å…¥ Web Worker API ä¹‹å‰ï¼ŒJavaScript ç¡®ç¡®å®å®æ˜¯è¿è¡Œåœ¨ä¸€ä¸ªå•çº¿ç¨‹é‡Œé¢ï¼é‚£ ajax æ€ä¹ˆè¯´ï¼Ÿ å›å¿†ä¸€ä¸‹è°ƒç”¨ ajax çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬æ˜¯éœ€è¦æŠŠæˆåŠŸå›è°ƒä¼ é€’ç»™ xhr çš„ï¼Œå…¸å‹çš„ä»£ç å¦‚ä¸‹ï¼š

```js
const xhr = new XMLHttpRequest();
xhr.onreadystatechangeï¼function(){} // ä¼ å…¥æˆ‘ä»¬çš„å›è°ƒ
xhr.open(...)
xhr.send(...)
```

å½“ä½ åœ¨æµè§ˆå™¨ä¸­è¿›è¡Œç½‘ç»œè¯·æ±‚ï¼ŒJavaScript ä»£ç ä¼šæ³¨å†Œä¸€ä¸ªå›è°ƒå‡½æ•°ç„¶åç«‹å³è¿”å›ï¼Œä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹ã€‚å®é™…çš„ç½‘ç»œè¯·æ±‚æ“ä½œæ˜¯åœ¨æµè§ˆå™¨çš„åº•å±‚ç”±ä¸åŒçš„çº¿ç¨‹å¤„ç†çš„ã€‚ä¸€æ—¦ç½‘ç»œè¯·æ±‚æˆåŠŸåï¼Œå›è°ƒå‡½æ•°ä¼šè¢«æ”¾å…¥äº‹ä»¶é˜Ÿåˆ—ä¸­ï¼Œæœ€ç»ˆç”±äº‹ä»¶å¾ªç¯å–å‡ºå¹¶åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œã€‚

æµè§ˆå™¨è™½ç„¶ä¼šåœ¨ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹å»è¿›è¡Œç½‘ç»œè¯·æ±‚ï¼Œä½†æ˜¯æˆ‘ä»¬æ˜¯é€šè¿‡ä¼ é€’ä¸€ä¸ªå›è°ƒçš„æ–¹å¼å»å¤„ç†æ•°æ®ï¼Œæµè§ˆå™¨åœ¨ç½‘ç»œè¯·æ±‚æˆåŠŸåï¼Œä»ç„¶æ˜¯åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œæˆ‘ä»¬çš„å›è°ƒï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬æ‰€æœ‰çš„ JavaScript ä»£ç éƒ½æ˜¯åœ¨ JavaScript çº¿ç¨‹ä¸­è¿è¡Œçš„ã€‚æ‰€ä»¥ JavaScript ç¡®å®æ˜¯åœ¨ä¸€ä¸ªå•çº¿ç¨‹ä¸­ã€‚

## ä¸ºä»€ä¹ˆä»¥å‰ JavaScript è¦è®¾è®¡æˆå•çº¿ç¨‹ï¼Œä¸ºä»€ä¹ˆä¸å…è®¸åœ¨ Web Worker ä¸­æ“ä½œ UIï¼Ÿ

[Web Workers](https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API/Using_web_workers) å…è®¸æˆ‘ä»¬å¼€ä¸€ä¸ªå·¥ä½œçº¿ç¨‹å¤„ç†ä¸€äº›è€—æ—¶çš„ä»»åŠ¡ï¼Œåœ¨ worker çº¿ç¨‹ä¸­ä½ å¯ä»¥è¿è¡Œä»»ä½•ä½ å–œæ¬¢çš„ä»£ç ï¼Œä¸è¿‡æœ‰ä¸€äº›ä¾‹å¤–æƒ…å†µã€‚æ¯”å¦‚ï¼šåœ¨ worker å†…ï¼Œ**ä¸èƒ½ç›´æ¥æ“ä½œ DOM èŠ‚ç‚¹**ã€‚

workers å’Œä¸»çº¿ç¨‹é—´çš„æ•°æ®ä¼ é€’é€šè¿‡è¿™æ ·çš„æ¶ˆæ¯æœºåˆ¶è¿›è¡Œâ€”â€”åŒæ–¹éƒ½ä½¿ç”¨ `postMessage()` æ–¹æ³•å‘é€å„è‡ªçš„æ¶ˆæ¯ï¼Œä½¿ç”¨ `onmessage` äº‹ä»¶å¤„ç†å‡½æ•°æ¥å“åº”æ¶ˆæ¯ã€‚**è¿™ä¸ªè¿‡ç¨‹ä¸­æ•°æ®å¹¶ä¸æ˜¯è¢«å…±äº«è€Œæ˜¯è¢«å¤åˆ¶**ã€‚

è¿›ç¨‹çš„åœ°å€ç©ºé—´æ˜¯éš”ç¦»çš„ï¼Œä½†åŒä¸€ä¸ªè¿›ç¨‹çš„çº¿ç¨‹ä¹‹è§æ˜¯å¯ä»¥å…±äº«æ•°æ®çš„ï¼Œä¸ºä»€ä¹ˆ Web Worker å’Œ JS è™½ç„¶ä¸åœ¨åŒä¸€çº¿ç¨‹ï¼Œä½†æ˜¯å¦‚æœåœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œä¹Ÿæ˜¯åº”è¯¥èƒ½å…±äº«å˜é‡çš„ï¼Œä¸ºä»€ä¹ˆ Web Worker å’Œ JS ä¸»çº¿ç¨‹ä¹‹é—´è¦é€šè¿‡æ¶ˆæ¯å¯¹åˆ—è¿™ç§å¤æ‚çš„æ–¹å¼æ¥ä¼ é€’æ•°æ®ï¼Ÿä¸ºä»€ä¹ˆä¸å…è®¸åœ¨ Web Worker ä¸­æ“ä½œ UIï¼Ÿ

**ç•Œé¢å¼€å‘ï¼Œä¸€æ¡é»„é‡‘åŸåˆ™å°±æ˜¯ä¸è¦åœ¨å…¶å®ƒçº¿ç¨‹ä¸­æ“ä½œ UIã€‚**

çº¿ç¨‹ä¹‹é—´åŒæ­¥æ˜¯æœ‰å¼€é”€çš„ï¼Œå¹¶ä¸”é¢ä¸´ç€åŒæ­¥é—®é¢˜ï¼Œå¦‚æœæ‰€æœ‰çš„çº¿ç¨‹éƒ½èƒ½æ“ä½œ UIï¼Œ**ä¸€æ—¦ cpu å‘ç”Ÿçº¿ç¨‹åˆ‡æ¢ï¼Œéƒ½ä¼šé¢ä¸´æ•°æ®ä¸å®Œæ•´çš„é£é™©**ï¼Œä¾‹å¦‚ a çº¿ç¨‹ UI ç•Œé¢æ”¹äº†ä¸€åŠï¼Œcpu å‘ç”Ÿçº¿ç¨‹åˆ‡æ¢ï¼Œb çº¿ç¨‹åˆå»æ”¹åŒä¸€å¤„ã€‚**è€Œç•Œé¢æœ¬è´¨ä¸Šæ¥è¯´åªæ˜¯æ“ä½œç³»ç»Ÿå¯¹æ•°æ®åœ¨æ˜¾ç¤ºå™¨ä¸Šçš„ä¸€ä¸ªæ˜ å°„ï¼Œå„ä¸ªçº¿ç¨‹æ“ä½œçš„éƒ½æ˜¯æ•°æ®**ï¼Œè¿™ä¹ˆä¸€æ¥ï¼Œä½ æ”¹æˆ‘ä¹Ÿæ”¹ï¼Œä½ è¿˜æ²¡æ”¹å®Œæˆ‘æœ‰æ”¹ï¼Œä½ æ”¹äº†ä¸€åŠæˆ‘æ¥ç€æ”¹ï¼Œé‚£è¿˜æ€ä¹ˆç©ï¼Œæ‰€ä»¥è¦æ”¯æŒå¤šçº¿ç¨‹ï¼Œå¿…é¡»æä¾›åŒæ­¥å·¥å…·ã€‚

## äº‹ä»¶å¾ªç¯ï¼ˆNode.jsï¼‰

### JavaScript ä»£ç æ‰§è¡Œçš„ç²’åº¦

Node.js æœ‰ä¸€æ¡ä¸»äº‹ä»¶å¾ªç¯ï¼Œæ‰€æœ‰çš„ JavaScript ä»£ç éƒ½æ˜¯åœ¨ä¸»äº‹ä»¶å¾ªç¯ä¸ŠæŒ‰â€œåŒæ­¥ä»£ç â€ä¸ºç²’åº¦ä¸€æ•´æ®µä¸€æ•´æ®µæ‰§è¡Œçš„ã€‚

```js
setTimeout(() => {
  console.log('a few moment later...');
}, 10);

setTimeout(() => {
  console.log('a few moment later as well...');
}, 15);

console.log('right now');
```

ä¸Šé¢æ‰€è°“åŒæ­¥ä»£ç ï¼Œäº‹ä»¶å¾ªç¯ä¸­çš„â€œç¬¬ä¸€æ®µâ€æ˜¯ï¼š

```js
setTimeout(callback, 10); // setTimeout å‡½æ•°å…¥æ ˆï¼Œå‡ºæ ˆ
setTimeout(callback, 15); // setTimeout å‡½æ•°å…¥æ ˆï¼Œå‡ºæ ˆ
console.log('right now'); // console.log å‡½æ•°å…¥æ ˆï¼Œå‡ºæ ˆ
```

è¿™ä¸€æ•´å—ä»£ç ä¸æ‰§è¡Œå®Œï¼ŒNode.js æ˜¯ä¸ä¼šè·³å‡ºå½“å‰è°ƒç”¨æ ˆçš„ã€‚å¦‚æœè¿™ä¸€æ®µä»£ç ä¸­æœ‰ä¸€æ®µæ­»å¾ªç¯å¡ä½äº†ï¼š

```js
setTimeout(callback, 10);
setTimeout(callback, 15);
console.log('right now');
while (1) {}
```

é‚£ä¹ˆå°±ä¼šå›°æ­»åœ¨å½“å‰ Tick ä¸­ã€‚

è€Œåç»­çš„ `setTimeout()` é‡Œé¢çš„å›è°ƒå‡½æ•°ä¹Ÿä¸€æ ·ã€‚åœ¨ libuv çš„äº‹ä»¶å¾ªç¯ä¸­ï¼Œç­‰åˆ°å®šæ—¶å™¨é˜¶æ®µè§¦å‘ï¼Œä¼šä¸²è¡Œæ‰§è¡Œä¸¤æ¬¡ `setTimeout()` é‡Œé¢çš„å›è°ƒå‡½æ•°ã€‚

åŒæ ·çš„é“ç†ï¼Œå¦‚æœåœ¨ç¬¬ä¸€æ®µå›è°ƒå‡½æ•°ä¸­å†™å‡ºæ­»å¾ªç¯ï¼š

```js
() => {
  console.log('a few moment later...');
  while (1) {}
}
```

é‚£ä¹ˆï¼ŒNode.js å°±æ°¸è¿œè·³ä¸å‡ºè¿™ä¸€æ®µåŒæ­¥æ‰§è¡Œã€‚ç†æ‰€å½“ç„¶ï¼Œå°±åˆ°ä¸äº†ç¬¬äºŒæ®µçš„å®šæ—¶å™¨å›è°ƒã€‚

`setTimeout(callback, 1000)` è¿™æ®µâ€œåŒæ­¥ä»£ç â€æ‰€åšçš„äº‹æ˜¯æ–°å»ºä¸€ä¸ª Timeout å®ä¾‹ï¼Œå¹¶å°†ä¼ è¿›æ¥çš„ `callback` å­˜åœ¨æŸä¸ªåœ°æ–¹ï¼Œä»…æ­¤è€Œå·²ã€‚`callback` åªæœ‰åœ¨åç»­å¼‚æ­¥é€»è¾‘ä¸­ libuv çš„å®šæ—¶å™¨äº‹ä»¶è¢«è§¦å‘ï¼Œå›åˆ° JavaScript é€»è¾‘æ—¶æ‰ä¼šè¢«è°ƒç”¨ã€‚è€Œæ­¤æ—¶è°ƒç”¨ä¹Ÿæ˜¯â€œå…¨èº«å¿ƒæŠ•å…¥â€åˆ°è¿™ä¸ªå›è°ƒå‡½æ•°ä¸­ï¼Œåªæœ‰å®ƒçš„ä¸€æ•´å—åŒæ­¥é€»è¾‘è°ƒç”¨å®Œä¹‹åï¼Œæ‰ä¼šè¿›å…¥åˆ°ä¸‹ä¸€æ®µå¼‚æ­¥äº‹ä»¶ä¸­ã€‚

å¦‚æœæœ‰å¤šä¸ª Timer éƒ½åœ¨å½“å‰æ—¶é—´åˆ°æœŸäº†ï¼Œåœ¨æ‰€è°“çš„â€œä¸€å¤§æ®µåŒæ­¥é€»è¾‘ä¸­â€ä¹Ÿæ˜¯ä¼šé€šè¿‡â€œè–…ç¾Šæ¯›ç®—æ³•â€ï¼ˆä¸‹æ–‡ä¸­ timer éƒ¨åˆ†ä¼šè®¨è®ºï¼‰é€ä¸€å»æ‰§è¡Œå„ä¸ªå®šæ—¶å™¨ï¼Œå¹¶ä¸ä¼šçœŸæ­£åœ°â€œåŒæ—¶è¿›è¡Œâ€ã€‚

### libuv çš„äº‹ä»¶å¾ªç¯å†…éƒ¨é¡ºåºå›¾

åœ¨ Node.js ä¸­ï¼Œå¼‚æ­¥ä½“ç°åœ¨æ–¹æ–¹é¢é¢ï¼Œæœ‰äº›å¼‚æ­¥ä»»åŠ¡æ˜¯äº¤ç»™ç±»ä¼¼ epoll ç­‰è¿›è¡Œ I/O ç›‘å¬ï¼Œè¿˜æœ‰ä¸€äº›ä»»åŠ¡åˆ™æ˜¯äº¤ç»™ libuv çš„çº¿ç¨‹æ± è¿›è¡Œæ‰§è¡Œã€‚

é‚£ä¹ˆç†æ‰€å½“ç„¶ï¼Œâ€œæ–‡ä»¶ç³»ç»Ÿâ€å’Œâ€œå®šæ—¶å™¨â€å¯èƒ½â€œåŒæ—¶è§¦å‘â€ã€‚ä»–ä»¬çš„æ‰§è¡Œé¡ºåºåˆæ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼Ÿ

ä¸€ä¸ªäº‹ä»¶å¾ªç¯é™¤äº† Poll for I/O ä¹‹å¤–ï¼Œå‰å‰ååè¿˜åŒ…äº†å¥½å‡ å±‚ã€‚æ‰€è°“çš„ Timer å°±åœ¨ Run due timers è¿™å±‚ã€‚è€Œ `setImmediate()`ã€`process.nextTick()` è¿™äº›åˆ™åˆ†åˆ«åœ¨å…¶ä»–å‡ å±‚ã€‚

![20240920155840](https://raw.githubusercontent.com/chuenwei0129/my-picgo-repo/master/react/20240920155840.png)

å®šæ—¶å™¨ä»»åŠ¡æ˜¯åœ¨å®šæ—¶å™¨é˜¶æ®µï¼ˆRun due timersï¼‰è¢«æ‰§è¡Œï¼Œé‡Œé¢åŒæ—¶åˆ°æœŸçš„å®šæ—¶å™¨å°šä¸”ä¸²è¡Œæ‰§è¡Œã€‚è€Œè¯»å–æ–‡ä»¶çš„äº‹ä»¶æ˜¯åœ¨ Poll I/O äº‹ä»¶é˜¶æ®µï¼ˆPoll for I/Oï¼‰ä¸­è¢«æ‰§è¡Œçš„ï¼Œé‡Œé¢å¦‚æœæœ‰å¤šä¸ª I/O äº‹ä»¶åŒæ—¶åˆ°è¾¾ï¼Œä¹Ÿæ˜¯é€ä¸€ä¸²è¡Œæ‰§è¡Œã€‚æ¯æ¬¡â€œä¸²è¡Œæ‰§è¡Œâ€çš„æ—¶å€™éƒ½åªä¼šæ‰§è¡Œå®Œé‚£ä¸€æ®µç›¸å…³çš„â€œåŒæ­¥ä»£ç â€ã€‚

æ‰€ä»¥çœ‹èµ·æ¥â€œåŒæ—¶å‘ç”Ÿâ€ï¼Œä½†åœ¨ Node.js çš„ä¸»äº‹ä»¶å¾ªç¯ä¸­ï¼Œæ‰€æœ‰çš„ä¸€å¤§æ®µä»£ç éƒ½æ˜¯å„è‡ªä¸²è¡Œæ‰§è¡Œçš„ã€‚å“ªæœ‰ä»€ä¹ˆå²æœˆé™å¥½ï¼Œä¸è¿‡æ˜¯æœ‰äººæ›¿ä½ è´Ÿé‡å‰è¡Œã€‚

### Timer

#### æµè§ˆå™¨ä¸­çš„ `setTimeout()`

åœ¨æµè§ˆå™¨ä¸­ï¼Œ`setTimeout()` çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªæ•´æ•°ï¼ˆintegerï¼‰ï¼Œè¡¨ç¤ºå®šæ—¶å™¨çš„ IDã€‚æ­¤å¤–ï¼Œå¦‚æœåµŒå¥—å±‚çº§å¤§äº 5 ä¸”è¶…æ—¶æ—¶é—´å°äº 4 æ¯«ç§’ï¼Œè¶…æ—¶æ—¶é—´ä¼šè¢«è®¾å®šä¸ºæœ€å°‘ 4 æ¯«ç§’ã€‚è¿™æ˜¯ä¸ºäº†é˜²æ­¢è¿‡äºé¢‘ç¹çš„å›è°ƒå½±å“æ€§èƒ½ã€‚

#### `Node.js` ä¸­çš„ `setTimeout()`

åœ¨ `Node.js` ä¸­ï¼Œ`setTimeout()` è¿”å›çš„æ˜¯ä¸€ä¸ª `Timeout` å¯¹è±¡ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæ•´æ•° IDã€‚æ­¤å¤–ï¼Œ`Node.js` ä¸­å¹¶æ²¡æœ‰å¼ºåˆ¶å®æ–½æµè§ˆå™¨ä¸­çš„ 4 æ¯«ç§’è§„åˆ™ï¼Œå› æ­¤è¶…æ—¶çš„å¤„ç†æ–¹å¼æœ‰æ‰€ä¸åŒã€‚

#### è§¦å‘é¡ºåºçš„å·®å¼‚

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ä»£ç ï¼Œå±•ç¤ºäº†åœ¨ä¸åŒç¯å¢ƒä¸­å®šæ—¶å™¨çš„è§¦å‘é¡ºåºå·®å¼‚ï¼š

```js
setTimeout(() => {
  console.log(1);
}, 10);

setTimeout(() => {
  console.log(2);
}, 15);

let now = Date.now();
while (Date.now() - now < 100) {
  // é˜»å¡ 100 ms
}

setTimeout(() => {
  console.log(3);
}, 10);

now = Date.now();
while (Date.now() - now < 100) {
  // é˜»å¡ 100 ms
}
```

**åœ¨æµè§ˆå™¨ä¸­ï¼š**

åœ¨æµè§ˆå™¨ä¸­ï¼ŒTimeout çš„è§¦å‘æ—¶é—´æŒ‰å®é™…è¶…æ—¶æ—¶é—´çš„è¿Ÿæ—©è¿›è¡Œæ’åºã€‚ä¸Šä¾‹ä¸­ï¼Œä¸‰ä¸ª Timeout çš„è§¦å‘æ—¶é—´åˆ†åˆ«ä¸º 10 æ¯«ç§’ã€15 æ¯«ç§’å’Œ 110 æ¯«ç§’ï¼Œæ‰€ä»¥è§¦å‘é¡ºåºåº”è¯¥æ˜¯ `1`ã€`2`ã€`3`ã€‚å®é™…ä¸Šï¼Œç”±äºç¬¬äºŒä¸ªé˜»å¡ï¼ˆ200 æ¯«ç§’ï¼‰ç»“æŸæ—¶ï¼Œæ‰€æœ‰çš„ Timeout éƒ½å·²ç»è¿‡æœŸï¼Œå› æ­¤å®ƒä»¬ä¼šç«‹å³è¢«è§¦å‘ï¼Œé¡ºåºæ˜¯ `1`ã€`2`ã€`3`ã€‚

**åœ¨ `Node.js` ä¸­ï¼š**

åœ¨ `Node.js` ä¸­ï¼Œäº‹ä»¶å¾ªç¯æœºåˆ¶æœ‰æ‰€ä¸åŒï¼Œå¯¼è‡´è§¦å‘é¡ºåºä¸å†æ˜¯ `1`ã€`2`ã€`3`ï¼Œè€Œæ˜¯ `1`ã€`3`ã€`2`ã€‚åœ¨ä¸Šä¾‹ä¸­ï¼Œå®šæ—¶å™¨è¢«æ’å…¥åˆ°äº‹ä»¶å¾ªç¯ä¸­æ—¶ï¼Œå¤§å®¶éƒ½è¶…æ—¶äº†ï¼Œ`1`ã€`3` å®šæ—¶å™¨å±äº `10ms` é“¾è¡¨ï¼Œ`2` å±äº `15ms` é“¾è¡¨ï¼Œå› æ­¤æŒ‰ç…§è–…ç¾Šæ¯›ç®—æ³•ï¼Œä¼šä¼˜å…ˆæ‰§è¡Œ `10ms` é“¾è¡¨ä¸­æ‰€æœ‰çš„ç¾Šæ¯›ï¼Œæ‰€ä»¥å…ˆè¾“å‡º `1`ã€`3`ï¼Œç„¶åå†è¾“å‡º `2`ã€‚

å¦‚æœæŠŠæœ€åä¸€æ®µä»£ç æ³¨é‡Šæ‰ï¼Œé‚£ä¹ˆè¾“å‡ºé¡ºåºå°±å’Œæµè§ˆå™¨ä¸€æ ·æ˜¯ `1`ã€`2`ã€`3`ã€‚

```js
setTimeout(() => {
  console.log(1);
}, 10);

setTimeout(() => {
  console.log(2);
}, 15);

let now = Date.now();
while (Date.now() - now < 100) {
  // é˜»å¡ 100 ms
}

setTimeout(() => {
  console.log(3);
}, 10);
```

### setImmediate()

`setTimeout()` æ—¶æœºä¸º libuv é‡Œå”¯ä¸€ Timer å®šæ—¶å™¨åœ¨äº‹ä»¶å¾ªç¯ä¸­æœ€è¿‘ä¸€æ¬¡è¶…æ—¶äº‹ä»¶ã€‚é‚£ `setImmediate()` å‘¢ï¼Ÿ

ä¸€æ¬¡äº‹ä»¶å¾ªç¯çš„é€»è¾‘é¡ºåºä¾æ¬¡ä¸ºï¼šå®šæ—¶å™¨äº‹ä»¶ã€Pending æ€ I/O äº‹ä»¶ã€ç©ºè½¬äº‹ä»¶ã€å‡†å¤‡äº‹ä»¶ã€Poll I/O äº‹ä»¶ã€å¤æŸ¥äº‹ä»¶åŠæ‰«å°¾ã€‚

çœ‹ä¸€ä¸‹ `setImmediate()` å®˜æ–¹æ–‡æ¡£ï¼š

> Schedules the "immediate" execution of the callback after I/O events' callbacks.

ä¹Ÿå°±æ˜¯è¯´æŒ‰ Node.js å®˜æ–¹æ–‡æ¡£æ¥çœ‹ï¼Œ`setImmediate()` æ‰§è¡Œæ—¶æœºæ˜¯åœ¨å¤æŸ¥äº‹ä»¶é˜¶æ®µï¼Œåœ¨å®šæ—¶å™¨äº‹ä»¶ã€Poll for I/O äº‹ä»¶ä¹‹åã€‚

ä½†äº‹å®ä¸Šå‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸€æ®µä»£ç ï¼š

```js
setImmediate(() => {
  console.log('setImmediate');
});

setTimeout(() => {
  console.log('setTimeout');
}, 0);
```

ç”¨ Node.js è·‘å‡ æ¬¡çœ‹çœ‹ï¼Ÿæˆ‘ä»¬ä¼šå‘ç°ç»“æœæ˜¯éšæœºçš„ï¼Œæœ‰æ—¶å…ˆ setImmediateï¼Œè€Œæœ‰æ—¶åˆ™å…ˆæ‰§è¡Œ setTimeoutã€‚è¯´å¥½çš„å®šæ—¶å™¨äº‹ä»¶å…ˆæ‰§è¡Œå‘¢ï¼Ÿ

è¿™é‡Œå…¶å®è¢«å·æ¢æ¦‚å¿µäº†ã€‚libuv è®¾è®¡çš„ç¡®æ˜¯å®šæ—¶å™¨å…ˆäºå¤æŸ¥çš„â€”â€”ä½†é‚£ä»…é™äºåŒä¸€ä¸ª Tick å‘€ã€‚æŠ›å¼€ä¸€ä¸ª Tick è®²æ‰§è¡Œé¡ºåºçš„éƒ½æ˜¯è€æµæ°“ã€‚å°± `setTimeout()` åŸç†é‚£ä¸ªä¸ç²¾ç¡®çš„åŠ²å„¿ï¼Œå®ƒæŒ‡ä¸å®šæ˜¯å“ªä¸ª Tick æ‰§è¡Œå‘¢ï¼Œè€Œ setImmediate çš„æ‰§è¡Œé¡ºåºåˆ™æ°æ°åœ¨è¯¥ Tick æœ«å°¾ã€‚

åœ¨ä¸Šé¢ä»£ç ä¸­ï¼Œæ‰§è¡Œäº†è¿™ä¸¤å¥ä»£ç åï¼Œæ‰è¿›å…¥äº‹ä»¶å¾ªç¯ã€‚åœ¨ç¬¬ä¸€ä¸ª Tick ä¸­ï¼Œå…ˆåˆ¤æ–­ `setTimeout()` æœ‰æ²¡æœ‰åˆ°æœŸã€‚è¶…æ—¶æ—¶é—´ä¸º `0`ï¼Œåœ¨ Timeout æ„é€ å‡½æ•°ä¸­ä¼šè¢«è‡ªåŠ¨è®¾ä¸º `1`ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œç¬¬ä¸€ä¸ª Tick è¿˜è¶…ä¸äº†æ—¶ï¼Œæ‰€ä»¥ç•¥è¿‡å®šæ—¶å™¨ï¼Œèµ°åˆ°äº†å¤æŸ¥é˜¶æ®µï¼›è€Œæœ‰æ—¶å€™è®¡ç®—æœºç¨å¾®è„‘æŠ½å¡ä¸€ä¸‹ï¼Œç¬¬ä¸€ä¸ª Tick çš„æ—¶å€™å°±å·²ç»è¶…æ—¶äº†ï¼Œè¿™ä¸ªæ—¶å€™è‡ªç„¶æ˜¯å…ˆæ‰§è¡Œè¿™ä¸ª Timeoutã€‚å¦‚æœå·²ç»åœ¨äº‹ä»¶å¾ªç¯ä¸­ï¼Œå†è·‘è¿™ä¸¤è¡Œå¥ä»£ç ï¼Œé‚£è‚¯å®šæ˜¯å…ˆæ‰§è¡Œ Immediateï¼Œæ¯•ç«Ÿå®šæ—¶å™¨é˜¶æ®µæœªæ£€æŸ¥åˆ°è¶…æ—¶ Timeoutã€‚å¦‚ä¸‹ï¼š

```js
// timer1 -> check -> timer2
setTimeout(() => {
  setImmediate(() => {
    console.log('setImmediate');
  });

  setTimeout(() => {
    console.log('setTimeout');
  }, 0);
}, 0);
```

è¿™å°±é“å®šå…ˆæ‰§è¡Œ setImmediate å†æ‰§è¡Œ setTimeout äº†ï¼Œå› ä¸ºè·‘å®Œå¤–å±‚ Timeout åï¼Œç›´æ¥å°±åˆ°åç»­é˜¶æ®µäº†ï¼Œä¸€è·¯è¿‡å»è‚¯å®šæ˜¯å…ˆæ‰§è¡Œå¤æŸ¥é˜¶æ®µï¼Œç„¶åå†æ˜¯ä¸‹ä¸ª Tick æ‰èƒ½æ‰§è¡Œåç»­çš„ Timeoutã€‚ä½†å¦‚æœè¿™æ ·å‘¢ï¼š

```js
setImmediate(() => {
  setImmediate(() => {
    console.log('setImmediate');
  });

  setTimeout(() => {
    console.log('setTimeout');
  }, 0);
});
```

è¿™ä¸ªæ—¶å€™ï¼Œé‡Œé¢çš„ä¸¤ä¸ª setImmediate ä¸ setTimeout è‚¯å®šéƒ½æ˜¯è¦åœ¨ä¸‹ä¸ª Tick è¿›è¡Œäº†ï¼Œå› ä¸ºå½“å‰å·²ç»å¤„äºå¤æŸ¥é˜¶æ®µï¼Œè€Œä¸”é˜²é‡å…¥æœºåˆ¶è®©é‡Œé¢çš„ Immediate è‚¯å®šä¸ä¼šå†åœ¨å½“å‰ Tick è¿›è¡Œã€‚é‚£è¿™ä¸ªæ—¶å€™è¿˜æ˜¯è¦çœ‹ç”µè„‘æœ‰æ²¡æœ‰è„‘æŠ½ï¼Œæ‰€ä»¥å®ƒçš„ç»“æœæ˜¯è·Ÿæœ€å¼€å§‹é‚£ä¸¤å¥ä»£ç ä¸€æ ·ï¼Œé¡ºåºæ˜¯éšæœºçš„ã€‚

é‚£å¦‚æœæ˜¯ `setImmediate()` ä¸ fs å‘¢ï¼Ÿæ¯”å¦‚ï¼š

```js
setImmediate(() => {
  console.log('setImmediate');
});
require('fs').readFile('temp.js', () => {
  console.log('readFile');
});
```

è¿™ä¸ªæ‰§è¡Œé¡ºåºåˆæ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿé¦–å…ˆï¼Œåœ¨è¿™ä¸ª Tick ä¸­çš„æ‰§è¡Œé¡ºåºè‚¯å®šæ˜¯å…ˆ Poll for I/O ç„¶åå†å¤æŸ¥ã€‚ä½†é—®é¢˜åœ¨äºï¼ŒPoll for I/O é˜¶æ®µï¼Œå®ƒç­‰å¾…æ–‡ä»¶ç³»ç»Ÿäº‹ä»¶çš„æ—¶é—´ä¸º 0ï¼Œ0 æ—¶é—´å†…ç­‰ä¸åˆ°äº‹ä»¶ï¼Œé‚£ä¹ˆä¼šç»§ç»­æ‰§è¡Œåç»­é€»è¾‘ã€‚è€Œå¯¹ä¸€ä¸ªè¿™ç§å¯è¯»äº‹ä»¶æ¥è¯´ï¼Œé€šå¸¸ä¸ä¼šåœ¨ 0 çš„æ—¶é—´å†…å®Œæˆè§¦å‘ï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ª Tick åŸºæœ¬ä¸Šéƒ½æ˜¯ç›´æ¥åœ¨ Poll for I/O é˜¶æ®µå‡æ¨¡å‡å¼ç­‰ä½  0 æ¯«ç§’ï¼Œç„¶åå°±ç›´å¥”å¤æŸ¥é˜¶æ®µå»äº†ã€‚ç¬¬ä¸€ä¸ª Tick æ²¡è¯»å‡ºæ¥ï¼Œé‚£ fs è‡ªç„¶æ˜¯åœ¨åç»­ Tick ä¸­è¯»å‡ºæ¥äº†ã€‚æ‰€ä»¥å¦‚æœæ²¡æœ‰ä¸€äº›ç‰¹æ®Šæƒ…å†µï¼Œä¸Šé¢çš„ä»£ç  setImmediate æ€»ä¼šå…ˆäº readFile è¢«è¾“å‡ºã€‚

æ”¹ä¸€ä¸‹ä¸Šé¢çš„ä»£ç ï¼š

```js
function imm() {
  setImmediate(() => {
    console.log('setImmediate');
    imm();
  });
}
imm();

require('fs').readFile('temp.js', () => {
  console.log('readFile');
  process.exit(0); //
});
```

æ‰§è¡Œå‡ æ¬¡ï¼Œä¼šå‘ç°ï¼Œè¾“å‡ºäº†å‡ è¡Œ setImmediate åï¼Œç»ˆäºè¯»å–æˆåŠŸäº†ï¼Œç„¶åè¾“å‡º readFile å¹¶é€€å‡ºäº†ã€‚è¿™åˆæ˜¯ä»€ä¹ˆç§‘å­¦é“ç†å‘¢ï¼Ÿè™½ç„¶æˆ‘ä»¬æ‰§è¡Œç­‰å¾…çš„æ—¶å€™ç­‰å¾…æ—¶é—´ä¸º 0ï¼Œä½†æ˜¯æ•´æ®µ JavaScript åœ¨æ¯ä¸ª Tick æ‰§è¡Œæ—¶é—´è¿˜æ˜¯æœ‰çº³ç§’ã€å¾®å¦™ã€æ¯«ç§’çº§åˆ«çš„è€—æ—¶ï¼Œæ‰€ä»¥åˆ°ä¸‹å‡ ä¸ª Tick çš„æ—¶å€™ï¼Œäº‹ä»¶å·²ç»åˆ°äº†ï¼Œä¸ç”¨ç­‰å°±èƒ½ç›´æ¥æ‹¿åˆ°ã€‚è¿™ä¸ªæ—¶å€™å“ªæ€•ç­‰å¾… 0 ä¹Ÿèƒ½ç›´æ¥æ‹¿åˆ°äº‹ä»¶ï¼Œäºæ˜¯ç»ˆäºç­‰åˆ°äº† readFile() çš„å›è°ƒå‡½æ•°å‡ºåœºäº†ã€‚

### queueMicrotask()

**å¾®ä»»åŠ¡æ˜¯åœ¨â€œå½“å‰ JavaScript æ‰§è¡Œä¸Šä¸‹æ–‡å †æ ˆâ€å®Œæ¯•ä¹‹åï¼Œè¦å¼€å§‹æ‰§è¡Œä¸‹ä¸€å¨ JavaScript ä¹‹å‰ï¼Œåœ¨è¿™ä¸ªç©ºæ¡£ä¹‹é—´æ‰§è¡Œçš„ä»»åŠ¡**ã€‚è¿™ä¸äº‹ä»¶å¾ªç¯æ²¡æœ‰å¿…ç„¶è”ç³»ã€‚

æ¯”å¦‚æˆ‘ä»¬ç›‘å¬äº†å¾ˆå¤šæ–‡ä»¶ç³»ç»Ÿ I/O äº‹ä»¶ï¼Œå¹¶ä¸”åœ¨æŸä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¸­åŒæ—¶æ‹¿åˆ°äº‹ä»¶å¹¶è§¦å‘ï¼Œå®ƒä»¬å¤„äºåŒä¸ªé˜¶æ®µï¼Œä½†å®ƒä»¬çš„ JavaScript æ‰§è¡Œä¸Šä¸‹æ–‡å †æ ˆåˆ™ä¸åŒã€‚

```js
function sleep(milliseconds) {
  const start = new Date().getTime();
  while (new Date().getTime() - start < milliseconds) {
    // æ­¤å¾ªç¯ä¼šé˜»å¡æ‰§è¡Œï¼Œç›´åˆ°æŒ‡å®šçš„æ¯«ç§’æ•°è¿‡å»
  }
}

setTimeout(() => {
  console.log('setTimeout1');
  queueMicrotask(() => {
    console.log('queueMicrotask1');
  });
}, 10);

setTimeout(() => {
  console.log('setTimeout2');
  queueMicrotask(() => {
    console.log('queueMicrotask2');
  });
}, 15);

sleep(100);

setTimeout(() => {
  console.log('setTimeout3');
  queueMicrotask(() => {
    console.log('queueMicrotask3');
  });
}, 10);

sleep(100);
```

### process.nextTick()

`process.nextTick()` å¹¶ä¸å±äºäº‹ä»¶å¾ªç¯å†…çš„æ¦‚å¿µã€‚è¿™é‡Œçš„ Tick ä¹Ÿä¸æˆ‘ä»¬ä¹‹å‰è®²çš„äº‹ä»¶å¾ªç¯çš„ Tick ä¸æ˜¯ä¸€å›äº‹ã€‚å®ƒæ˜¯ Node.js ä¸­çš„ Tick æ¦‚å¿µï¼ˆå¯ä»¥ç†è§£æˆ Timer çš„é—´éš™ï¼‰ã€‚

æ‰€ä»¥ï¼Œ`process.nextTick()` å›è°ƒæ‰§è¡Œæ—¶æœºæ˜¯ï¼š

1. Node.js å†…éƒ¨ä¸€äº› callback æ‰§è¡Œå®Œæ¯•åï¼›
2. Timeoutã€Immediate è§¦å‘æ‰§è¡Œçš„é—´éš™ã€‚

```js
console.log('start');

process.nextTick(() => {
  console.log('tick1');
});

setTimeout(() => {
  setImmediate(() => {
    console.log('setImmediate');
    process.nextTick(() => {
      console.log('tick2');
    });
  });

  setTimeout(() => {
    console.log('setTimeout');
    process.nextTick(() => {
      console.log('tick3');
    });
  }, 0);
});
```

è€Œä¸”å®ƒä¸å¾®ä»»åŠ¡çš„å…³ç³»æ˜¯ï¼Œä¸Šé¢ä¸¤ç§æƒ…å†µå‘ç”Ÿåï¼Œè‹¥æ—  Tick å›è°ƒï¼Œä¹Ÿå¿…å®šä¼šæ‰§è¡Œå¾®ä»»åŠ¡ï¼›è‹¥æœ‰ Tick å›è°ƒï¼Œåˆ™å…ˆæ‰§è¡Œ Tick å›è°ƒï¼Œç„¶åæ‰§è¡Œå¾®ä»»åŠ¡ï¼Œè‹¥æœŸé—´æœ‰æ–°çš„ Tick å›è°ƒæ’å…¥ï¼Œé‚£ä¹ˆå°±ç»§ç»­æ‰§è¡Œï¼Œå¾ªç¯å¾€å¤ï¼Œä¸ä¼šè·³å‡ºè¯¥ Tickã€‚

```js
console.log('start');

process.nextTick(() => {
  console.log('tick1');
  process.nextTick(() => {
    console.log('tick2');
  });
});

Promise.resolve().then(() => {
  console.log('promise1');
  process.nextTick(() => {
    console.log('tick3');
  });
  Promise.resolve().then(() => {
    console.log('promise2');
  });
});
// start
// tick1
// tick2
// promise1
// promise2
// tick3
```

## äº‹ä»¶å¾ªç¯ï¼ˆæµè§ˆå™¨ï¼‰

### Event Loop

Event Loopï¼ˆäº‹ä»¶å¾ªç¯ï¼‰æ˜¯ç”¨æ¥åè°ƒäº‹ä»¶ã€ç”¨æˆ·äº¤äº’ã€è„šæœ¬ã€æ¸²æŸ“ã€ç½‘ç»œçš„ä¸€ç§æµè§ˆå™¨å†…éƒ¨æœºåˆ¶ã€‚

æˆ‘ä»¬è¿™é‡Œä¸»è¦è®¨è®ºçš„æ˜¯ window event loopã€‚ä¹Ÿå°±æ˜¯æµè§ˆå™¨ä¸€ä¸ªæ¸²æŸ“è¿›ç¨‹å†…ä¸»çº¿ç¨‹æ‰€æ§åˆ¶çš„ Event Loopã€‚

Event Loop å¤„ç†è¿‡ç¨‹ï¼š

1. åœ¨æ‰€é€‰ task queue (taskQueue) ä¸­çº¦å®šå¿…é¡»åŒ…å«ä¸€ä¸ªå¯è¿è¡Œä»»åŠ¡ã€‚å¦‚æœæ²¡æœ‰æ­¤ç±» task queueï¼Œåˆ™è·³è½¬è‡³ä¸‹é¢ microtasks æ­¥éª¤ã€‚
2. è®© taskQueue ä¸­æœ€è€çš„ task (oldestTask) å˜æˆç¬¬ä¸€ä¸ªå¯æ‰§è¡Œä»»åŠ¡ï¼Œç„¶åä» taskQueue ä¸­åˆ æ‰å®ƒã€‚
3. å°†ä¸Šé¢ oldestTask è®¾ç½®ä¸º event loop ä¸­æ­£åœ¨è¿è¡Œçš„ taskã€‚
4. æ‰§è¡Œ oldestTaskã€‚
5. å°† event loop ä¸­æ­£åœ¨è¿è¡Œçš„ task è®¾ç½®ä¸º nullã€‚
6. æ‰§è¡Œ microtasks æ£€æŸ¥ç‚¹ï¼ˆä¹Ÿå°±æ˜¯æ‰§è¡Œ microtasks é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼‰ã€‚
7. è®¾ç½® hasARenderingOpportunity ä¸º falseã€‚
8. æ›´æ–°æ¸²æŸ“ã€‚
9. å¦‚æœå½“å‰æ˜¯ window event loop ä¸” task queues é‡Œæ²¡æœ‰ task ä¸” microtask queue æ˜¯ç©ºçš„ï¼ŒåŒæ—¶æ¸²æŸ“æ—¶æœºå˜é‡ hasARenderingOpportunity ä¸º false ï¼Œå»æ‰§è¡Œ idle periodï¼ˆrequestIdleCallbackï¼‰ã€‚
10. è¿”å›åˆ°ç¬¬ä¸€æ­¥ã€‚

ä»¥ä¸Šæ˜¯æ¥è‡ªè§„èŒƒå…³äº event loop å¤„ç†è¿‡ç¨‹çš„ç²¾ç®€ç‰ˆæ•´ç†ï¼Œçœç•¥äº†éƒ¨åˆ†å†…å®¹ã€‚

æ›´æ–°æ¸²æŸ“å…·ä½“æµç¨‹ï¼š

1. éå†å½“å‰æµè§ˆä¸Šä¸‹æ–‡ä¸­æ‰€æœ‰çš„ document ï¼Œå¿…é¡»æŒ‰åœ¨åˆ—è¡¨ä¸­æ‰¾åˆ°çš„é¡ºåºå¤„ç†æ¯ä¸ª document ã€‚
2. æ¸²æŸ“æ—¶æœºï¼ˆRendering opportunitiesï¼‰ï¼šå¦‚æœå½“å‰æµè§ˆä¸Šä¸‹æ–‡ä¸­æ²¡æœ‰åˆ°æ¸²æŸ“æ—¶æœºåˆ™å°†æ‰€æœ‰ docs åˆ é™¤ï¼Œå–æ¶ˆæ¸²æŸ“ï¼ˆæ­¤å¤„æ˜¯å¦å­˜åœ¨æ¸²æŸ“æ—¶æœºç”±æµè§ˆå™¨è‡ªè¡Œåˆ¤æ–­ï¼Œæ ¹æ®ç¡¬ä»¶åˆ·æ–°ç‡é™åˆ¶ã€é¡µé¢æ€§èƒ½æˆ–é¡µé¢æ˜¯å¦åœ¨åå°ç­‰å› ç´ ï¼‰ã€‚
3. å¦‚æœå½“å‰æ–‡æ¡£ä¸ä¸ºç©ºï¼Œè®¾ç½® hasARenderingOpportunity ä¸º true ã€‚
4. ä¸å¿…è¦çš„æ¸²æŸ“ï¼ˆUnnecessary renderingï¼‰ï¼šå¦‚æœæµè§ˆå™¨è®¤ä¸ºæ›´æ–°æ–‡æ¡£çš„æµè§ˆä¸Šä¸‹æ–‡çš„å‘ˆç°ä¸ä¼šäº§ç”Ÿå¯è§æ•ˆæœä¸”æ–‡æ¡£çš„ animation frame callbacksï¼ˆrequestAnimationFrameï¼‰æ˜¯ç©ºçš„ï¼Œåˆ™å–æ¶ˆæ¸²æŸ“ã€‚
5. ä» docs ä¸­åˆ é™¤æµè§ˆå™¨è®¤ä¸ºå‡ºäºå…¶ä»–åŸå› æœ€å¥½è·³è¿‡æ›´æ–°æ¸²æŸ“çš„æ–‡æ¡£ã€‚
6. å¦‚æœæ–‡æ¡£çš„æµè§ˆä¸Šä¸‹æ–‡æ˜¯é¡¶çº§æµè§ˆä¸Šä¸‹æ–‡ï¼Œåˆ™åˆ·æ–°è¯¥æ–‡æ¡£çš„è‡ªåŠ¨å¯¹ç„¦å€™é€‰å¯¹è±¡ã€‚
7. å¤„ç† resize äº‹ä»¶ï¼Œä¼ å…¥ä¸€ä¸ª `performance.now()` æ—¶é—´æˆ³ã€‚
8. å¤„ç† scroll äº‹ä»¶ï¼Œä¼ å…¥ä¸€ä¸ª `performance.now()` æ—¶é—´æˆ³ã€‚
9. å¤„ç†åª’ä½“æŸ¥è¯¢ï¼Œä¼ å…¥ä¸€ä¸ª `performance.now()` æ—¶é—´æˆ³ã€‚
10. è¿è¡Œ CSS åŠ¨ç”»ï¼Œä¼ å…¥ä¸€ä¸ª `performance.now()` æ—¶é—´æˆ³ã€‚
11. å¤„ç†å…¨å±äº‹ä»¶ï¼Œä¼ å…¥ä¸€ä¸ª `performance.now()` æ—¶é—´æˆ³ã€‚
12. æ‰§è¡Œ requestAnimationFrame å›è°ƒï¼Œä¼ å…¥ä¸€ä¸ª `performance.now()` æ—¶é—´æˆ³ã€‚
13. æ‰§è¡Œ intersectionObserver å›è°ƒï¼Œä¼ å…¥ä¸€ä¸ª `performance.now()` æ—¶é—´æˆ³ã€‚
14. å¯¹æ¯ä¸ª document è¿›è¡Œç»˜åˆ¶ã€‚
15. æ›´æ–° ui å¹¶å‘ˆç°ã€‚

æ ¹æ®æ›´æ–°æ¸²æŸ“æµç¨‹å¯çŸ¥ï¼Œå¦‚ä¸‹æ¡ˆåˆ—é¡µé¢éšè—æ—¶å¹¶ä¸ä¼šé—ªçƒï¼Œ**å› ä¸º JS è„šæœ¬ä½œä¸ºä¸€ä¸ªæ•´ä½“ï¼Œå¿…é¡»ç­‰åˆ°æ‰§è¡Œå®Œæ¯•åï¼Œæµè§ˆå™¨æ‰ä¼šå¼€å§‹æ¸²æŸ“**ã€‚

```js
document.body.appendChild(el)
el.style.display = 'none'
```

ä¸‹é¢ä»£ç ä¸­å®é™…ä¸Šåªæœ‰æœ€åä¸€è¡Œä»£ç æ˜¯æœ‰æ„ä¹‰çš„ã€‚

```js
button.addEventListener('click', () => {
  box.style.display = 'none'
  box.style.display = 'block'
  box.style.display = 'none'
  box.style.display = 'block'
  box.style.display = 'none'
  box.style.display = 'block'
  box.style.display = 'none'
  box.style.display = 'block'
})
```

### Event Loop ä¸ requestAnimationFrame

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      * {
        margin: 0;
      }
      .box1 {
        width: 100px;
        height: 100px;
        background-color: #ccc;
      }
      .box2 {
        width: 100px;
        height: 100px;
        background-color: #9c5f5f;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div class="box1"></div>
    <div class="box2"></div>
    <button type="button">click me</button>

    <script>
      const box1 = document.querySelector('.box1');
      const box2 = document.querySelector('.box2');
      const button = document.querySelector('button');

      button.addEventListener('click', () => {
        let j = 0;
        let requestId;
        function animation1() {
          box1.style.marginLeft = `${j}px`;
          requestId = requestAnimationFrame(animation1);
          j++;
          if (j > 200) {
            cancelAnimationFrame(requestId);
          }
        }
        animation1();

        let i = 0;
        let timerId;
        function animation() {
          box2.style.marginLeft = `${i}px`;
          timerId = setTimeout(animation, 0);
          i++;
          if (i > 200) {
            clearTimeout(timerId);
          }
        }
        animation();
      });
    </script>
  </body>
</html>
```

<!-- æµè§ˆå™¨æ¸²æŸ“å‰ raf å¿…æ‰§è¡Œï¼Œå…³äº timer ä¸ raf çš„é¡ºåºï¼Œå®é™…æ˜¯ timer ä¸æ¸²æŸ“çš„é¡ºåº -->
ç‚¹å‡»æŒ‰é’®å¯ä»¥çœ‹åˆ°ï¼š`setTimeout` åŠ¨ç”»æ¯” `requestAnimationFrame` åŠ¨ç”»æ›´å¿«ã€‚

æ ¹æ®ä¸Šæ–‡å¯çŸ¥ï¼š`requestAnimationFrame` çš„å›è°ƒæ—¶æœº â€”â€”â€”â€” å®ƒä¼šåœ¨ `style/layout/paint` ä¹‹å‰è°ƒç”¨ã€‚

![20240920214724](https://raw.githubusercontent.com/chuenwei0129/my-picgo-repo/master/react/20240920214724.png)

é¦–å…ˆï¼Œæµè§ˆå™¨æ¸²æŸ“æœ‰ä¸ªæ¸²æŸ“æ—¶æœºçš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯æµè§ˆå™¨ä¼šæ ¹æ®å½“å‰çš„æµè§ˆä¸Šä¸‹æ–‡åˆ¤æ–­æ˜¯å¦è¿›è¡Œæ¸²æŸ“ï¼Œå®ƒä¼šå°½é‡é«˜æ•ˆï¼Œåªæœ‰å¿…è¦çš„æ—¶å€™æ‰è¿›è¡Œæ¸²æŸ“ï¼Œå¦‚æœæ²¡æœ‰ç•Œé¢çš„æ”¹å˜ï¼Œå°±ä¸ä¼šæ¸²æŸ“ã€‚æŒ‰ç…§è§„èŒƒé‡Œè¯´çš„ä¸€æ ·ï¼Œå› ä¸ºè€ƒè™‘åˆ°ç¡¬ä»¶çš„åˆ·æ–°é¢‘ç‡é™åˆ¶ã€é¡µé¢æ€§èƒ½ä»¥åŠé¡µé¢æ˜¯å¦å­˜åœ¨åå°ç­‰ç­‰å› ç´ ï¼Œæœ‰å¯èƒ½æ‰§è¡Œå®Œ setTimeout è¿™ä¸ª task ä¹‹åï¼Œå‘ç°è¿˜æ²¡åˆ°æ¸²æŸ“æ—¶æœºï¼Œæ‰€ä»¥ setTimeout å›è°ƒäº†å‡ æ¬¡ä¹‹åæ‰è¿›è¡Œæ¸²æŸ“ï¼Œæ­¤æ—¶è®¾ç½®çš„ marginLeft å’Œä¸Šä¸€æ¬¡æ¸²æŸ“å‰ marginLeft çš„å·®å€¼è¦å¤§äº 1px çš„ï¼Œå› ä¸ºå±å¹•çš„åˆ·æ–°é¢‘ç‡æ˜¯ 60 Hzï¼Œæ‰€ä»¥å¤§è‡´åœ¨ 16.6ms ä¹‹å†…æ‰§è¡Œäº†å¤šæ¬¡ setTimeout task ä¹‹åæ‰åˆ°äº†æ¸²æŸ“æ—¶æœºå¹¶æ‰§è¡Œæ¸²æŸ“ã€‚

requestAnimationFrame å¸§åŠ¨ç”»ä¸åŒä¹‹å¤„åœ¨äºï¼Œæ¯æ¬¡æ¸²æŸ“ä¹‹å‰éƒ½ä¼šè°ƒç”¨ï¼Œæ­¤æ—¶è®¾ç½®çš„ marginLeft å’Œä¸Šä¸€æ¬¡æ¸²æŸ“å‰ marginLeft çš„å·®å€¼ä¸º 1px ã€‚

æ‰€ä»¥çœ‹ä¸Šå» setTimeout â€œå¿«â€äº†å¾ˆå¤šã€‚

### Event Loop ä¸ EventTarget.dispatchEvent()

ä¸æµè§ˆå™¨åŸç”Ÿäº‹ä»¶ä¸åŒï¼Œ**åŸç”Ÿäº‹ä»¶**æ˜¯ç”± DOM æ´¾å‘çš„ï¼Œå¹¶é€šè¿‡ `event loop` **å¼‚æ­¥è°ƒç”¨**äº‹ä»¶å¤„ç†ç¨‹åºï¼Œè€Œ`dispatchEvent()`åˆ™æ˜¯**åŒæ­¥è°ƒç”¨**äº‹ä»¶å¤„ç†ç¨‹åºã€‚åœ¨è°ƒç”¨ `dispatchEvent()` åï¼Œæ‰€æœ‰ç›‘å¬è¯¥äº‹ä»¶çš„äº‹ä»¶å¤„ç†ç¨‹åºå°†åœ¨ä»£ç ç»§ç»­å‰æ‰§è¡Œå¹¶è¿”å›ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸ªç¤ºä¾‹ï¼š

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <button>Click me!</button>
    <script>
      const button = document.querySelector('button');

      button.addEventListener('click', () => {
        Promise.resolve().then(() => {
          console.log('Microtask 1');
        });
        console.log('Listener 1');
      });

      button.addEventListener('click', () => {
        Promise.resolve().then(() => {
          console.log('Microtask 2');
        });
        console.log('Listener 2');
      });
    </script>
  </body>
</html>
```

<!-- å¯ä»¥æŠŠç”¨æˆ·äº‹ä»¶çœ‹ä½œ Timer ç†è§£ -->
ç‚¹å‡»æŒ‰é’®æ‰“å°é¡ºåºä¸ºï¼š`Listener 1 -> Microtask 1 -> Listener 2 -> Microtask 2`ã€‚

å‡è®¾æˆ‘ä»¬ä½¿ç”¨ `dispatchEvent()` æ¥æ¨¡æ‹Ÿç‚¹å‡»äº‹ä»¶ï¼š

```js
button.click();
```

ç‚¹å‡»æŒ‰é’®æ‰“å°é¡ºåºä¸ºï¼š`Listener 1 -> Listener 2  -> Microtask 1 -> Microtask 2`ã€‚

äº‹ä»¶å†’æ³¡ä¹Ÿæ˜¯å¦‚æ­¤ï¼š

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>äº‹ä»¶å¾ªç¯</title>
    <style>
      .outer {
        background-color: #ccc;
        width: 200px;
        height: 200px;
      }
      .inner {
        background-color: blanchedalmond;
        width: 100px;
        height: 100px;
      }
    </style>
  </head>
  <body>
    <div class="outer">
      <div class="inner"></div>
    </div>
    <script>
      // è®©æˆ‘ä»¬è·å–è¿™äº›å…ƒç´ 
      const outer = document.querySelector('.outer');
      const inner = document.querySelector('.inner');

      // ä¸‹é¢æ˜¯ä¸€ä¸ªç‚¹å‡»ç›‘å¬å™¨
      function callback() {
        console.log('click'); // å½“å…ƒç´ è¢«ç‚¹å‡»æ—¶, æ‰“å° 'click'

        setTimeout(function () {
          console.log('timeout'); // 0æ¯«ç§’å, æ‰“å° 'timeout'
        }, 0);

        Promise.resolve().then(function () {
          console.log('promise'); // å½“å‰äº‹ä»¶å¾ªç¯ç»“æŸæ—¶, æ‰“å° 'promise'
        });
      }

      // æˆ‘ä»¬å°†äº‹ä»¶ç›‘å¬å™¨æ·»åŠ åˆ°ä¸¤ä¸ªå…ƒç´ ä¸Š
      inner.addEventListener('click', callback); // ä¸ºå†…éƒ¨å…ƒç´ æ·»åŠ ç‚¹å‡»ç›‘å¬å™¨
      outer.addEventListener('click', callback); // ä¸ºå¤–éƒ¨å…ƒç´ æ·»åŠ ç‚¹å‡»ç›‘å¬å™¨

      // æ‰‹åŠ¨è§¦å‘
      // inner.click(); // ç‚¹å‡»å†…éƒ¨å…ƒç´ 
    </script>
  </body>
</html>
```

<!-- timeout æ‰§è¡Œé¡ºåºæ˜¯çœ‹è¶…æ—¶æ—¶é—´çš„ -->
ç‚¹å‡»æŒ‰é’®æ‰“å°é¡ºåºä¸ºï¼šclick -> promise -> click -> promise -> timeout -> timeoutã€‚

## äº‹ä»¶å¾ªç¯é¢è¯•é¢˜

### 1. æ‰“å°é¡ºåºæ˜¯ä»€ä¹ˆï¼Ÿ

```js
console.log('begins'); // 1

setTimeout(() => {
  console.log('setTimeout 1'); // 3
  Promise.resolve().then(() => {
    console.log('promise 1'); // 4
  });
}, 0);

new Promise(function (resolve, reject) {
  console.log('promise 2'); // 2
  setTimeout(function () {
    console.log('setTimeout 2'); // 5
    resolve('resolve 1');
  }, 0);
}).then((res) => {
  console.log('dot then 1'); // 6
  setTimeout(() => {
    console.log(res); // 7
  }, 0);
});
```

<details><summary><code>ç»“æœï¼š</code></summary>

`begins -> promise 2 -> setTimeout 1 -> promise 1 -> setTimeout 2 -> dot then 1 -> resolve 1`

</details>

### 2. æ‰“å°é¡ºåºæ˜¯ä»€ä¹ˆï¼Ÿ

```js
async function async1() {
  console.log('async1 start');
  await async2();
  console.log('async1 end');
}

async function async2() {
  console.log('async2');
}

console.log('script start');

setTimeout(function () {
  console.log('setTimeout');
}, 0);

async1();

new Promise(function (resolve) {
  console.log('promise1');
  resolve();
}).then(function () {
  console.log('promise2');
});

console.log('script end');
```

<details><summary><code>ç»“æœï¼š</code></summary>

`script start -> async1 start -> async2 -> promise1 -> script end -> async1 end -> promise2 -> setTimeout`

</details>

## æ‹“å±•çŸ¥è¯†ï¼šä»»åŠ¡æ—¶é•¿è¶…è¿‡ä¸€å¸§æ€ä¹ˆå¤„ç†ï¼Ÿ

å¸§æ˜¯ç”»é¢çš„æ„æ€ï¼Œæµè§ˆå™¨é¡µé¢å°±åƒè§†é¢‘ä¸€æ ·ï¼Œæ¯ä¸€ç§’ä¼šç»˜åˆ¶å¾ˆå¤šå¸§ï¼Œ**æ¯ä¸€å¸§çš„è€—æ—¶æ˜¯ä¸å®šçš„ï¼Œå¯ä»¥æ˜¯ä»»æ„çš„æ—¶é—´**ã€‚

![20240920010014](https://raw.githubusercontent.com/chuenwei0129/my-picgo-repo/master/react/20240920010014.png)

å¦‚æœç”¨æˆ·ä¸æ“ä½œé¡µé¢ï¼Œä¹Ÿæ²¡æœ‰ä»€ä¹ˆå®šæ—¶ä»»åŠ¡ï¼Œæ¯ä¸€å¸§è€—æ—¶å¤§æ¦‚ 16 msï¼Œä¹Ÿå°±æ˜¯ 60 fpsã€‚

```js
let lastTime = Date.now()
requestAnimationFrame(function cb() {
  console.log("è¿™ä¸€å¸§è€—æ—¶ï¼š", Date.now() - lastTime)
  lastTime = Date.now()
  requestAnimationFrame(cb)
})
```

å¦‚æœæœ‰è€—æ—¶çš„ä»£ç ï¼Œæ¯”å¦‚ï¼š

```js
document.addEventListener("click", function () {
  var now = Date.now()
  requestAnimationFrame(() => console.log("è¿™ä¸€å¸§æŒç»­äº†" + (Date.now() - now)))
  while (Date.now() < now + 1000)
})
```

é‚£ä¹ˆè¿™ä¸€å¸§è€—æ—¶å°±ä¼šè‡³å°‘ 1 ç§’é’Ÿï¼Œ1 fpsã€‚**ä»»åŠ¡è€—æ—¶çš„åæœæ˜¯è®©ä¸€å¸§è€—æ—¶å˜é•¿ï¼Œå¸§ç‡å˜ä½ï¼Œäº§ç”Ÿä¸¢å¸§ï¼Œä½†ä»»åŠ¡ä¸ä¼šè¢«è·³è¿‡ã€‚**

## å‚è€ƒèµ„æ–™

- [javascript æ—¢ç„¶æ˜¯å•çº¿ç¨‹è¯­è¨€ï¼Œä¸ºä»€ä¹ˆä¼šåˆ†ä¸»çº¿ç¨‹å’Œæ¶ˆæ¯çº¿ç¨‹(event loop)?](https://www.zhihu.com/question/35905242)
- [æµè§ˆå™¨åŠ¨ç”»å¸§æ¸²æŸ“ä¸æ‰§è¡Œæœºåˆ¶æ¢ç´¢](https://jelly.jd.com/article/5fda117df708c8014219e056)
- [ã€äº‹ä»¶å¾ªç¯ã€‘ã€å‰ç«¯ã€‘äº‹ä»¶åŸç†è®²è§£ï¼Œè¶…çº§ç¡¬æ ¸ï¼Œå¿ä¸ä½è½¬è½½](https://www.bilibili.com/video/BV1K4411D7Jb/?spm_id_from=333.337.search-card.all.click&vd_source=c4234488bc8659e17c631716b9036762)
- [å¯è§†åŒ–å·¥å…·ç§’æ‡‚ JS äº‹ä»¶å¾ªç¯](https://www.jsv9000.app/)
- [äº‹ä»¶å†’æ³¡æ˜¯å®ä»»åŠ¡è¿˜æ˜¯å¾®ä»»åŠ¡ï¼Œä»¥åŠå†’æ³¡çš„è§¦å‘æ—¶æœº?](https://www.zhihu.com/question/613559688)
