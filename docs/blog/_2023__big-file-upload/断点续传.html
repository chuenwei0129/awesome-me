<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>断点续传</title>
    <style>
      .progress-bar {
        width: 100%;
        background-color: #f3f3f3;
        margin-top: 10px;
      }
      .progress {
        height: 20px;
        width: 0;
        background-color: #4caf50;
      }
      .total-progress-bar {
        width: 100%;
        background-color: #f3f3f3;
        margin-top: 10px;
      }
      .total-progress {
        height: 20px;
        width: 0;
        background-color: #021603;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>断点续传示例</h1>
    </header>
    <main>
      <section>
        <label for="fileInput">选择文件：</label>
        <input type="file" id="fileInput" />
      </section>
      <section>
        <button id="uploadButton">大文件上传</button>
        <button id="pauseButton">暂停上传</button>
        <button id="restartButton">断点续传</button>
      </section>
      <section id="totalProgressContainer">
        <h3>总进度条：</h3>
        <div class="total-progress-bar">
          <div class="total-progress" id="total-progress"></div>
        </div>
      </section>
      <section id="progressContainer"></section>
    </main>
    <!-- 请求封装 -->
    <script>
      function request({ url, method, data, headers = {}, onProgress, index }) {
        return new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest()
          if (index) xhrList[index] = xhr // 保存每个 xhr 实例到 xhrList 中
          // XMLHttpRequest 原生支持上传进度的监听
          xhr.upload.onprogress = onProgress
          xhr.open(method, url)
          Object.keys(headers).forEach((key) =>
            xhr.setRequestHeader(key, headers[key])
          )
          xhr.send(data)

          xhr.onload = () => {
            if (xhr.status >= 200 && xhr.status < 300) {
              resolve({
                data: xhr.response,
              })
              // 每当一个切片上传成功时，将对应的 xhr 从 xhrList 中删除
              xhrList.splice(index, 1)
            } else {
              reject({
                status: xhr.status,
                statusText: xhr.statusText,
              })
            }
          }

          xhr.onerror = () => {
            reject({
              status: xhr.status,
              statusText: xhr.statusText,
            })
          }
        })
      }
    </script>
    <!-- hash 函数 -->
    <script>
      async function hashFile(fileChunkList) {
        const hashBufferList = []

        for (const chunk of fileChunkList) {
          const buffer = await chunk.arrayBuffer()
          const hashBuffer = await crypto.subtle.digest('SHA-256', buffer)
          hashBufferList.push(hashBuffer)
        }

        // Combine all hash buffers into one and hash that to get the final file hash
        const combinedBuffer = new Uint8Array(
          hashBufferList.reduce((acc, val) => {
            return acc.concat(Array.from(new Uint8Array(val)))
          }, [])
        )

        const finalHashBuffer = await crypto.subtle.digest(
          'SHA-256',
          combinedBuffer
        )

        const hashArray = Array.from(new Uint8Array(finalHashBuffer))
        const hashHex = hashArray
          .map((b) => b.toString(16).padStart(2, '0'))
          .join('')

        return hashHex // This is the final hash of the whole file
      }
    </script>
    <script>
      // 应该还有许多 bug，但这只是为了理解上传。
      let xhrList = []
      let paused = false

      const SIZE = 10 * 1024 * 1024 // 10MB
      // 生成文件切片
      function createFileChunk(file, size = SIZE) {
        const fileChunkList = []
        let cur = 0
        while (cur < file.size) {
          fileChunkList.push(file.slice(cur, cur + size))
          cur += size
        }
        return fileChunkList
      }

      const fileInput = document.getElementById('fileInput')
      const uploadButton = document.getElementById('uploadButton')
      const pauseButton = document.getElementById('pauseButton')
      const restartButton = document.getElementById('restartButton')
      const totalProgressContainer = document.getElementById(
        'totalProgressContainer'
      )
      const totalProgress = document.getElementById('total-progress')

      let file = null
      let data = []
      let fileHash = null

      fileInput.addEventListener('change', (event) => {
        file = event.target.files[0]
        data = []
      })

      uploadButton.addEventListener('click', async () => {
        progressContainer.innerHTML = ''
        totalProgress.style.width = `0%`

        if (!file) return
        // 开始分片
        const fileChunkList = createFileChunk(file)
        // 计算文件的 hash 值
        fileHash = await hashFile(fileChunkList)

        console.log(`${file.name}: `, fileHash)
        // 在上传前，先计算出文件 hash，并把 hash 发送给服务端进行验证，由于 hash 的唯一性，所以一旦服务端能找到 hash 相同的文件
        // 即在服务端已经存在了上传的资源，所以当用户再次上传时会直接提示上传成功
        const { shouldUpload } = await verifyUpload(file.name, fileHash)
        if (!shouldUpload) {
          alert('文件已存在，无需重复上传')
          return
        }

        data = fileChunkList.map((chunk, index) => ({
          fileHash,
          chunk,
          index,
          percentage: 0,
          progressElement: createProgressElement(index), // 创建进度条元素
        }))

        await uploadChunks()
        await mergeRequest()
      })

      pauseButton.addEventListener('click', () => {
        if (!file) return
        paused = true // 点击暂停按钮时，将paused设置为true
        xhrList.forEach((xhr) => xhr.abort())
        // 清空 xhrList
        xhrList = []
      })

      restartButton.addEventListener('click', async () => {
        if (!file) return
        paused = false // 点击重启按钮时，将paused设置为false
        // 服务端不存在该文件或者已上传部分文件切片，通知前端进行上传，并把已上传的文件切片返回给前端
        const { shouldUpload, uploadedChunks } = await verifyUpload(
          file.name,
          fileHash
        )

        if (!shouldUpload) {
          alert('文件已存在，无需重复上传')
          return
        }

        if (uploadedChunks.length > 0) {
          data = data.filter((item) => {
            return !uploadedChunks
              .map((chunk) => chunk.split('-').pop())
              .includes(String(item.index))
          })
        }

        await uploadChunks()
        await mergeRequest()
      })

      const createProgressElement = (index) => {
        const header = document.createElement('h4')
        header.innerText = `progress-${index} 切片进度条：`
        const progressBar = document.createElement('div')
        progressBar.className = 'progress-bar'
        const progress = document.createElement('div')
        progress.className = 'progress'
        progress.id = `progress-${index}`
        progressBar.appendChild(progress)
        progressContainer.appendChild(header)
        progressContainer.appendChild(progressBar)

        return progress
      }

      const createProgressHandler = (item) => {
        return (e) => {
          // 计算该切片上传的进度。
          item.percentage = parseInt(String((e.loaded / e.total) * 100))
          item.progressElement.style.width = `${item.percentage}%`
          updateTotalProgress()
        }
      }

      const updateTotalProgress = () => {
        const loaded = data.reduce(
          (acc, item) => acc + (item.chunk.size * item.percentage) / 100,
          0
        )

        const total = file.size
        const percentage = parseInt(String((loaded / total) * 100))
        totalProgress.style.width = `${percentage}%`
      }

      const verifyUpload = async (filename, fileHash) => {
        const { data } = await request({
          url: 'http://localhost:3333/upload/verify',
          method: 'POST',
          headers: {
            'content-type': 'application/json',
          },
          data: JSON.stringify({
            filename,
            fileHash,
          }),
        })
        return JSON.parse(data)
      }

      const mergeRequest = async () => {
        if (paused) return
        await request({
          url: 'http://localhost:3333/upload/merge',
          method: 'POST',
          headers: {
            'content-type': 'application/json',
          },
          data: JSON.stringify({
            filename: file.name,
            fileHash,
            size: SIZE,
          }),
        })
      }

      async function uploadChunks() {
        const requestList = data.map(({ chunk, fileHash }, index) => {
          const formData = new FormData()
          formData.append('chunk', chunk)
          formData.append('index', index)
          formData.append('hash', fileHash)
          formData.append('filename', file.name)
          return request({
            url: 'http://localhost:3333/upload/chunk',
            method: 'POST',
            data: formData,
            onProgress: createProgressHandler(data[index]),
            index, // 保存 index，以便在xhrList中定位
          })
        })

        await Promise.all(requestList)
      }
    </script>
  </body>
</html>
