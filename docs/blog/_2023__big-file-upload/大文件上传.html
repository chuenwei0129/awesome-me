<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>大文件上传</title>
    <style>
      .progress-bar {
        width: 100%;
        background-color: #f3f3f3;
        margin-top: 10px;
      }
      .progress {
        height: 20px;
        width: 0;
        background-color: #4caf50;
      }
      .total-progress-bar {
        width: 100%;
        background-color: #f3f3f3;
        margin-top: 10px;
      }
      .total-progress {
        height: 20px;
        width: 0;
        background-color: #021603;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>大文件上传示例</h1>
    </header>
    <main>
      <section>
        <label for="fileInput">选择文件：</label>
        <input type="file" id="fileInput" />
      </section>
      <section>
        <button id="uploadButton">大文件上传</button>
      </section>
      <section id="filePreviewContainer">
        <h3>文件预览</h3>
        <div id="filePreview"></div>
      </section>
      <section id="progressContainer">
        <h3>总进度条：</h3>
        <div class="total-progress-bar">
          <div class="total-progress" id="total-progress"></div>
        </div>
      </section>
    </main>
    <script>
      // 预览文件不要影响发送请求
      const previewFiles = (input, previewContainer) => {
        previewContainer.innerHTML = ''
        // 使用 FileReader 读取文件内容并生成预览
        Array.from(input.files).forEach((file) => {
          const reader = new FileReader()
          reader.onload = function (e) {
            const fileType = file.type
            if (fileType.startsWith('image/')) {
              const img = document.createElement('img')
              img.src = e.target.result
              img.width = 100
              previewContainer.appendChild(img)
            } else if (fileType.startsWith('video/')) {
              const video = document.createElement('video')
              video.src = e.target.result
              video.width = 200
              video.controls = true
              previewContainer.appendChild(video)
            } else {
              const p = document.createElement('p')
              p.textContent = '无法预览此文件类型'
              previewContainer.appendChild(p)
            }
          }
          reader.readAsDataURL(file)
        })
      }
      function request({ url, method, data, headers = {}, onProgress }) {
        return new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest()
          // XMLHttpRequest 原生支持上传进度的监听，只需要监听 upload.onprogress 即可，我们在原来的 request 基础上传入 onProgress 参数，给 XMLHttpRequest 注册监听事件
          xhr.upload.onprogress = onProgress
          xhr.open(method, url)
          Object.keys(headers).forEach((key) =>
            xhr.setRequestHeader(key, headers[key])
          )
          xhr.send(data)

          xhr.onload = () => {
            if (xhr.status >= 200 && xhr.status < 300) {
              resolve({
                data: xhr.response,
              })
            } else {
              reject({
                status: xhr.status,
                statusText: xhr.statusText,
              })
            }
          }

          xhr.onerror = () => {
            reject({
              status: xhr.status,
              statusText: xhr.statusText,
            })
          }
        })
      }

      const SIZE = 10 * 1024 * 1024 // 10MB
      // 生成文件切片
      function createFileChunk(file, size = SIZE) {
        const fileChunkList = []
        let cur = 0
        while (cur < file.size) {
          fileChunkList.push(file.slice(cur, cur + size))
          cur += size
        }
        return fileChunkList
      }

      const fileInput = document.getElementById('fileInput')
      const uploadButton = document.getElementById('uploadButton')
      const totalProgress = document.getElementById('total-progress')

      let file = null
      let data = []

      fileInput.addEventListener('change', (event) => {
        file = event.target.files[0]
        // 文件预览
        const filePreview = document.querySelector('#filePreview')
        previewFiles(fileInput, filePreview)
      })

      uploadButton.addEventListener('click', async () => {
        if (!file) return
        const fileChunkList = createFileChunk(file)
        data = fileChunkList.map((chunk, index) => ({
          chunk,
          hash: file.name + '-' + index,
          percentage: 0,
          progressElement: createProgressElement(index), // 创建进度条元素
        }))

        await uploadChunks()
        await mergeRequest()
      })

      const createProgressElement = (index) => {
        const header = document.createElement('h4')
        header.innerText = `progress-${index} 切片进度条：`
        const progressBar = document.createElement('div')
        progressBar.className = 'progress-bar'
        const progress = document.createElement('div')
        progress.className = 'progress'
        progress.id = `progress-${index}`
        progressBar.appendChild(progress)
        progressContainer.appendChild(header)
        progressContainer.appendChild(progressBar)

        return progress
      }

      const createProgressHandler = (item) => {
        return (e) => {
          // 在每个切片上传的 onProgress 处理函数中，计算该切片上传的进度。
          item.percentage = parseInt(String((e.loaded / e.total) * 100))
          item.progressElement.style.width = `${item.percentage}%`
          // updateTotalProgress 函数应在每个切片上传的进度更新时被调用，以确保总进度条能够实时更新。
          updateTotalProgress()
        }
      }

      const updateTotalProgress = () => {
        // 将每个切片已上传的部分累加，除以整个文件的大小，就能得出当前文件的上传进度
        const loaded = data.reduce(
          (acc, item) => acc + (item.chunk.size * item.percentage) / 100,
          0
        )

        const total = file.size
        const percentage = parseInt(String((loaded / total) * 100))
        totalProgress.style.width = `${percentage}%`
      }

      // 前端主动通知服务端进行合并
      const mergeRequest = async () => {
        await request({
          url: 'http://localhost:3333/upload/merge',
          method: 'POST',
          headers: {
            'content-type': 'application/json',
          },
          data: JSON.stringify({
            filename: file.name,
            totalChunks: data.length,
            size: SIZE,
          }),
        })
      }

      // 上传切片
      async function uploadChunks() {
        const requestList = data.map(({ chunk, hash }, index) => {
          const formData = new FormData()
          formData.append('chunk', chunk)
          formData.append('hash', hash)
          formData.append('filename', file.name)
          return request({
            url: 'http://localhost:3333/upload/chunk',
            method: 'POST',
            data: formData,
            onProgress: createProgressHandler(data[index]),
          })
        })

        // 并发请求
        await Promise.all(requestList)
      }
    </script>
  </body>
</html>
