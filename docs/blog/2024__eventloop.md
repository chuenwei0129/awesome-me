---
group:
  title: 2024 ğŸ²
  order: -2024
title: äº‹ä»¶å¾ªç¯
toc: content
---

## å•çº¿ç¨‹æ¨¡å‹

ææ¸…æ¥šNode.jsåˆ°åº•æ˜¯å•çº¿ç¨‹è¿˜æ˜¯å¤šçº¿ç¨‹ï¼Œè¿™äº‹å„¿å ªæ¯”åœ¨å¹´å¤œé¥­æ¡Œä¸Šè§£é‡Šä½ é‚£ä»½å·¥ä½œã€‚ç®€çŸ­å›ç­”ï¼šNode.jsæ˜¯å•çº¿ç¨‹çš„ã€‚

å¯¹ç»†èŠ‚æœ‰ç‚¹å…´è¶£ï¼Ÿé‚£å°±æ˜¯ï¼šNode.jsåœ¨æ‹¥æœ‰worker_threadsæ¨¡å—ï¼ˆå°±åƒæµè§ˆå™¨é‡Œçš„[Web Workers API](https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API/Using_web_workers)ï¼‰ä¹‹å‰ï¼Œå¯¹äºç”¨æˆ·æ¥è¯´ï¼Œå®ƒæ˜¯å•çº¿ç¨‹ã€‚

æ·±æŒ–ä¸€ä¸‹çš„è¯ï¼šæ‰€è°“çš„â€œå•çº¿ç¨‹â€åªæ˜¯å¯¹ç”¨æˆ·è€Œè¨€ï¼Œåº•å±‚ç©¶ç«Ÿæœ‰å¤šå°‘çº¿ç¨‹åœ¨è·‘ï¼Œå¯¹ä½ æ¥è¯´æ²¡å•¥å½±å“ï¼Œå› ä¸ºä½ æ ¹æœ¬ç¢°ä¸åˆ°å®ƒä»¬ã€‚

### JavaScript çš„â€œå•çº¿ç¨‹â€

JavaScriptæ˜¯ä¸€é—¨å®Œå®Œå…¨å…¨çš„å•çº¿ç¨‹è¯­è¨€ï¼Œåƒä¸€ä¸ªå­¤ç‹¬å¥‹æ–—çš„å°é¤é¦†è€æ¿ã€‚ä½ çš„ä»£ç åœ¨ä»»ä½•æ—¶å€™éƒ½åªèƒ½åœ¨è¿™ä¸ªå”¯ä¸€çš„ä¸»çº¿ç¨‹ä¸Šè¿è¡Œã€‚

æ‰€ä»¥ï¼Œä¸è¦å¦„æƒ³ç€è¿™ä¸ªè€æ¿åœ¨å¿™ç€ç¿»ç‚’ç‰›è‚‰çš„æ—¶å€™è¿˜èƒ½è®°è´¦ã€‚æ‰€æœ‰ä»£ç éƒ½æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆJavaScriptçš„å¹¶å‘æ¨¡å‹æ˜¯åŸºäºäº‹ä»¶å’Œå›è°ƒï¼Œè€Œä¸æ˜¯ä¼ ç»Ÿçš„å¤šçº¿ç¨‹å¹¶å‘æ¨¡å‹ã€‚

### åº•å±‚çš„å¤šçº¿ç¨‹

å°½ç®¡ä½ çš„JavaScriptä»£ç åœ¨ä¸€ä¸ªâ€œå•çº¿ç¨‹â€ä¸­è·‘ï¼Œä½†ä¸æ„å‘³ç€å¼•æ“æœ¬èº«åªæœ‰ä¸€ä¸ªçº¿ç¨‹ã€‚

äº‹å®ä¸Šï¼Œç°ä»£çš„æµè§ˆå™¨å’ŒNode.jsè¿è¡Œæ—¶éƒ½å·§å¦™åœ°ä½¿ç”¨äº†å¤šçº¿ç¨‹æ¥å¤„ç†I/Oæ“ä½œã€åƒåœ¾å›æ”¶å’Œå¼‚æ­¥ä»»åŠ¡ç­‰ç­‰ã€‚è¿™å°±å¥½æ¯”é‚£ä¸ªå°é¤é¦†è€æ¿ï¼Œè™½ç„¶ä»–ä¸€ä¸ªäººç»è¥æ‰€æœ‰çš„èœå“ï¼Œä½†å¹•åè¿˜æœ‰ä¸€ä¸ªå¼ºå¤§çš„å†·å†»åº“å’Œé€è´§é˜Ÿä¼åœ¨é»˜é»˜å·¥ä½œï¼Œå¯¹ä½ æ¥è¯´ï¼Œä»–ä»¬æ˜¯å®Œå…¨é€æ˜çš„ã€‚

### ä¸¾ä¸ªæ —å­

æƒ³èµ·è°ƒç”¨AJAXçš„è¿‡ç¨‹å§ï¼Œä½ éœ€è¦æŠŠæˆåŠŸå›è°ƒä¼ é€’ç»™xhrï¼Œå¦‚ä¸‹ï¼š

```js
const xhr = new XMLHttpRequest();
xhr.onreadystatechange = function() {
  /* ä¼ å…¥æˆ‘ä»¬çš„å›è°ƒ */
};
xhr.open(...);
xhr.send(...);
```

å½“ä½ åœ¨æµè§ˆå™¨ä¸­å‘èµ·ä¸€ä¸ªç½‘ç»œè¯·æ±‚ï¼ŒJavaScriptä»£ç ä¼šæ³¨å†Œä¸€ä¸ªå›è°ƒå‡½æ•°ç„¶åç«‹é©¬è¿”å›ï¼Œä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹ã€‚ç½‘ç»œè¯·æ±‚çš„å®é™…å·¥ä½œæ˜¯ç”±æµè§ˆå™¨çš„åº•å±‚ç”¨ä¸åŒçš„çº¿ç¨‹å¤„ç†çš„ã€‚ä¸€æ—¦è¯·æ±‚æˆåŠŸï¼Œå›è°ƒå‡½æ•°ä¼šè¢«æ”¾å…¥äº‹ä»¶é˜Ÿåˆ—ï¼Œæœ€ç»ˆç”±äº‹ä»¶å¾ªç¯å–å‡ºå¹¶åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œã€‚

å°½ç®¡æµè§ˆå™¨æœ‰å•ç‹¬çš„çº¿ç¨‹å»å¤„ç†ç½‘ç»œè¯·æ±‚ï¼Œå›è°ƒå‡½æ•°è¢«æ‰§è¡Œæ—¶è¿˜æ˜¯ä¼šåœ¨JavaScriptçš„ä¸»çº¿ç¨‹ä¸Šã€‚æ‰€ä»¥ï¼Œå½’æ ¹ç»“åº•ï¼ŒJavaScriptç¡®å®æ˜¯åœ¨å•çº¿ç¨‹é‡Œå¹²æ´»ã€‚

## ä¸ºä»€ä¹ˆ JavaScript è¦è®¾è®¡æˆå•çº¿ç¨‹ï¼Ÿä¸ºä»€ä¹ˆ Web Worker ä¸å…è®¸æ“ä½œ UIï¼Ÿ

Web Workerså…è®¸æˆ‘ä»¬å¼€å¯å·¥ä½œçº¿ç¨‹æ¥å¤„ç†è€—æ—¶ä»»åŠ¡ï¼Œä½†æœ‰ä¸ªç‰¹ä¾‹ï¼šåœ¨workerå†…éƒ¨ï¼Œå¯ä¸èƒ½ç›´æ¥æ“ä½œDOMèŠ‚ç‚¹ã€‚

Workerså’Œä¸»çº¿ç¨‹ä¹‹é—´çš„æ•°æ®äº¤æµæ˜¯é€šè¿‡æ¶ˆæ¯æœºåˆ¶è¿›è¡Œçš„â€”â€”åŒæ–¹éƒ½ç”¨`postMessage()`æ–¹æ³•å‘é€æ¶ˆæ¯ï¼Œå¹¶ç”¨`onmessage`äº‹ä»¶å¤„ç†å‡½æ•°å“åº”æ¶ˆæ¯ã€‚**è¿™ä¸ªè¿‡ç¨‹ä¸­æ•°æ®æ˜¯è¢«å¤åˆ¶çš„è€Œä¸æ˜¯å…±äº«**ã€‚

è¿›ç¨‹çš„åœ°å€ç©ºé—´æ˜¯éš”ç¦»çš„ï¼Œä½†åŒä¸€ä¸ªè¿›ç¨‹å†…çº¿ç¨‹æ˜¯å¯ä»¥å…±äº«æ•°æ®çš„ï¼Œ**é‚£ä¸ºä»€ä¹ˆWeb Workerå’Œä¸»çº¿ç¨‹ä¸èƒ½å…±äº«å˜é‡ï¼Œè€Œè¦é€šè¿‡è¿™å¤æ‚çš„æ¶ˆæ¯é˜Ÿåˆ—ä¼ é€’æ•°æ®å‘¢ï¼Ÿæ“ä½œUIæ›´æ˜¯è¢«ä¸¥ä¸¥å®å®åœ°ç¦æ­¢**ï¼Ÿ

ç­”æ¡ˆæ­æ™“å•¦ï¼š**UIæ“ä½œåº”è¯¥æ°¸è¿œåªåœ¨ä¸»çº¿ç¨‹**ã€‚

çº¿ç¨‹é—´çš„åŒæ­¥ä¸ä»…ç¹çï¼Œè¿˜å¸¦æ¥äº†åŒæ­¥é—®é¢˜ã€‚å¦‚æœæ‰€æœ‰çº¿ç¨‹éƒ½èƒ½æ“ä½œUIï¼Œé‚£ä¹ˆåœ¨å‘ç”Ÿçº¿ç¨‹åˆ‡æ¢æ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚å‡è®¾açº¿ç¨‹ä¿®æ”¹ç•Œé¢æ•°æ®åˆ°ä¸€åŠï¼Œcpuåˆ‡åˆ°bçº¿ç¨‹ï¼Œbçº¿ç¨‹ä¹Ÿå»æ”¹åŒä¸€ä¸ªåœ°æ–¹ï¼Œé‚£ç»“æœå°±æ˜¯å¤§æ··ä¹±ã€‚UIç•Œé¢æœ¬è´¨ä¸Šæ˜¯æ“ä½œç³»ç»Ÿå¯¹æ•°æ®åœ¨æ˜¾ç¤ºå™¨ä¸Šçš„æ˜ å°„ï¼Œä¸ºäº†ç¨³å®šå’Œä¸€è‡´ï¼Œæ‰€æœ‰ä¿®æ”¹åªèƒ½åœ¨ä¸»çº¿ç¨‹è¿›è¡Œã€‚

å› æ­¤ï¼Œä¸ºäº†ä¿è¯ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œä¸€è‡´æ€§ï¼Œæˆ‘ä»¬åªèƒ½éµå¾ªè¿™ä¸ªè§„åˆ™ï¼Œä¸å‡†åœ¨Workerçº¿ç¨‹ä¸­æ”¹UIã€‚è€Œä¸”è¿™ç§é™åˆ¶ç¡®ä¿äº†JavaScriptèƒ½ä¿æŒå®ƒé‚£ç§ç®€å•ä½†å¼ºå¤§çš„å¼‚æ­¥æ“ä½œæ¨¡å‹ã€‚

# äº‹ä»¶å¾ªç¯ï¼ˆNode.jsï¼‰

## JavaScript ä»£ç æ‰§è¡Œçš„ç²’åº¦

åœ¨ Node.js ä¸–ç•Œé‡Œï¼Œæ‰€æœ‰çš„ JavaScript ä»£ç éƒ½åœ¨ä¸€æ¡ä¸»äº‹ä»¶å¾ªç¯ä¸Šè·‘åŠ¨ï¼Œè¿™å°±åƒä¸€ä½å¤šæ‰å¤šè‰ºçš„å¨å¸ˆåœ¨å¨æˆ¿é‡Œä¸€åˆ»ä¸åœåœ°å¿™ç¢Œã€‚æ‰€æœ‰ä»£ç éƒ½æ˜¯ä»¥â€œåŒæ­¥ä»£ç â€ä¸ºåŸºæœ¬å•ä½ï¼Œä¸€æ•´å—ä¸€æ•´å—åœ°æ‰§è¡Œã€‚

æ¥çœ‹ä¸ªä¾‹å­ï¼š

```js
setTimeout(() => {
  console.log('è¿‡äº†å‡ ç§’...');
}, 10);

setTimeout(() => {
  console.log('è¿‡äº†å‡ ç§’ï¼Œä¹Ÿè¿‡äº†å‡ ç§’...');
}, 15);

console.log('ç°åœ¨');
```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæ‰€è°“çš„åŒæ­¥ä»£ç ï¼Œç¬¬ä¸€æ®µæ˜¯è¿™æ ·çš„ï¼š

```js
setTimeout(callback, 10); // setTimeout å‡½æ•°å…¥æ ˆï¼Œå‡ºæ ˆ
setTimeout(callback, 15); // setTimeout å‡½æ•°å…¥æ ˆï¼Œå‡ºæ ˆ
console.log('ç°åœ¨'); // console.log å‡½æ•°å…¥æ ˆï¼Œå‡ºæ ˆ
```

è¿™æ•´ä¸ªå¤§å—å„¿ä»£ç ä¸æ‰§è¡Œå®Œï¼ŒNode.js æ˜¯ä¸ä¼šè·³å‡ºå½“å‰è°ƒç”¨æ ˆçš„ã€‚å¦‚æœè¿™æ®µä»£ç é‡Œæœ‰ä¸ªæ­»å¾ªç¯ï¼Œé‚£æƒ…å†µå¦‚ä½•å‘¢ï¼Ÿ

```js
setTimeout(callback, 10);
setTimeout(callback, 15);
console.log('ç°åœ¨');
while (true) {}
```

é‚£ä¹ˆï¼Œä½ å°±ä¼šåœ¨è¿™ "Tick" ä¸­è¢«å›°ä½ï¼Œåç»­ `setTimeout()` é‡Œçš„å›è°ƒç®€ç›´è¿å‡ºåœºçš„æœºä¼šéƒ½æ²¡æœ‰ã€‚

åç»­äº‹ä»¶å¾ªç¯ä¸­çš„ `setTimeout()` å›è°ƒä¹Ÿæ˜¯ä¸€æ ·ã€‚åœ¨ libuv çš„äº‹ä»¶å¾ªç¯ä¸­ï¼Œç­‰åˆ°å®šæ—¶å™¨éƒ½è¶…æ—¶è§¦å‘æ—¶ï¼Œä¼šä¸²è¡Œæ‰§è¡Œä¸¤ä¸ª `setTimeout()` çš„å›è°ƒã€‚å¦‚æœç¬¬ä¸€ä¸ªå®šæ—¶å™¨å›è°ƒé‡Œå†æä¸ªæ­»å¾ªç¯ï¼Œé‚£æ›´ç»äº†ï¼š

```js
() => {
  console.log('è¿‡äº†å‡ ç§’...');
  while (true) {}
}
```

å¦‚æ­¤ä¸€æ¥ï¼ŒNode.js æ°¸è¿œé™·å…¥è¿™æ®µåŒæ­¥æ‰§è¡Œï¼Œæ ¹æœ¬åˆ°ä¸äº†ç¬¬äºŒä¸ªå®šæ—¶å™¨å›è°ƒäº†ã€‚

`setTimeout(callback, 1000)` å®é™…ä¸ŠåŒæœŸæ‰€åšçš„äº‹å„¿å¾ˆç®€å•ï¼šæ–°å»ºä¸€ä¸ª `Timeout` å®ä¾‹ï¼ŒæŠŠä¼ è¿›æ¥çš„ `callback` å­˜å¥½ã€‚å›è°ƒå‡½æ•° `callback` åªæœ‰ç­‰åˆ°å¼‚æ­¥é€»è¾‘ä¸­ libuv çš„å®šæ—¶å™¨äº‹ä»¶è¢«è§¦å‘ï¼Œæ‰ä¼šå›åˆ° JavaScript é€»è¾‘ä¸­æ‰§è¡Œã€‚è€Œä¸€æ—¦æ‰§è¡Œï¼Œåˆæ˜¯å…¨èº«å¿ƒæŠ•å…¥ï¼ŒåªçŸ¥é“ç›¯ç€è¿™æ®µåŒæ­¥é€»è¾‘ï¼Œä¸€ç›´åˆ°æ‰§è¡Œå®Œæ¯•æ‰è½¬æˆ˜ä¸‹ä¸€æ®µå¼‚æ­¥äº‹ä»¶ã€‚

å¦‚æœ‰å¤šä¸ªå®šæ—¶å™¨å› æ—¶é—´åˆ°äº†ä¸€èµ·åˆ°æœŸï¼Œé‚£å¤šäºâ€œè–…ç¾Šæ¯›â€ç®—æ³•ï¼ˆåé¢ä¼šè§£é‡Šï¼‰ï¼Œæˆ‘ä»¬ä¼šä¸€ä¸€ä¸²è¡Œæ‰§è¡Œæ‰€æœ‰çš„å®šæ—¶å™¨ï¼Œä½†ç»ä¸å¯èƒ½çœŸåœ°â€œåŒæ—¶è¿›è¡Œâ€ã€‚

## äº‹ä»¶å¾ªç¯å†…éƒ¨é¡ºåºå›¾

åœ¨ Node.js ä¸­ï¼Œå„ç§å¼‚æ­¥ä»»åŠ¡å¯è°“éåœ°å¼€èŠ±ï¼Œæœ‰äº›ä»»åŠ¡äº¤ç»™ç±»ä¼¼ `epoll` ç›‘å¬ I/O äº‹ä»¶ï¼Œè¿˜æœ‰ä¸€äº›äº¤ç»™ `libuv` çš„çº¿ç¨‹æ± æ‰§è¡Œã€‚ä¸å‡ºæ„å¤–ï¼Œâ€œæ–‡ä»¶ç³»ç»Ÿâ€å’Œâ€œå®šæ—¶å™¨â€ä»»åŠ¡å¯èƒ½â€œåŒæ—¶è§¦å‘â€ã€‚ä½†å®ƒä»¬çš„æ‰§è¡Œé¡ºåºå‘¢ï¼Ÿ

ä¸€ä¸ªäº‹ä»¶å¾ªç¯çš„æ¯ä¸€æ­¥ï¼Œé™¤äº† `Poll for I/O` ä»»åŠ¡é˜¶æ®µå¤–ï¼Œè¿˜æœ‰å¥½å‡ å±‚ã€‚çœ‹ä¸‹å›¾ï¼Œ`timer` ä»»åŠ¡æ­¥å°±åœ¨ `Run due timers` å±‚ã€‚`setImmediate()`ã€`process.nextTick()`åˆ™åˆ†åˆ«åœ¨å…¶ä»–æ­¥éª¤ã€‚

![äº‹ä»¶å¾ªç¯é¡ºåºå›¾](https://raw.githubusercontent.com/chuenwei0129/my-picgo-repo/master/react/20240920155840.png)

å®šæ—¶å™¨ä»»åŠ¡åœ¨å®šæ—¶å™¨é˜¶æ®µæ‰§è¡Œï¼Œæ‰€æœ‰åŒæ—¶åˆ°æœŸçš„å®šæ—¶å™¨é¡ºåºæ‰§è¡Œã€‚è€Œè¯»å–æ–‡ä»¶äº‹ä»¶åœ¨ `Poll I/O` äº‹ä»¶é˜¶æ®µæ‰§è¡Œï¼Œå¤šä»»åŠ¡è¿˜æ˜¯é¡ºåºæ‰§è¡Œã€‚æ¯æ¬¡â€œé¡ºåºæ‰§è¡Œâ€æ—¶ï¼Œåªä¼šè·‘å®Œé‚£ä¸€æ®µâ€œåŒæ­¥ä»£ç â€ã€‚

çœ‹æ¥æ˜¯â€œåŒæ—¶å‘ç”Ÿâ€ï¼Œä½†æ‰€æœ‰ä»£ç åœ¨ Node.js çš„ä¸»äº‹ä»¶å¾ªç¯é‡Œéƒ½å¾—æ’å¥½é˜Ÿï¼Œä¸²ä¸ªä¸€ä¸ªä¸€ä¸ªæ¥ã€‚

## Timer

### æµè§ˆå™¨ä¸­çš„ `setTimeout()`

åœ¨æµè§ˆå™¨é‡Œï¼Œ`setTimeout()` è¿”å›ä¸€ä¸ªæ•´æ•°ï¼Œè¡¨æ˜å®šæ—¶å™¨ IDã€‚è€Œä¸”è¿™å®¶ä¼™å¦‚æœåµŒå¥—å±‚çº§è¶…è¿‡ 5 ä¸”è¶…æ—¶æ—¶é—´ä½äº 4 æ¯«ç§’ï¼Œè¶…æ—¶é—´ä¼šè¢«é¡¶åˆ°è‡³å°‘ 4 æ¯«ç§’ã€‚è¿™æ˜¯æƒ³é˜²æ­¢é¢‘ç¹å›è°ƒæ‹–æ…¢å¯¿å‘½ã€‚

### Node.js ä¸­çš„ `setTimeout()`

åœ¨ Node.js é‡Œï¼Œ`setTimeout()` è¿”å›çš„æ˜¯ä¸€ä¸ª `Timeout` å¯¹è±¡ï¼ˆæ²¡é”™ï¼Œå¯ä¸æ˜¯ä»€ä¹ˆå°å°æ•´æ•° IDï¼‰ã€‚Node.js ä¹Ÿæ²¡æœ‰æµè§ˆå™¨ä¸­çš„ 4 æ¯«ç§’è§„åˆ™ï¼Œæ‰€ä»¥è¶…æ—¶å¤„ç†ä¸Šè‡ªç„¶ä¸ä¸€æ ·ã€‚

### è§¦å‘é¡ºåºçš„å·®å¼‚

çœ‹ä¸ªä¾‹å­ï¼Œå±•ç¤ºåœ¨ä¸åŒç¯å¢ƒä¸­å®šæ—¶å™¨çš„è§¦å‘é¡ºåºæœ‰ä½•ä¸åŒï¼š

```js
setTimeout(() => {
  console.log(1);
}, 10);

setTimeout(() => {
  console.log(2);
}, 15);

let now = Date.now();
while (Date.now() - now < 100) {
  // é˜»å¡ 100 ms
}

setTimeout(() => {
  console.log(3);
}, 10);

now = Date.now();
while (Date.now() - now < 100) {
  // é˜»å¡ 100 ms
}
```

**åœ¨æµè§ˆå™¨ä¸­ï¼š**

Timeout çš„è§¦å‘æ—¶é—´æŒ‰å®é™…è¶…æ—¶è¿Ÿæ—©æ’åºï¼Œä¸Šä¾‹é‡Œä¸‰ä¸ª Timeout çš„è§¦å‘æ—¶é—´åˆ†åˆ«æ˜¯ 10 æ¯«ç§’ã€15 æ¯«ç§’å’Œ 110 æ¯«ç§’ã€‚æ‰€ä»¥é¡ºåºè¯¥æ˜¯`1`ã€`2`ã€`3`ã€‚ä½†å› ç¬¬äºŒæ¬¡é˜»å¡ï¼ˆ200 æ¯«ç§’ï¼‰ç»“æŸæ—¶ï¼Œæ‰€æœ‰çš„ Timeout å…¨è¿‡æœŸäº†ï¼Œæ‰€ä»¥æŒ‰é¡ºåºæ˜¯`1`ã€`2`ã€`3`ã€‚

**åœ¨ Node.js ä¸­ï¼š**

äº‹ä»¶å¾ªç¯æœºåˆ¶ä¸åŒï¼Œè§¦å‘é¡ºåºå˜æˆäº† `1`ã€`3`ã€`2`ã€‚å¤šä¸ªå®šæ—¶å™¨æ’å…¥äº‹ä»¶å¾ªç¯æ—¶ï¼Œæ‰€æœ‰çš„éƒ½è¶…æ—¶äº†ï¼Œ`1`ã€`3`æ˜¯åœ¨`10ms`é“¾è¡¨ï¼Œè€Œ`2`åœ¨`15ms`é“¾è¡¨ã€‚æŒ‰ç‰›ç¾Šç®—æ³•ï¼Œå…ˆæ‰§è¡Œ`10ms`é“¾è¡¨çš„æ‰€æœ‰å®šæ—¶å™¨ï¼šè¾“å‡º `1`ã€`3`ï¼Œå†è¾“å‡º `2`ã€‚

æ³¨é‡Šæ‰æœ€åä¸€æ®µä»£ç ï¼Œé‚£ä¹ˆè¾“å‡ºé¡ºåºå°±å’Œæµè§ˆå™¨ä¸€æ ·æ˜¯`1`ã€`2`ã€`3`ã€‚

```js
setTimeout(() => {
  console.log(1);
}, 10);

setTimeout(() => {
  console.log(2);
}, 15);

let now = Date.now();
while (Date.now() - now < 100) {
  // é˜»å¡ 100 ms
}

setTimeout(() => {
  console.log(3);
}, 10);
```

## setImmediate()

`setTimeout()` çš„å®šæ—¶å™¨è§¦å‘æœ€æ–°è¶…æ—¶äº‹ä»¶ï¼Œé‚£ `setImmediate()` å‘¢ï¼Ÿä¸€æ¬¡äº‹ä»¶å¾ªç¯çš„é€»è¾‘é¡ºåºæ˜¯ï¼šå®šæ—¶å™¨äº‹ä»¶ã€Pending æ€ I/O äº‹ä»¶ã€ç©ºè½¬äº‹ä»¶ã€å‡†å¤‡äº‹ä»¶ã€Poll I/O äº‹ä»¶ã€å¤æŸ¥äº‹ä»¶å’Œæ‰«å°¾ã€‚

æ ¹æ®å®˜æ–¹æ–‡æ¡£ï¼š

> Schedules the "immediate" execution of the callback after I/O events' callbacks.

å³ï¼šæŒ‰æ–‡æ¡£ï¼Œ`setImmediate()`å®æ–½æ—¶æœºæ˜¯åœ¨å¤æŸ¥äº‹ä»¶é˜¶æ®µï¼Œ**åœ¨å®šæ—¶å™¨äº‹ä»¶å’Œ `Poll for I/O` äº‹ä»¶ä¹‹åã€‚**

å®é™…ä¸Šå‘¢ï¼Ÿæˆ‘ä»¬æ¥ç‚¹ä»£ç ï¼š

```js
setImmediate(() => {
  console.log('setImmediate');
});

setTimeout(() => {
  console.log('setTimeout');
}, 0);
```

Node.js ä¸‹è·‘å‡ æ¬¡çœ‹çœ‹ï¼Ÿç»“æœéšæœºå¤æ‚ï¼Œä¸€ä¼šå„¿å…ˆ `setImmediate` ï¼Œä¸€ä¼šå„¿å…ˆ `setTimeout`ã€‚è¯´å¥½çš„å®šæ—¶å™¨äº‹ä»¶å…ˆè¿è¡Œå‘¢ï¼Ÿ

åœ¨ libuvï¼Œå®šæ—¶å™¨ç¡®å®å…ˆäºå¤æŸ¥æ­¥éª¤æ‰§è¡Œâ€”â€”ä¸è¿‡è¿™ä»…é™äºåŒä¸€ä¸ª Tickã€‚è¶…æ—¶ä¸å‡†çš„ `setTimeout()` æŒ‡ä¸å®šè·‘åˆ°å“ªä¸ª Tickï¼Œè€Œ `setImmediate` åˆ™åœ¨å½“å‰ Tick æœ«å°¾æ˜ç¡®æ‰§è¡Œã€‚

è§£é‡Šå¦‚ä¸‹ï¼šä»£ç æ‰§è¡Œåï¼ŒNode æ‰è¿›å…¥äº‹ä»¶å¾ªç¯ã€‚ä»ç¬¬ä¸€ä¸ª Tick æ¥çœ‹ï¼Œå…ˆçœ‹ `setTimeout()` æ˜¯å¦åˆ°æœŸã€‚è¶…æ—¶é—´ä¸º `0`ï¼Œä½†æ„é€ æ—¶è‡ªåŠ¨è®¾ä¸º `1`ï¼Œé€šå¸¸ç¬¬ä¸€ä¸ª Tick è¿˜æ²¡è¶…æœŸï¼Œç•¥è¿‡å®šæ—¶å™¨è¿›å…¥å¤æŸ¥é˜¶æ®µæ‰§è¡Œ `setImmediate()`ã€‚

æœ‰æ—¶è®¡ç®—æœºçŠ¶æ€ä¸åŒï¼Œç¬¬ä¸€ä¸ª Tick ä¸­å°±å·²ç»è¶…æ—¶ï¼Œè‡ªç„¶å…ˆæ‰§è¡Œè¿™ä¸ª Timeoutã€‚è€Œè·‘è¿™ä¸¤è¡Œä»£ç åï¼Œåœ¨äº‹ä»¶å¾ªç¯ä¸­ç¡®è®¤å…ˆæ‰§è¡Œ`Immediate`ï¼Œåçœ‹å®šæ—¶å™¨æœªè¶…æ—¶è½¬å»å¤æŸ¥æ‰§è¡Œã€‚å¦‚ä¸‹ï¼š

```js
setTimeout(() => {
  setImmediate(() => {
    console.log('setImmediate');
  });

  setTimeout(() => {
    console.log('setTimeout');
  }, 0);
}, 0);
```

æ­¤æ—¶ï¼Œå…ˆæ‰§è¡Œ `setImmediate`ï¼Œå›  Timeout é˜¶æ®µè·³è¿‡ã€‚å†çœ‹ï¼š

```js
setImmediate(() => {
  setImmediate(() => {
    console.log('setImmediate');
  });

  setTimeout(() => {
    console.log('setTimeout');
  }, 0);
});
```

é‡Œé¢ä¸¤ä¸ª `setImmediate` ä¸ `setTimeout` æ¬¡è¦åœ¨ä¸‹ä¸ª Tick æ‰§è¡Œï¼Œå› å½“å‰å·²åœ¨å¤æŸ¥é˜¶æ®µï¼Œé˜²é‡å…¥æœºåˆ¶è®©é‡Œé¢çš„ `Immediate`ä¸ä¼šå½“å‰æ‰§è¡Œï¼Œç»“æœå’Œæœ€åˆä»£ç ç›¸åŒã€é¡ºåºéšæœºã€‚

é‚£å’Œ `fs` æ–‡ä»¶ç³»ç»Ÿæ¯”åˆå¦‚ä½•å‘¢ï¼Ÿæ¯”å¦‚ï¼š

```js
setImmediate(() => {
  console.log('setImmediate');
});
require('fs').readFile('temp.js', () => {
  console.log('readFile');
});
```

æ‰§è¡Œé¡ºåºå¦‚ä½•ï¼Ÿæ­£å¸¸æƒ…å†µä¸‹å…ˆ `Poll for I/O`ï¼Œå†å¤æŸ¥ã€‚å›  `Poll for I/O` ç­‰å¾…æ–‡ä»¶ç³»ç»Ÿæ—¶é—´ä¸º 0ï¼Œæ‹¿ä¸åˆ°äº‹ä»¶ï¼Œæ‰§è¡Œåç»­å¤æŸ¥é˜¶æ®µè¾“å‡º `setImmediate`ã€‚ä¹‹åçš„ Tick æ–‡ä»¶äº‹ä»¶è§¦å‘è¾“å‡º `readFile`ã€‚

è‹¥ä»£ç ä¸ºï¼š

```js
function imm() {
  setImmediate(() => {
    console.log('setImmediate');
    imm();
  });
}
imm();

require('fs').readFile('temp.js', () => {
  console.log('readFile');
  process.exit(0);
});
```

è¾“å‡ºå‡ è¡Œ `setImmediate` åï¼Œè¯»å–æˆåŠŸåè¾“å‡º `readFile` é€€å‡ºã€‚åŸå› æ˜¯è™½ç­‰ 0 ç§’ï¼Œä½†æ‰§è¡Œæ¯ä¸ª Tick éœ€äº›å¾®æ—¶é—´ï¼Œå‡ ä¸ª Tick åäº‹ä»¶åˆ°æ—¶è¯»å‡ºï¼Œä»è€Œè¾“å‡º `readFile` çš„å›è°ƒã€‚

## queueMicrotask()

**å¾®ä»»åŠ¡æ˜¯åœ¨â€œå½“å‰ JavaScript æ‰§è¡Œä¸Šä¸‹æ–‡å †æ ˆâ€å®Œæ¯•åæ‰§è¡Œ**ï¼Œä¸äº‹ä»¶å¾ªç¯æ— å…³ã€‚åƒè¿™ç§ï¼š

```js
function sleep(milliseconds) {
  const start = new Date().getTime();
  while (new Date().getTime() - start < milliseconds) {
    // æ­¤å¾ªç¯ä¼šé˜»å¡æ‰§è¡Œï¼Œç›´åˆ°æŒ‡å®šçš„æ¯«ç§’æ•°è¿‡å»
  }
}

setTimeout(() => {
  console.log('setTimeout1');
  queueMicrotask(() => {
    console.log('queueMicrotask1');
  });
}, 10);

setTimeout(() => {
  console.log('setTimeout2');
  queueMicrotask(() => {
    console.log('queueMicrotask2');
  });
}, 15);

sleep(100);

setTimeout(() => {
  console.log('setTimeout3');
  queueMicrotask(() => {
    console.log('queueMicrotask3');
  });
}, 10);

sleep(100);

// æ‰§è¡Œé¡ºåº
// setTimeout1
// queueMicrotask1
// setTimeout3
// queueMicrotask3
// setTimeout2
// queueMicrotask2
```

## process.nextTick()

`process.nextTick()` ä¸å±äº‹ä»¶å¾ªç¯ï¼ŒTick æ¦‚å¿µä¸äº‹ä»¶å¾ªç¯ Tick ä¸åŒã€‚å®ƒåœ¨ Node.js ä¸­è¡¨ç¤º Timer é—´éš™ã€‚

æ‰§è¡Œæ—¶æœºï¼š

1. Node.js å†…éƒ¨ callback å®Œæ¯•åï¼›
2. Timeoutã€Immediate è§¦å‘é—´éš™ã€‚

```js
console.log('start');

process.nextTick(() => {
  console.log('tick1');
});

setTimeout(() => {
  setImmediate(() => {
    console.log('setImmediate');
    process.nextTick(() => {
      console.log('tick2');
    });
  });

  setTimeout(() => {
    console.log('setTimeout');
    process.nextTick(() => {
      console.log('tick3');
    });
  }, 0);
});
```

ä¸å¾®ä»»åŠ¡å…³ç³»ï¼š

ä¸Šé¢ä¸¤æƒ…å†µåï¼Œè‹¥æ—  Tick å›è°ƒï¼Œæ‰§è¡Œå¾®ä»»åŠ¡ï¼›è‹¥æœ‰ï¼Œå…ˆæ‰§è¡Œ Tick å›è°ƒï¼Œå†å¾®ä»»åŠ¡ã€‚æœŸé—´å†æ’å…¥æ–° Tick å›è°ƒï¼Œä¼˜å…ˆæ‰§è¡Œå¾ªç¯ä¸ä¼šè·³å‡ºã€‚

```js
console.log('start');

process.nextTick(() => {
  console.log('tick1');
  process.nextTick(() => {
    console.log('tick2');
  });
});

Promise.resolve().then(() => {
  console.log('promise1');
  process.nextTick(() => {
    console.log('tick3');
  });
  Promise.resolve().then(() => {
    console.log('promise2');
  });
});

//è¾“å‡ºç»“æœï¼š
// start
// tick1
// tick2
// promise1
// promise2
// tick3
```

åŸå› ï¼šNode.js äº‹ä»¶å¾ªç¯ä¸­ `process.nextTick()` å›è°ƒä¼˜å…ˆçº§é«˜äºåˆ°è¾¾å¾®ä»»åŠ¡é˜Ÿåˆ—çš„ Promiseã€‚åœ¨ä¾‹ä¸­ï¼Œæ‰€æœ‰ `nextTick` å›è°ƒï¼ˆ`tick1, tick2`ï¼‰ä¼˜å…ˆäºå¾®ä»»åŠ¡ï¼ˆ`promise1, promise2`ï¼‰æ‰§è¡Œã€‚åˆå›  `nextTick` å›è°ƒæ‰§è¡Œæ—¶æœºæ˜¯æŸ callback æ‰§è¡Œå®Œåçš„é—´éš™ï¼Œæ‰€ä»¥ `tick3` åœ¨ `promise2` ä¹‹åæ‰§è¡Œã€‚

## äº‹ä»¶å¾ªç¯ï¼ˆæµè§ˆå™¨ï¼‰

æµè§ˆå™¨å®ƒå¯åŠ¨çš„æ—¶å€™ï¼Œå®é™…ä¸Šä¼šå¼€è¾Ÿå¤šä¸ªè¿›ç¨‹ã€‚è¿™äº›è¿›ç¨‹é‡Œè¾¹ä¸»è¦æœ‰ä¸‰ä¸ªï¼Œå…¶å®ä¸æ­¢ä¸‰ä¸ªã€‚ä½†æ˜¯æˆ‘ä»¬è¦å…³å¿ƒçš„å…¶å®å°±è¿™ä¸‰ä¸ªï¼Œä¸€ä¸ªæ˜¯æµè§ˆå™¨è¿›ç¨‹ï¼Œä¸€ä¸ªæ˜¯ç½‘ç»œè¿›ç¨‹ï¼Œä¸€ä¸ªæ˜¯æ¸²æŸ“è¿›ç¨‹ã€‚æ¯ä¸ªè¿›ç¨‹æ˜¯ä¸æœ‰ä¸€å—ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ï¼Œå¯¹å§ï¼Ÿè¿™æµè§ˆå™¨è¿›ç¨‹çš„è¿™æ˜¯ç½‘ç»œè¿›ç¨‹çš„è¿™æ˜¯æ¸²æŸ“è¿›ç¨‹çš„ã€‚é‚£ä¹ˆè¿™æ ·å­æœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿæ¯”æ–¹è¯´ç½‘ç»œè¿™ä¸€å—ï¼Œè¿™ä¸€å—å´©æºƒäº†ï¼Œå®ƒä¸ä¼šå½±å“åˆ°æ¸²æŸ“ï¼Œä¸ä¼šå½±å“åˆ°æµè§ˆå™¨çš„è¿›ç¨‹ã€‚ä¸‰ä¸ªè¿›ç¨‹åˆ°åº•å¹²å˜›ç”¨çš„ã€‚é¦–å…ˆæ˜¯æµè§ˆå™¨è¿›ç¨‹ï¼Œå®ƒä¸»è¦åšä»€ä¹ˆå‘¢ï¼Ÿä»–ä¸»è¦è´Ÿè´£ç•Œé¢çš„å±•ç¤ºã€‚ä»€ä¹ˆç•Œé¢å±•ç¤ºï¼Ÿä¸æ˜¯é¡µé¢çš„å±•ç¤ºï¼Œå®ƒä¸æ˜¯è¿™ä¸ªç•Œé¢çš„å±•ç¤ºã€‚ä»–æ˜¯è´Ÿè´£æ¯”å¦‚è¯´è¿™ä¸ªæ ‡ç­¾é¡µçš„æ ·å­ï¼Œè¿˜æœ‰è¿™é‡Œåé€€å‰è¿›æŒ‰é’®ã€åˆ·æ–°æŒ‰é’®ï¼Œè¿™ä¸ªå¯¼èˆªæ ï¼Œå°±è¿™äº›éƒ¨åˆ†çš„å±•ç¤ºã€‚æ‡‚æˆ‘çš„æ„æ€å§ï¼Ÿè¿™æ˜¯è¿™ä¸ªæµè§ˆå™¨ä»Šå¤©è¦åšçš„äº‹å„¿ã€‚è¿˜åŒ…æ‹¬ç”¨æˆ·äº¤äº’ï¼Œæ¯”å¦‚ç”¨æˆ·åœ¨æµè§ˆå™¨çª—å£é‡Œé¢ç‚¹çš„å•¥ï¼Œæ»šåŠ¨çš„æ»šåŠ¨æ¡ï¼Œæ»šåŠ¨çš„ä¸€ä¸ªé¼ æ ‡æ»šè½®ï¼Œæˆ–è€…æ˜¯æŒ‰ç…§é”®ç›˜ï¼Œè¿™äº›ä¸œè¥¿éƒ½å±äºç”¨æˆ·äº¤äº’ï¼Œä¹Ÿæ˜¯æµè§ˆå™¨è¿›è¡Œä¸»è¦è´Ÿè´£çš„ã€‚ä»–ç›‘å¬åˆ°åº•åŠ¨æ²¡åŠ¨ï¼Œä½ åˆ°åº•ç‚¹æ²¡ç‚¹ï¼Œåˆ°åº•åˆ’æ²¡åˆ’è¿™äº›æ˜¯æµè§ˆå™¨è¿›ç¨‹è¦å¤„ç†çš„äº‹å„¿ï¼Œè¿˜æœ‰ä¸€äº›ä»€ä¹ˆå­è¿›ç¨‹ç®¡ç†ï¼Œå®é™…ä¸Šè¿™ä¸ªé¡ºä¾¿äº†è§£ä¸€ä¸‹å°±è¡Œäº†ï¼Œå°±æ˜¯åƒè¿™äº›è¿›ç¨‹ï¼Œç½‘ç»œè¿›ç¨‹ï¼Œç¡®è®¤è¿›ç¨‹ï¼Œéƒ½æ˜¯æµè§ˆå™¨è¿›ç¨‹å®ƒå¯åŠ¨å‡ºæ¥çš„ã€‚å°±ä¸€å¼€å§‹æœ€å¼€å§‹æ˜¯åªæœ‰ä¸€ä¸ªè¿›ç¨‹ï¼Œä»–ä»¬ä»–é©¬ä¸Šå°±ä¼šå¯åŠ¨ï¼Œå¤šä¸ªè¿›ç¨‹æ˜¯ç”±ä»–æ¥å¯åŠ¨è¿›ç¨‹å¯åŠ¨èµ·æ¥çš„ï¼Œæ‰€ä»¥åˆ°ç´«ç¦åŸç®¡ç†ï¼Œå°±å…¶ä»–è¿›ç¨‹æ˜¯ç”±ä»–æ¥å¯åŠ¨çš„ã€‚å¥½ï¼Œæ¢å¤æµè§ˆå™¨è¿›ç¨‹äº†è§£å°±è¡Œäº†ã€‚ç„¶åæ¥ä¸‹æ¥ç¬¬äºŒä¸ªè¿›ç¨‹ï¼Œç½‘ç»œè¿›ç¨‹ã€‚å› ä¸ºæˆ‘ä»¬æµè§ˆå™¨éœ€è¦è·Ÿç½‘ç»œé€šä¿¡ï¼Œå¯¹å§ï¼Ÿä½ å†™ä¸€ä¸ªU21åœ°å€æ ‡ï¼Œè¿™é‡Œå†™ä¸ªç™¾åº¦ä¸€å›ä¼ ï¼Œä¸ç­‰äºç½‘ç»œé€šä¿¡å—ï¼Ÿæ˜¯å§ï¼Ÿè¿™å›¾ç‰‡ä¸æ˜¯ç½‘ç»œé€šä¿¡åŠ è½½å‡ºæ¥å—ï¼Ÿæ‰€ä»¥è¯´è¿™äº›ç½‘ç»œèµ„æºçš„åŠ è½½åˆéœ€è¦å•ç‹¬çš„ä¸€ä¸ªç¨‹åºå¤„ç†ï¼Œå«åšç½‘ç»œè¿›ç¨‹ã€‚å½“ç„¶å®ƒé‡Œè¾¹ä¹Ÿä¼šåˆ†ä¸ºå¾ˆå¤šä¸ªçº¿ç¨‹æ¥å¤„ç†ä¸åŒçš„ç½‘ç»œä»»åŠ¡ã€‚äº†è§£å°±è¡Œäº†ï¼Œæˆ‘ä»¬è¿™èŠ‚è¯¾è¿™äº›ä¸œè¥¿ä¸ä¼šçš„è¯¦ç»†è®²ï¼Œé‡ç‚¹å…³æ³¨ä¸‹é¢è¿™ä¸ªè¿›ç¨‹ï¼Œæ¸²æŸ“è¿›ç¨‹ï¼Œè¿™æ˜¯æˆ‘ä»¬æœ¬èŠ‚è¯¾è¦é‡ç‚¹è®²è§£çš„è¿›ç¨‹å’Œç§‘å­¦ã€‚æ¸²æŸ“è¿›ç¨‹å¯åŠ¨åä»–è¦è¯´ä»€ä¹ˆå‘¢ï¼Ÿä»–ä¼šå¼€å¯ä¸€ä¸ªæ¸²æŸ“ä¸»çº¿ç¨‹ï¼Œè¿™ä¸ªå¥½ç†è§£ã€‚ä¸€ä¸ªè¿›ç¨‹å¯åŠ¨è¿‡åéƒ½éƒ½æœ‰ä¸€ä¸ªè¿›ç¨‹ã€‚é‚£ä¹ˆæ¸²æŸ“è¿›ç¨‹å¯åŠ¨è¿‡åï¼Œä»–é‚£ä¸ªéšç€å¼€å¯çš„ä¸»çº¿ç¨‹ã€‚ä¸»çº¿ç¨‹åˆç§°ä¸ºæ¸²æŸ“ä¸»çº¿ç¨‹ã€‚æˆ‘ä»¬åè¾¹è®²çš„éƒ½æ˜¯ä»–éƒ½è·Ÿä»–ç›¸å…³è€Œä¸”æµè§ˆå™¨å®ƒä¼šä¸ºæ¯ä¸€ä¸ªæ ‡ç­¾é¡µå¼€å¯ä¸€ä¸ªå…¨æ–°çš„å®£ä¼ è¿›ç¨‹ã€‚åˆšæ‰æˆ‘ä»¬çœ‹åˆ°è¿‡äº†å¯¹å§ï¼Ÿå®ƒå¯ä»¥ä¿è¯æ ‡ç­¾é¡µä¹‹é—´ä¸ç›¸äº’å½±å“æˆ‘ä»¬æ¥ç€å¾€åçœ‹è¯´è¿™ä¸ªæ¸²æŸ“ä¸»çº¿ç¨‹æ˜¯å¦‚ä½•å·¥ä½œçš„å‘¢ï¼Ÿæ¸²æŸ“ä¸»çº¿ç¨‹æ˜¯æµè§ˆå™¨é‡Œè¾¹æœ€ç¹å¿™çš„å¢ƒæœ€ç¹å¿™çš„ç°åœºï¼Œéœ€è¦ä»–å¤„ç†çš„ä»»åŠ¡ç‰¹åˆ«å¤šã€‚å±•å¼€æ¥è¯´çš„è¯ï¼Œä»–è¦è§£æï¼Œå¬æ²¡æœ‰è¦è§£æå¯¹å§ï¼Ÿå¬è€å¸ˆä¸ªå­—ç¬¦ä¸²ï¼Œä»–å«ä»–è§£æï¼Œè¿™å†™çš„æ˜¯å•¥ï¼Ÿä½ å†™äº†ä¸ªé—´æ‹¬å·ï¼Œè¿™ä¸ªç©æ„å„¿æ˜¯å•¥ï¼Ÿä»–ç†è§£ã€‚CSé‡Œé¢å†™çš„é€‰æ‹©å™¨ä¸€ä¸ªç‚¹ï¼Œåé¢å†™ä¸€ä¸ªè‹±æ–‡å•è¯çš„è¿™æ˜¯å•¥ï¼Ÿä»–å°±å…ˆæŠŠå®ƒç†è§£çš„è¿‡ç¨‹å°±æ˜¯è§£æï¼Œä¹‹åæˆ‘ä¼šè¯¦ç»†è¯´ï¼Œåé¢è¯¾ç¨‹æˆ‘ä¼šè¯¦ç»†è¯´ï¼Œè¿™é‡Œæˆ‘ä»¬ç®€å•äº†è§£ä¸‹å°±è¡Œï¼Œè¿˜æœ‰å°±æ˜¯æ ·å¼è¦ç®—å‘—ï¼Œä½ å†™äº†EMå·®åˆ«ä¹Ÿè¦æŠŠå®ƒæ¢ç®—æˆPSæŠŠå®ƒæ¢æˆåƒç´ ï¼Œä½ å†™çš„ç™¾åˆ†æ¯”ä¹Ÿè¦æŠŠå®ƒæ¢æˆåƒç´ ï¼Œè¿™éƒ½éœ€è¦è®¡ç®—çš„ã€‚åŒ…æ‹¬æ ·å¼å†²çªï¼Œæ˜¯ä¸æ˜¯è¦è¿›è¡Œå±‚å è§„åˆ™ï¼Œè¦æ·˜æ±°æ‰ä¸€äº›ä¼˜å…ˆçº§ä½çš„ï¼Œæœ€åå°±åªå‰©ä¸€ä¸ªã€‚è¿™äº›è®¡ç®—è¿‡ç¨‹ä¹Ÿæ˜¯ä¸»çº¿ç¨‹è¦åšçš„ã€‚è¿˜æœ‰å°±æ˜¯å¸ƒå±€ï¼Œæˆ‘ä»¬æ¯ä¸€ä¸ªå…ƒç´ å®ƒæœ‰å¤šå®½å¤šé«˜è¦ç®—å‡ºæ¥ï¼Œæ¯ä¸ªå…ƒç´ çš„ä½ç½®è¦ç®—å‡ºæ¥ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸€å—ç»Ÿç§°ä¸ºå‡ ä½•ä¿¡æ¯ï¼Œè¦å…¨éƒ¨ç®—å‡ºæ¥ã€‚å¥½ï¼Œç„¶åå°±å¯ä»¥åˆ°é¡µé¢ä¸Šå»äº†ã€‚è¿˜æœ‰å›¾å±‚ä¸€ä¸ªZè¿™ä¸ªæ˜¯å“ªä¸ªåœ¨å‰ï¼Œå“ªä¸€ä¸ªå“ªä¸ªåœ¨åï¼Œå¯¹å§ï¼Ÿå…ˆç”»èƒŒæ™¯ï¼Œè¿˜æ˜¯å…ˆç”»ä¸€ä¸ªå…ƒç´ é‡Œçš„å…ƒç´ ï¼Œå®ƒéƒ½è¦è®¡ç®—çš„ã€‚æˆ‘ä»¬å¹³æ—¶è§‰å¾—ç†æ‰€å½“ç„¶çš„äº‹å„¿ï¼Œå†™ä»£ç å°±å¯ä»¥æ˜¾ç¤ºå‡ºæ¥ã€‚å…¶å®ä»–åšå¾ˆå¤šå¾ˆå¤šå¤æ‚çš„æ“ä½œæ‰èƒ½æŠŠæ˜¾ç¤ºå‡ºæ¥ã€‚è¿™äº›ç©æ„å„¿éƒ½æ˜¯æ¸²æŸ“å‡ºç°æˆçš„å·¥ä½œï¼Ÿè¿˜è¦æŠŠæ¯ç§’æŠŠé¡µé¢ç”»64ã€‚è¿™é‡Œç®€å•äº†è§£ï¼Œä¸»è¦æ˜¯ä¸ºäº†è¯´æ˜ä»–å¾ˆå¿™ï¼Œæ¯ç§’æŠŠè¿™é¡µé¢ç”»åˆ°64ã€‚è¿˜è¦æ‰§è¡Œè®¡ç®—ï¼Œè¿˜è¦å¤„ç†äº‹ä»¶å‡½æ•°æ˜¯å§ï¼Ÿç›‘å¬äº†äº‹ä»¶è¿‡åï¼ŒæŒ‰ç…§ç‚¹äº†æŒ‰é’®ä¹‹åï¼Œä»–è¦è¿è¡Œçš„å‡½æ•°ä¹Ÿæ˜¯ä»–å¤„ç†ã€‚å³ä½¿æ˜¯åˆ°æ—¶é—´äº†ï¼Œä»–è¿˜è¦æŒ‡å‘çš„å›è°ƒå‡½æ•°å…¨æ˜¯ä»–çš„å¤„ç†ã€‚åƒæˆ‘ä»¬çš„æµè§ˆå™¨çº¿ä¸Šæ²¡æœ‰ç”¨æˆ·äº¤äº’äº‹ä»¶å—ï¼Ÿç»™ç”¨æˆ·ç‚¹å‡»äº†ä¸€ä¸‹ï¼Œæ˜¯ç”±å…¶ä»–çº¿ç¨‹åœ¨ç›‘å¬ï¼Œè¿˜è®°å¾—å—ï¼Ÿçœ‹ä¸€ä¸‹çœ‹åˆ°æ²¡ï¼Ÿæµè§ˆå™¨è¿›ç¨‹é‡Œè¾¹å®ƒå¯ä»¥ç›‘å¬ç”¨æˆ·åˆ°åº•ç‚¹æ²¡ç‚¹ã€‚ç”¨æˆ·ç‚¹é‚£ä¸ªæŒ‰é’®ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œä»–ä¼šæŠŠæŒ‰é’®çš„äº‹ä»¶å¤„ç†å‡½æ•°ä½œä¸ºä¸€ä¸ªä»»åŠ¡æ‹¿å»æ’é˜Ÿã€‚å› ä¸ºæµè§ˆå™¨ä¸»çº¿ç¨‹å®ƒæ˜¯æµè§ˆå™¨çº¿ç¨‹ï¼Œå®ƒæ˜¯ä¸æ‰§è¡ŒGSä»£ç çš„ï¼Œä½†å®ƒå¯ä»¥åšä¸€ä»¶äº‹å„¿ï¼ŒæŠŠè¿™ä¸ªä»»åŠ¡æ‹¿å»æ’é˜Ÿç­‰å¾…æ¸²æŸ“ä¸»çº¿ç¨‹åºæ‰§è¡Œã€‚é‚£å¯¹æ–¹é‚£ä¸ªè®¡æ—¶å™¨åˆ°æ—¶é—´äº†ï¼Œä¸€ä¸ªäººæ‹¿ä¸ªå¡ä¸ªè¡¨æ­£åœ¨è®¡æ—¶ï¼Œè®¡æ—¶ä¸ª1åˆ†é’Ÿ30ç§’ã€‚é‚£è®¡æ—¶å™¨åˆ°æ—¶é—´äº†ï¼Œä»–åˆæŠŠé‚£ä¸ªå›è°ƒå‡½æ•°æ‹¿å»æ’é˜Ÿç­‰å¾…æ‰§è¡Œï¼Œæ˜ç™½è¿™æ„æ€å—ï¼Ÿæ‰€ä»¥è¯´æ˜¯ä¸æ˜¯å¯ä»¥å›ç­”ä¸€ä¸ªé—®é¢˜äº†å½“ç”¨å½“æ­£åœ¨æ‰§è¡Œçš„ä»‹ç»å‡½æ•°è¯´æ˜æ­£åœ¨æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ã€‚æ‰§è¡Œåˆ°ä¸€èˆ¬çš„æ—¶å€™ï¼Œç”¨æˆ·ç‚¹è¿™ä¸ªæŒ‰é’®ï¼Œæˆ‘åº”è¯¥ç«‹å³å»æ‰§è¡Œç‚¹å‡»äº‹ä»¶çš„å¤„ç†å‡½æ•°å—ï¼Ÿä¸ä¼šï¼Œä»–å¾—æŠŠæ‰‹ä¸Šçš„äº‹æƒ…å¹²å®Œäº†ä¹‹åï¼Œä»è¿™ä¸ªæ’é˜Ÿé‡Œé¢å»æ‹¿ã€‚æ¯”æ–¹è¯´è¿™ä¸ªåœ°æ–¹ç”¨æˆ·ç‚¹äº†æŒ‰é’®ï¼Œæ­£åœ¨æ‰§è¡Œï¼Œç”¨æˆ·ç‚¹äº†ä¸ªæŒ‰é’®ï¼Œå…¶ä»–çº¿è·¯èƒ½ç›‘å¬åˆ°äº†ã€‚äºæ˜¯ä»–æŠŠè¿™ä¸ªä»»åŠ¡åŠ åˆ°è¿™é‡Œé¢å»ç­‰å¾…è¢«æ‰§è¡Œæ’é˜Ÿçš„ã€‚è€Œå‰é¢çš„å¯èƒ½å·²ç»æœ‰äº†ä¸¤ä¸ªä»»åŠ¡äº†ï¼Œå·²ç»æ’ç€äº†ã€‚é‚£ä½ ç»§ç»­æ’å¥½ã€‚å½“æˆ‘ç»„å»ºæˆæŠŠè¿™ä¸ªä»»åŠ¡æå®šä¹‹åï¼ŒæŠŠè¿™ä¸ªäººæå®šä¹‹åï¼Œé‚£ä¹ˆä¸»çº¿ç¨‹æ¸…ç©ºäº†ï¼Œæ²¡ä¸œè¥¿å¯ä»¥æ‰§è¡Œäº†ã€‚äºæ˜¯ä»æ¶ˆæ¯å¯¹æ¥é‡Œè¾¹æ‹¿ç¬¬ä¸€ä¸ªè®¤å‡ºæ¥ï¼Œä¸‹ä¸€ä½å¾€å‰é¢èµ°æ˜¯å§ï¼Ÿæ¥æ‰§è¡Œï¼Œæ‰§è¡Œå®Œäº†è¿‡åï¼Œé‚£è¿™ä¸ªä¹ŸOKäº†ï¼Œç„¶ååˆæ‹¿ä¸‹ä¸€ä¸ªï¼Œç„¶ååˆæ‹¿ä¸‹ä¸€ä¸ªï¼Œå¯¹å§ï¼Ÿä¾æ¬¡æ‹¿å»æ‰§è¡Œï¼Œå°±è¿™ä¸ªæ„æ€ã€‚å¥½ï¼Œå’±ä»¬æ¥å…·ä½“çœ‹ä¸€ä¸‹ã€‚åœ¨æœ€ä¸€å¼€å§‹çš„æ—¶å€™ï¼Œæ¸²æŸ“ä¸»çº¿ç¨‹å®ƒä¼šè¿›å…¥ä¸€ä¸ªæ— é™å¾ªç¯ã€‚ä»€ä¹ˆå«æ— é™å¾ªç¯ï¼Ÿè¿™å°±æ˜¯æ— é™å¾ªç¯çš„æ— ç©·æ— å°½çš„å¾ªç¯ä¸‹å»ã€‚é‚£çœŸçš„æ˜¯å¦‚æ­¤å—ï¼Ÿå’±ä»¬æ¥çœ‹ä¸€ä¸‹ï¼Œçœ‹å•¥å‘¢ï¼Ÿäº‹ä»¶å¾ªç¯å®ƒåˆå«åšæ¶ˆæ¯å¾ªç¯ï¼Œåªæ˜¯ä¸åŒçš„åç§°è€Œå·²ã€‚åœ¨W3Cè¿™ä¸ªå®˜æ–¹æ–‡æ¡£é‡Œè¾¹ï¼Œå› ä¸ºæˆ‘ä»¬è¯´çš„æ ‡å‡†ï¼ŒHYCSçš„Aæ ‡å‡†éƒ½æ˜¯å±äºåŒ…æ‹¬æµè§ˆå™¨çš„æ ‡å‡†éƒ½å±äºW3Cçš„ã€‚W3Cçš„æ ‡å‡†æ–‡æ¡£é‡Œè¾¹ï¼Œå®ƒæŠŠå®ƒå«åšäº‹ä»¶å¾ªç¯ï¼Œå«ä¸€é—®loopã€‚ä½†æ˜¯åœ¨è°·æ­Œæµè§ˆå™¨é‡Œé¢ï¼Œå®ƒæŠŠå®ƒå«åšmessage loopï¼Œéƒ½ä¸€ä¸ªæ„æ€ï¼Œå…¶å®æœ‰ç‚¹ç»†å¾®çš„æ„Ÿè§‰ä¸Šæœ‰ç‚¹ä¸ä¸€æ ·ã€‚æ‰€ä»¥è¯´æˆ‘ä»¬è¯´æ¶ˆæ¯å¾ªç¯å’Œäº‹ä»¶å¾ªç¯æ˜¯ä¸€ä¸ªä¸œè¥¿ã€‚å¥½çœ‹ä¸€ä¸‹ï¼Œè¿™å°±æ˜¯æ¶ˆæ¯å¾ªç¯ã€‚ä¸ºä»€ä¹ˆæ¶ˆæ¯ä½ çŸ¥é“äº†å§ï¼Ÿå®ƒå°±æ˜¯å¾ªç¯åœ¨æ‹¿æ¶ˆæ¯ï¼Œæ¯ä¸€æ¬¡å¾ªç¯ä»é˜Ÿåˆ—é‡Œé¢å“ªä¸€ä¸ªä»»åŠ¡å»æ‰§è¡Œï¼Œæ‰§è¡Œå®Œäº†è¿‡åï¼Œä¸‹ä¸€æ¬¡å¾ªç¯æ‹¿ä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚æ‰€ä»¥çœ‹æ•™æ¡æ¯ä¸€æ¬¡å¾ªç¯ä¼šæ£€æŸ¥æ¶ˆæ¯å¯¹ä¸­æ˜¯å¦æœ‰ä»»åŠ¡å­˜åœ¨ï¼Œå¦‚æœæœ‰çš„è¯å°±å–å‡ºç¬¬ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œï¼Œæ‰§è¡Œå®Œè¿‡åè¿›å…¥ä¸‹æ¬¡å¾ªç¯ã€‚å¦‚æœè¯´æ²¡æœ‰çš„è¯ï¼Œä»–å¦‚æœè¯´æ²¡ä»»åŠ¡çš„è¯ï¼Œæ²¡æœ‰å»ä¼‘æ¯ï¼Œè¸è¸å®å®ä¼‘æ¯ã€‚ä½ æ²¡äº‹çš„æ—¶å€™ä¸ä¼‘å¹²å˜›å‘¢ï¼Ÿè¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œå¦‚æœè¯´çªç„¶ä¸€å¼€å§‹æ²¡æœ‰ä»»åŠ¡ï¼Œåæ¥åˆçªç„¶å‡ºç°ä¸€ä¸ªä»»åŠ¡ï¼Œé‚£ä¹ˆå°±ä¼šå”¤é†’å…¶ä»–æ‰€æœ‰å¿åŸï¼ŒåŒ…æ‹¬å…¶ä»–è¿›åŸçš„å¿åŸã€‚

### Event Loop

Event Loopï¼ˆäº‹ä»¶å¾ªç¯ï¼‰æ˜¯ç”¨æ¥åè°ƒäº‹ä»¶ã€ç”¨æˆ·äº¤äº’ã€è„šæœ¬ã€æ¸²æŸ“ã€ç½‘ç»œçš„ä¸€ç§æµè§ˆå™¨å†…éƒ¨æœºåˆ¶ã€‚

æˆ‘ä»¬è¿™é‡Œä¸»è¦è®¨è®ºçš„æ˜¯ window event loopã€‚ä¹Ÿå°±æ˜¯æµè§ˆå™¨ä¸€ä¸ªæ¸²æŸ“è¿›ç¨‹å†…ä¸»çº¿ç¨‹æ‰€æ§åˆ¶çš„ Event Loopã€‚

Event Loop å¤„ç†è¿‡ç¨‹ï¼š

1. åœ¨æ‰€é€‰ task queue (taskQueue) ä¸­çº¦å®šå¿…é¡»åŒ…å«ä¸€ä¸ªå¯è¿è¡Œä»»åŠ¡ã€‚å¦‚æœæ²¡æœ‰æ­¤ç±» task queueï¼Œåˆ™è·³è½¬è‡³ä¸‹é¢ microtasks æ­¥éª¤ã€‚
2. è®© taskQueue ä¸­æœ€è€çš„ task (oldestTask) å˜æˆç¬¬ä¸€ä¸ªå¯æ‰§è¡Œä»»åŠ¡ï¼Œç„¶åä» taskQueue ä¸­åˆ æ‰å®ƒã€‚
3. å°†ä¸Šé¢ oldestTask è®¾ç½®ä¸º event loop ä¸­æ­£åœ¨è¿è¡Œçš„ taskã€‚
4. æ‰§è¡Œ oldestTaskã€‚
5. å°† event loop ä¸­æ­£åœ¨è¿è¡Œçš„ task è®¾ç½®ä¸º nullã€‚
6. æ‰§è¡Œ microtasks æ£€æŸ¥ç‚¹ï¼ˆä¹Ÿå°±æ˜¯æ‰§è¡Œ microtasks é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼‰ã€‚
7. è®¾ç½® hasARenderingOpportunity ä¸º falseã€‚
8. æ›´æ–°æ¸²æŸ“ã€‚
9. å¦‚æœå½“å‰æ˜¯ window event loop ä¸” task queues é‡Œæ²¡æœ‰ task ä¸” microtask queue æ˜¯ç©ºçš„ï¼ŒåŒæ—¶æ¸²æŸ“æ—¶æœºå˜é‡ hasARenderingOpportunity ä¸º false ï¼Œå»æ‰§è¡Œ idle periodï¼ˆrequestIdleCallbackï¼‰ã€‚
10. è¿”å›åˆ°ç¬¬ä¸€æ­¥ã€‚

ä»¥ä¸Šæ˜¯æ¥è‡ªè§„èŒƒå…³äº event loop å¤„ç†è¿‡ç¨‹çš„ç²¾ç®€ç‰ˆæ•´ç†ï¼Œçœç•¥äº†éƒ¨åˆ†å†…å®¹ã€‚

æ›´æ–°æ¸²æŸ“å…·ä½“æµç¨‹ï¼š

1. éå†å½“å‰æµè§ˆä¸Šä¸‹æ–‡ä¸­æ‰€æœ‰çš„ document ï¼Œå¿…é¡»æŒ‰åœ¨åˆ—è¡¨ä¸­æ‰¾åˆ°çš„é¡ºåºå¤„ç†æ¯ä¸ª document ã€‚
2. æ¸²æŸ“æ—¶æœºï¼ˆRendering opportunitiesï¼‰ï¼šå¦‚æœå½“å‰æµè§ˆä¸Šä¸‹æ–‡ä¸­æ²¡æœ‰åˆ°æ¸²æŸ“æ—¶æœºåˆ™å°†æ‰€æœ‰ docs åˆ é™¤ï¼Œå–æ¶ˆæ¸²æŸ“ï¼ˆæ­¤å¤„æ˜¯å¦å­˜åœ¨æ¸²æŸ“æ—¶æœºç”±æµè§ˆå™¨è‡ªè¡Œåˆ¤æ–­ï¼Œæ ¹æ®ç¡¬ä»¶åˆ·æ–°ç‡é™åˆ¶ã€é¡µé¢æ€§èƒ½æˆ–é¡µé¢æ˜¯å¦åœ¨åå°ç­‰å› ç´ ï¼‰ã€‚
3. å¦‚æœå½“å‰æ–‡æ¡£ä¸ä¸ºç©ºï¼Œè®¾ç½® hasARenderingOpportunity ä¸º true ã€‚
4. ä¸å¿…è¦çš„æ¸²æŸ“ï¼ˆUnnecessary renderingï¼‰ï¼šå¦‚æœæµè§ˆå™¨è®¤ä¸ºæ›´æ–°æ–‡æ¡£çš„æµè§ˆä¸Šä¸‹æ–‡çš„å‘ˆç°ä¸ä¼šäº§ç”Ÿå¯è§æ•ˆæœä¸”æ–‡æ¡£çš„ animation frame callbacksï¼ˆrequestAnimationFrameï¼‰æ˜¯ç©ºçš„ï¼Œåˆ™å–æ¶ˆæ¸²æŸ“ã€‚
5. ä» docs ä¸­åˆ é™¤æµè§ˆå™¨è®¤ä¸ºå‡ºäºå…¶ä»–åŸå› æœ€å¥½è·³è¿‡æ›´æ–°æ¸²æŸ“çš„æ–‡æ¡£ã€‚
6. å¦‚æœæ–‡æ¡£çš„æµè§ˆä¸Šä¸‹æ–‡æ˜¯é¡¶çº§æµè§ˆä¸Šä¸‹æ–‡ï¼Œåˆ™åˆ·æ–°è¯¥æ–‡æ¡£çš„è‡ªåŠ¨å¯¹ç„¦å€™é€‰å¯¹è±¡ã€‚
7. å¤„ç† resize äº‹ä»¶ï¼Œä¼ å…¥ä¸€ä¸ª `performance.now()` æ—¶é—´æˆ³ã€‚
8. å¤„ç† scroll äº‹ä»¶ï¼Œä¼ å…¥ä¸€ä¸ª `performance.now()` æ—¶é—´æˆ³ã€‚
9. å¤„ç†åª’ä½“æŸ¥è¯¢ï¼Œä¼ å…¥ä¸€ä¸ª `performance.now()` æ—¶é—´æˆ³ã€‚
10. è¿è¡Œ CSS åŠ¨ç”»ï¼Œä¼ å…¥ä¸€ä¸ª `performance.now()` æ—¶é—´æˆ³ã€‚
11. å¤„ç†å…¨å±äº‹ä»¶ï¼Œä¼ å…¥ä¸€ä¸ª `performance.now()` æ—¶é—´æˆ³ã€‚
12. æ‰§è¡Œ requestAnimationFrame å›è°ƒï¼Œä¼ å…¥ä¸€ä¸ª `performance.now()` æ—¶é—´æˆ³ã€‚
13. æ‰§è¡Œ intersectionObserver å›è°ƒï¼Œä¼ å…¥ä¸€ä¸ª `performance.now()` æ—¶é—´æˆ³ã€‚
14. å¯¹æ¯ä¸ª document è¿›è¡Œç»˜åˆ¶ã€‚
15. æ›´æ–° ui å¹¶å‘ˆç°ã€‚

æ ¹æ®æ›´æ–°æ¸²æŸ“æµç¨‹å¯çŸ¥ï¼Œå¦‚ä¸‹æ¡ˆåˆ—é¡µé¢éšè—æ—¶å¹¶ä¸ä¼šé—ªçƒï¼Œ**å› ä¸º JS è„šæœ¬ä½œä¸ºä¸€ä¸ªæ•´ä½“ï¼Œå¿…é¡»ç­‰åˆ°æ‰§è¡Œå®Œæ¯•åï¼Œæµè§ˆå™¨æ‰ä¼šå¼€å§‹æ¸²æŸ“**ã€‚

```js
document.body.appendChild(el)
el.style.display = 'none'
```

ä¸‹é¢ä»£ç ä¸­å®é™…ä¸Šåªæœ‰æœ€åä¸€è¡Œä»£ç æ˜¯æœ‰æ„ä¹‰çš„ã€‚

```js
button.addEventListener('click', () => {
  box.style.display = 'none'
  box.style.display = 'block'
  box.style.display = 'none'
  box.style.display = 'block'
  box.style.display = 'none'
  box.style.display = 'block'
  box.style.display = 'none'
  box.style.display = 'block'
})
```

### Event Loop ä¸ requestAnimationFrame

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      * {
        margin: 0;
      }
      .box1 {
        width: 100px;
        height: 100px;
        background-color: #ccc;
      }
      .box2 {
        width: 100px;
        height: 100px;
        background-color: #9c5f5f;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div class="box1"></div>
    <div class="box2"></div>
    <button type="button">click me</button>

    <script>
      const box1 = document.querySelector('.box1');
      const box2 = document.querySelector('.box2');
      const button = document.querySelector('button');

      button.addEventListener('click', () => {
        let j = 0;
        let requestId;
        function animation1() {
          box1.style.marginLeft = `${j}px`;
          requestId = requestAnimationFrame(animation1);
          j++;
          if (j > 200) {
            cancelAnimationFrame(requestId);
          }
        }
        animation1();

        let i = 0;
        let timerId;
        function animation() {
          box2.style.marginLeft = `${i}px`;
          timerId = setTimeout(animation, 0);
          i++;
          if (i > 200) {
            clearTimeout(timerId);
          }
        }
        animation();
      });
    </script>
  </body>
</html>
```

<!-- æµè§ˆå™¨æ¸²æŸ“å‰ raf å¿…æ‰§è¡Œï¼Œå…³äº timer ä¸ raf çš„é¡ºåºï¼Œå®é™…æ˜¯ timer ä¸æ¸²æŸ“çš„é¡ºåº -->
ç‚¹å‡»æŒ‰é’®å¯ä»¥çœ‹åˆ°ï¼š`setTimeout` åŠ¨ç”»æ¯” `requestAnimationFrame` åŠ¨ç”»æ›´å¿«ã€‚

æ ¹æ®ä¸Šæ–‡å¯çŸ¥ï¼š`requestAnimationFrame` çš„å›è°ƒæ—¶æœº â€”â€”â€”â€” å®ƒä¼šåœ¨ `style/layout/paint` ä¹‹å‰è°ƒç”¨ã€‚

![20240920214724](https://raw.githubusercontent.com/chuenwei0129/my-picgo-repo/master/react/20240920214724.png)

é¦–å…ˆï¼Œæµè§ˆå™¨æ¸²æŸ“æœ‰ä¸ªæ¸²æŸ“æ—¶æœºçš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯æµè§ˆå™¨ä¼šæ ¹æ®å½“å‰çš„æµè§ˆä¸Šä¸‹æ–‡åˆ¤æ–­æ˜¯å¦è¿›è¡Œæ¸²æŸ“ï¼Œå®ƒä¼šå°½é‡é«˜æ•ˆï¼Œåªæœ‰å¿…è¦çš„æ—¶å€™æ‰è¿›è¡Œæ¸²æŸ“ï¼Œå¦‚æœæ²¡æœ‰ç•Œé¢çš„æ”¹å˜ï¼Œå°±ä¸ä¼šæ¸²æŸ“ã€‚æŒ‰ç…§è§„èŒƒé‡Œè¯´çš„ä¸€æ ·ï¼Œå› ä¸ºè€ƒè™‘åˆ°ç¡¬ä»¶çš„åˆ·æ–°é¢‘ç‡é™åˆ¶ã€é¡µé¢æ€§èƒ½ä»¥åŠé¡µé¢æ˜¯å¦å­˜åœ¨åå°ç­‰ç­‰å› ç´ ï¼Œæœ‰å¯èƒ½æ‰§è¡Œå®Œ setTimeout è¿™ä¸ª task ä¹‹åï¼Œå‘ç°è¿˜æ²¡åˆ°æ¸²æŸ“æ—¶æœºï¼Œæ‰€ä»¥ setTimeout å›è°ƒäº†å‡ æ¬¡ä¹‹åæ‰è¿›è¡Œæ¸²æŸ“ï¼Œæ­¤æ—¶è®¾ç½®çš„ marginLeft å’Œä¸Šä¸€æ¬¡æ¸²æŸ“å‰ marginLeft çš„å·®å€¼è¦å¤§äº 1px çš„ï¼Œå› ä¸ºå±å¹•çš„åˆ·æ–°é¢‘ç‡æ˜¯ 60 Hzï¼Œæ‰€ä»¥å¤§è‡´åœ¨ 16.6ms ä¹‹å†…æ‰§è¡Œäº†å¤šæ¬¡ setTimeout task ä¹‹åæ‰åˆ°äº†æ¸²æŸ“æ—¶æœºå¹¶æ‰§è¡Œæ¸²æŸ“ã€‚

requestAnimationFrame å¸§åŠ¨ç”»ä¸åŒä¹‹å¤„åœ¨äºï¼Œæ¯æ¬¡æ¸²æŸ“ä¹‹å‰éƒ½ä¼šè°ƒç”¨ï¼Œæ­¤æ—¶è®¾ç½®çš„ marginLeft å’Œä¸Šä¸€æ¬¡æ¸²æŸ“å‰ marginLeft çš„å·®å€¼ä¸º 1px ã€‚

æ‰€ä»¥çœ‹ä¸Šå» setTimeout â€œå¿«â€äº†å¾ˆå¤šã€‚

### Event Loop ä¸ EventTarget.dispatchEvent()

ä¸æµè§ˆå™¨åŸç”Ÿäº‹ä»¶ä¸åŒï¼Œ**åŸç”Ÿäº‹ä»¶**æ˜¯ç”± DOM æ´¾å‘çš„ï¼Œå¹¶é€šè¿‡ `event loop` **å¼‚æ­¥è°ƒç”¨**äº‹ä»¶å¤„ç†ç¨‹åºï¼Œè€Œ`dispatchEvent()`åˆ™æ˜¯**åŒæ­¥è°ƒç”¨**äº‹ä»¶å¤„ç†ç¨‹åºã€‚åœ¨è°ƒç”¨ `dispatchEvent()` åï¼Œæ‰€æœ‰ç›‘å¬è¯¥äº‹ä»¶çš„äº‹ä»¶å¤„ç†ç¨‹åºå°†åœ¨ä»£ç ç»§ç»­å‰æ‰§è¡Œå¹¶è¿”å›ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸ªç¤ºä¾‹ï¼š

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <button>Click me!</button>
    <script>
      const button = document.querySelector('button');

      button.addEventListener('click', () => {
        Promise.resolve().then(() => {
          console.log('Microtask 1');
        });
        console.log('Listener 1');
      });

      button.addEventListener('click', () => {
        Promise.resolve().then(() => {
          console.log('Microtask 2');
        });
        console.log('Listener 2');
      });
    </script>
  </body>
</html>
```

<!-- å¯ä»¥æŠŠç”¨æˆ·äº‹ä»¶çœ‹ä½œ Timer ç†è§£ -->
ç‚¹å‡»æŒ‰é’®æ‰“å°é¡ºåºä¸ºï¼š`Listener 1 -> Microtask 1 -> Listener 2 -> Microtask 2`ã€‚

å‡è®¾æˆ‘ä»¬ä½¿ç”¨ `dispatchEvent()` æ¥æ¨¡æ‹Ÿç‚¹å‡»äº‹ä»¶ï¼š

```js
button.click();
```

ç‚¹å‡»æŒ‰é’®æ‰“å°é¡ºåºä¸ºï¼š`Listener 1 -> Listener 2  -> Microtask 1 -> Microtask 2`ã€‚

äº‹ä»¶å†’æ³¡ä¹Ÿæ˜¯å¦‚æ­¤ï¼š

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>äº‹ä»¶å¾ªç¯</title>
    <style>
      .outer {
        background-color: #ccc;
        width: 200px;
        height: 200px;
      }
      .inner {
        background-color: blanchedalmond;
        width: 100px;
        height: 100px;
      }
    </style>
  </head>
  <body>
    <div class="outer">
      <div class="inner"></div>
    </div>
    <script>
      // è®©æˆ‘ä»¬è·å–è¿™äº›å…ƒç´ 
      const outer = document.querySelector('.outer');
      const inner = document.querySelector('.inner');

      // ä¸‹é¢æ˜¯ä¸€ä¸ªç‚¹å‡»ç›‘å¬å™¨
      function callback() {
        console.log('click'); // å½“å…ƒç´ è¢«ç‚¹å‡»æ—¶, æ‰“å° 'click'

        setTimeout(function () {
          console.log('timeout'); // 0æ¯«ç§’å, æ‰“å° 'timeout'
        }, 0);

        Promise.resolve().then(function () {
          console.log('promise'); // å½“å‰äº‹ä»¶å¾ªç¯ç»“æŸæ—¶, æ‰“å° 'promise'
        });
      }

      // æˆ‘ä»¬å°†äº‹ä»¶ç›‘å¬å™¨æ·»åŠ åˆ°ä¸¤ä¸ªå…ƒç´ ä¸Š
      inner.addEventListener('click', callback); // ä¸ºå†…éƒ¨å…ƒç´ æ·»åŠ ç‚¹å‡»ç›‘å¬å™¨
      outer.addEventListener('click', callback); // ä¸ºå¤–éƒ¨å…ƒç´ æ·»åŠ ç‚¹å‡»ç›‘å¬å™¨

      // æ‰‹åŠ¨è§¦å‘
      // inner.click(); // ç‚¹å‡»å†…éƒ¨å…ƒç´ 
    </script>
  </body>
</html>
```

<!-- timeout æ‰§è¡Œé¡ºåºæ˜¯çœ‹è¶…æ—¶æ—¶é—´çš„ -->
ç‚¹å‡»æŒ‰é’®æ‰“å°é¡ºåºä¸ºï¼šclick -> promise -> click -> promise -> timeout -> timeoutã€‚

## äº‹ä»¶å¾ªç¯é¢è¯•é¢˜

### 1. æ‰“å°é¡ºåºæ˜¯ä»€ä¹ˆï¼Ÿ

```js
console.log('begins'); // 1

setTimeout(() => {
  console.log('setTimeout 1'); // 3
  Promise.resolve().then(() => {
    console.log('promise 1'); // 4
  });
}, 0);

new Promise(function (resolve, reject) {
  console.log('promise 2'); // 2
  setTimeout(function () {
    console.log('setTimeout 2'); // 5
    resolve('resolve 1');
  }, 0);
}).then((res) => {
  console.log('dot then 1'); // 6
  setTimeout(() => {
    console.log(res); // 7
  }, 0);
});
```

<details><summary><code>ç»“æœï¼š</code></summary>

`begins -> promise 2 -> setTimeout 1 -> promise 1 -> setTimeout 2 -> dot then 1 -> resolve 1`

</details>

### 2. æ‰“å°é¡ºåºæ˜¯ä»€ä¹ˆï¼Ÿ

```js
async function async1() {
  console.log('async1 start');
  await async2();
  console.log('async1 end');
}

async function async2() {
  console.log('async2');
}

console.log('script start');

setTimeout(function () {
  console.log('setTimeout');
}, 0);

async1();

new Promise(function (resolve) {
  console.log('promise1');
  resolve();
}).then(function () {
  console.log('promise2');
});

console.log('script end');
```

<details><summary><code>ç»“æœï¼š</code></summary>

`script start -> async1 start -> async2 -> promise1 -> script end -> async1 end -> promise2 -> setTimeout`

</details>

## æ‹“å±•çŸ¥è¯†ï¼šä»»åŠ¡æ—¶é•¿è¶…è¿‡ä¸€å¸§æ€ä¹ˆå¤„ç†ï¼Ÿ

å¸§æ˜¯ç”»é¢çš„æ„æ€ï¼Œæµè§ˆå™¨é¡µé¢å°±åƒè§†é¢‘ä¸€æ ·ï¼Œæ¯ä¸€ç§’ä¼šç»˜åˆ¶å¾ˆå¤šå¸§ï¼Œ**æ¯ä¸€å¸§çš„è€—æ—¶æ˜¯ä¸å®šçš„ï¼Œå¯ä»¥æ˜¯ä»»æ„çš„æ—¶é—´**ã€‚

![20240920010014](https://raw.githubusercontent.com/chuenwei0129/my-picgo-repo/master/react/20240920010014.png)

å¦‚æœç”¨æˆ·ä¸æ“ä½œé¡µé¢ï¼Œä¹Ÿæ²¡æœ‰ä»€ä¹ˆå®šæ—¶ä»»åŠ¡ï¼Œæ¯ä¸€å¸§è€—æ—¶å¤§æ¦‚ 16 msï¼Œä¹Ÿå°±æ˜¯ 60 fpsã€‚

```js
let lastTime = Date.now()
requestAnimationFrame(function cb() {
  console.log("è¿™ä¸€å¸§è€—æ—¶ï¼š", Date.now() - lastTime)
  lastTime = Date.now()
  requestAnimationFrame(cb)
})
```

å¦‚æœæœ‰è€—æ—¶çš„ä»£ç ï¼Œæ¯”å¦‚ï¼š

```js
document.addEventListener("click", function () {
  var now = Date.now()
  requestAnimationFrame(() => console.log("è¿™ä¸€å¸§æŒç»­äº†" + (Date.now() - now)))
  while (Date.now() < now + 1000)
})
```

é‚£ä¹ˆè¿™ä¸€å¸§è€—æ—¶å°±ä¼šè‡³å°‘ 1 ç§’é’Ÿï¼Œ1 fpsã€‚**ä»»åŠ¡è€—æ—¶çš„åæœæ˜¯è®©ä¸€å¸§è€—æ—¶å˜é•¿ï¼Œå¸§ç‡å˜ä½ï¼Œäº§ç”Ÿä¸¢å¸§ï¼Œä½†ä»»åŠ¡ä¸ä¼šè¢«è·³è¿‡ã€‚**

## æ¨èé˜…è¯»

- [javascript æ—¢ç„¶æ˜¯å•çº¿ç¨‹è¯­è¨€ï¼Œä¸ºä»€ä¹ˆä¼šåˆ†ä¸»çº¿ç¨‹å’Œæ¶ˆæ¯çº¿ç¨‹(event loop)?](https://www.zhihu.com/question/35905242)
- [æµè§ˆå™¨åŠ¨ç”»å¸§æ¸²æŸ“ä¸æ‰§è¡Œæœºåˆ¶æ¢ç´¢](https://jelly.jd.com/article/5fda117df708c8014219e056)
- [ã€äº‹ä»¶å¾ªç¯ã€‘ã€å‰ç«¯ã€‘äº‹ä»¶åŸç†è®²è§£ï¼Œè¶…çº§ç¡¬æ ¸ï¼Œå¿ä¸ä½è½¬è½½](https://www.bilibili.com/video/BV1K4411D7Jb/?spm_id_from=333.337.search-card.all.click&vd_source=c4234488bc8659e17c631716b9036762)
- [å¯è§†åŒ–å·¥å…·ç§’æ‡‚ JS äº‹ä»¶å¾ªç¯](https://www.jsv9000.app/)
- [äº‹ä»¶å†’æ³¡æ˜¯å®ä»»åŠ¡è¿˜æ˜¯å¾®ä»»åŠ¡ï¼Œä»¥åŠå†’æ³¡çš„è§¦å‘æ—¶æœº?](https://www.zhihu.com/question/613559688)
